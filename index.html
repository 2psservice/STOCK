<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2PS SERVICE | ระบบบริหารงานบุคคลและบันทึกเวลา</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning (for development/demo purposes)
        tailwind.config = {
            corePlugins: {
                preflight: true,
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Face-API.js for Face Recognition -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
        }

        .tab-active {
            border-bottom: 3px solid #2563eb;
            color: #1e40af;
            font-weight: 700;
            background-color: white;
        }

        .tab-inactive {
            color: #64748b;
            background-color: #f1f5f9;
        }

        .tab-inactive:hover {
            background-color: #e2e8f0;
        }

        .admin-subtab-active {
            background-color: #2563eb;
            color: white;
        }

        .admin-subtab-inactive {
            background-color: white;
            color: #64748b;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Pulsing animation for location marker */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
                transform: scale(1.1);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
                transform: scale(1);
            }
        }

        .pulse-marker {
            animation: pulse 2s infinite;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Login Screen Animation */
        .login-fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-lg font-bold text-slate-700">กำลังเตรียมข้อมูลระบบ...</h2>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-100 z-[90] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md animate-slide-in">
            <div class="text-center mb-8">
                <!-- Updated Icons: Clock, Car, Ship -->
                <div class="flex justify-center items-center gap-4 mb-6">
                    <div
                        class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 text-2xl transition transform hover:scale-110">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div
                        class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-200 text-2xl transition transform hover:scale-110 -translate-y-2">
                        <i class="fas fa-car"></i>
                    </div>
                    <div
                        class="w-16 h-16 bg-sky-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-sky-200 text-2xl transition transform hover:scale-110">
                        <i class="fas fa-ship"></i>
                    </div>
                </div>
                <!-- Updated: Increased font size -->
                <h1 class="text-4xl font-black text-slate-800 mb-2">เข้าสู่ระบบ</h1>
                <p class="text-slate-500 text-xl font-bold">บริษัท ทูพีเอส เซอร์วิส จำกัด</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่อผู้ใช้งาน</label>
                    <input type="text" id="loginUsername"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Username" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">รหัสผ่าน</label>
                    <input type="password" id="loginPassword"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Password" required>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="rememberMe" class="rounded text-blue-600 focus:ring-blue-500">
                    <label for="rememberMe" class="text-sm font-bold text-slate-500">จำฉันไว้ในระบบ</label>
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition transform active:scale-95">
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content (Hidden by default) -->
    <div id="mainApp" class="hidden flex-col h-full overflow-auto">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shrink-0">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-blue-200 shadow-lg">
                        <i class="fas fa-users-cog text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-black text-xl tracking-tight text-slate-900">2PS <span
                                class="text-blue-600">Attendance</span></h1>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest"
                            id="currentDateDisplay">Loading...</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- User Switcher (Only visible to Admin) -->
                    <div id="adminUserSwitcher"
                        class="hidden md:flex items-center bg-slate-100 rounded-full px-4 py-1.5 border border-slate-200">
                        <i class="fas fa-user-circle text-slate-400 mr-2"></i>
                        <select id="userSwitcher" onchange="switchCurrentUser(this.value)"
                            class="bg-transparent border-none focus:ring-0 text-sm font-bold text-slate-700 cursor-pointer outline-none">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <span id="loggedInUserDisplay" class="text-xs font-bold text-slate-500 hidden md:block"></span>

                        <!-- NEW: Edit Profile Button (Visible only for employees) -->
                        <button id="btn-edit-profile" onclick="openEditProfileModal()"
                            class="hidden md:flex items-center justify-center w-10 h-10 rounded-full bg-slate-50 text-slate-500 hover:bg-blue-50 hover:text-blue-600 transition"
                            title="แก้ไขข้อมูลส่วนตัว">
                            <i class="fas fa-user-pen"></i>
                        </button>

                        <button onclick="handleLogout()"
                            class="text-red-400 hover:text-red-600 transition-colors bg-red-50 p-2 rounded-lg"
                            title="ออกจากระบบ">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-6 w-full flex-1">

            <!-- Role Switching Tabs (Restricted visibility) -->
            <div id="roleTabs" class="flex p-1 bg-slate-200 rounded-2xl mb-8 w-full max-w-2xl mx-auto shadow-inner">
                <button onclick="switchRole('employee')" id="btn-role-employee"
                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 tab-active">
                    <i class="fas fa-user"></i> พนักงาน
                </button>
                <button onclick="switchRole('admin')" id="btn-role-admin"
                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 tab-inactive">
                    <i class="fas fa-shield-alt"></i> Admin Yard
                </button>
                <button onclick="switchRole('manager')" id="btn-role-manager"
                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 tab-inactive relative">
                    <i class="fas fa-chart-line"></i> Manager
                    <span id="manager-badge"
                        class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white animate-bounce">0</span>
                </button>
            </div>

            <section id="view-employee" class="space-y-6 animate-slide-in">
                <!-- NEW: Announcement Board (Employee View) -->
                <div id="emp-announcement-card"
                    class="hidden bg-orange-500 rounded-3xl p-6 text-white shadow-lg shadow-orange-200 animate-bounce-slow relative overflow-hidden">
                    <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                        <i class="fas fa-bullhorn text-9xl -rotate-12"></i>
                    </div>
                    <div class="relative z-10 flex gap-4 items-start">
                        <div
                            class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-2xl shrink-0 backdrop-blur-sm">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black text-lg uppercase tracking-wider mb-1 opacity-90">ประกาศแจ้งข่าวสาร
                            </h3>
                            <p id="emp-announcement-text" class="font-bold text-lg leading-relaxed whitespace-pre-wrap">
                                ...</p>
                        </div>
                    </div>
                </div>


                <!-- Employee Info & Time Section -->
                <div
                    class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                    <!-- Animated Background -->
                    <div
                        class="absolute top-0 left-0 w-96 h-96 bg-white/10 rounded-full mix-blend-overlay filter blur-3xl -translate-x-1/2 -translate-y-1/2">
                    </div>
                    <div
                        class="absolute bottom-0 right-0 w-96 h-96 bg-white/10 rounded-full mix-blend-overlay filter blur-3xl translate-x-1/2 translate-y-1/2">
                    </div>

                    <!-- Content -->
                    <div class="relative z-10">
                        <!-- Employee Profile Info (NEW TOP) -->
                        <div class="text-center mb-8 pb-8 border-b-2 border-white/20">
                            <div class="flex flex-col items-center gap-4">
                                <div
                                    class="w-24 h-24 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white text-4xl shadow-lg border-4 border-white/30">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="text-center space-y-3">
                                    <h2 id="emp-name-display"
                                        class="text-4xl font-black text-white leading-tight drop-shadow-lg">...
                                    </h2>
                                    <div class="flex flex-wrap gap-2 justify-center items-center">
                                        <span id="emp-pos-display"
                                            class="bg-white/20 backdrop-blur-sm text-white text-sm font-bold px-4 py-1 rounded-full uppercase tracking-wide border border-white/30 shadow-sm">...</span>
                                        <span id="emp-code-display"
                                            class="bg-white/10 backdrop-blur-sm text-white text-sm font-bold px-4 py-1 rounded-full border border-white/20">...</span>
                                        <!-- PHONE DISPLAY -->
                                        <span id="emp-phone-display"
                                            class="text-white/90 text-sm font-bold flex items-center gap-1"><i
                                                class="fas fa-phone-alt text-xs"></i> <span>-</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Large Current Time Display -->
                        <div class="text-center mb-8">
                            <p
                                class="text-white/70 text-sm font-bold uppercase tracking-widest mb-3 flex items-center justify-center gap-2">
                                <i class="far fa-clock"></i> เวลาปัจจุบัน
                            </p>
                            <h1 class="text-8xl md:text-9xl font-black text-white font-mono tracking-tight drop-shadow-2xl"
                                id="emp-current-time">00:00:00</h1>
                            <div class="flex items-center justify-center gap-3 mt-4">
                                <span
                                    class="w-3 h-3 rounded-full bg-green-400 animate-pulse shadow-lg shadow-green-400/50"></span>
                                <p id="emp-work-start-time" class="text-white/90 font-bold text-lg">เข้างานปกติ 08:30 น.
                                </p>
                            </div>
                        </div>

                        <!-- Check-in/out Buttons -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-3xl mx-auto">
                            <!-- Check-in Button -->
                            <div id="checkin-container">
                                <button onclick="checkLocationAndOpenFaceModal('in')"
                                    class="w-full bg-white hover:bg-green-50 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 group">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg group-hover:rotate-6 transition-transform">
                                            <i class="fas fa-sign-in-alt"></i>
                                        </div>
                                        <div class="text-left flex-1">
                                            <h3 class="text-2xl font-black text-slate-800">บันทึกเวลาเข้างาน</h3>
                                            <p class="text-sm text-slate-500 font-bold">Face Recognition Check-in</p>
                                        </div>
                                        <i
                                            class="fas fa-chevron-right text-slate-300 group-hover:text-green-500 text-xl group-hover:translate-x-1 transition-all"></i>
                                    </div>
                                </button>
                            </div>

                            <!-- Check-out Button -->
                            <div id="checkout-container">
                                <button onclick="checkLocationAndOpenFaceModal('out')"
                                    class="w-full bg-white hover:bg-red-50 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 group">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-16 h-16 bg-gradient-to-br from-red-400 to-rose-500 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg group-hover:rotate-6 transition-transform">
                                            <i class="fas fa-sign-out-alt"></i>
                                        </div>
                                        <div class="text-left flex-1">
                                            <h3 class="text-2xl font-black text-slate-800">บันทึกเวลาออกงาน</h3>
                                            <p id="checkout-work-duration" class="text-sm text-slate-500 font-bold">Face
                                                Recognition Check-out</p>
                                        </div>
                                        <i
                                            class="fas fa-chevron-right text-slate-300 group-hover:text-red-500 text-xl group-hover:translate-x-1 transition-all"></i>
                                    </div>
                                </button>
                            </div>

                            <!-- Already Checked Container -->
                            <div id="already-checked-container" class="hidden md:col-span-2">
                                <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-6 border-2 border-white/30">
                                    <div class="flex items-center justify-center gap-3 text-white">
                                        <i class="fas fa-check-circle text-3xl"></i>
                                        <div class="text-center">
                                            <h3 class="text-xl font-black">เช็คชื่อเรียบร้อย</h3>
                                            <p class="text-sm text-white/80 font-bold">
                                                คุณได้เช็คชื่อเข้างานและออกงานแล้ววันนี้</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Location Map Display -->
                            <div id="emp-location-display" class="md:col-span-2 mt-4">
                                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/20">
                                    <div class="mb-3 flex items-center justify-between text-white">
                                        <div class="flex items-center gap-2">
                                            <i id="emp-location-icon" class="fas fa-map-marker-alt text-xl"></i>
                                            <p class="text-sm font-bold uppercase tracking-wider">สถานะตำแหน่ง</p>
                                        </div>
                                        <div class="text-right">
                                            <h3 id="emp-location-status" class="text-lg font-black">กำลังตรวจสอบ...</h3>
                                            <p id="emp-yard-name" class="text-xs text-white/80 font-bold">-</p>
                                        </div>
                                    </div>
                                    <!-- Map Container -->
                                    <div id="emp-location-map"
                                        class="w-full h-64 rounded-xl overflow-hidden border-2 border-white/20 bg-slate-200">
                                        <div class="flex items-center justify-center h-full text-slate-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mr-2"></i>
                                            <span class="font-bold">กำลังโหลดแผนที่...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <!-- HTML UPDATED: Employee Score Card -->
                    <div id="emp-score-card"
                        class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden group transition-all duration-700">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-white/80 font-bold text-sm uppercase tracking-wider mb-1">
                                    คะแนนความประพฤติ (ปีนี้)</h3>
                                <div class="flex items-baseline gap-2">
                                    <span id="emp-score" class="text-5xl font-black tracking-tighter">0</span>
                                    <span id="emp-base-display" class="text-lg text-white/60">/ 30</span>
                                </div>
                            </div>
                            <p class="text-[10px] font-bold text-white/90 bg-white/20 inline-block px-2 py-1 rounded"
                                id="emp-status-text">ปกติ</p>
                        </div>
                        <div class="mt-2 bg-black/20 h-2 rounded-full overflow-hidden backdrop-blur-sm mb-4">
                            <div id="emp-score-bar" class="bg-white h-full rounded-full transition-all duration-1000"
                                style="width: 100%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t border-white/20 pt-4 mt-2">
                            <!-- Added onclick event and cursor-pointer -->
                            <div onclick="openScoreDetail('leave')"
                                class="text-center group-hover:bg-white/5 rounded-xl transition p-2 cursor-pointer hover:bg-white/10 active:scale-95">
                                <p class="text-white text-xs font-bold uppercase mb-1 opacity-90"><i
                                        class="fas fa-file-alt mr-1"></i>จำนวนวันที่ลา</p>
                                <p id="stat-leave-count-card" class="text-3xl font-black text-white drop-shadow-md">0
                                </p>
                                <p class="text-[8px] text-white/50">(คลิกดู)</p>
                            </div>
                            <!-- Added onclick event and cursor-pointer -->
                            <div onclick="openScoreDetail('penalty')"
                                class="text-center border-l border-white/20 group-hover:bg-white/5 rounded-xl transition p-2 cursor-pointer hover:bg-white/10 active:scale-95">
                                <p class="text-white text-xs font-bold uppercase mb-1 opacity-90"><i
                                        class="fas fa-exclamation-triangle mr-1"></i>สาย/ขาด/โทษ</p>
                                <p id="stat-penalty-count-card" class="text-3xl font-black text-red-300 drop-shadow-md">
                                    0</p>
                                <p class="text-[8px] text-white/50">(คลิกดู)</p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden group transition-all duration-700">
                        <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4">
                            <i class="fas fa-clock text-9xl rotate-12"></i>
                        </div>
                        <h3 class="text-white/80 font-bold text-sm uppercase tracking-wider mb-4">OT สะสมเดือนนี้</h3>
                        <div class="flex items-baseline gap-2 mb-4">
                            <span id="emp-ot-sum" class="text-5xl font-black tracking-tighter">0</span>
                            <span class="text-lg text-white/60">ชม.</span>
                        </div>
                        <p class="text-[10px] font-bold text-white/90 bg-white/20 inline-block px-2 py-1 rounded">
                            ขยันขันแข็ง!</p>
                    </div>
                    <div class="grid grid-rows-2 gap-6">
                        <!-- Calendar Button -->
                        <div onclick="openCalendarModal()"
                            class="bg-white rounded-3xl p-4 border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer hover:shadow-lg hover:border-purple-200 transition group">
                            <div
                                class="w-14 h-14 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-700">ปฏิทิน</h3>
                                <p class="text-[10px] text-slate-400">วันทำงาน/OT/ลา</p>
                            </div>
                        </div>

                        <!-- NEW: Rules & Grades Button (Visible only if enabled by Admin) -->
                        <div id="btn-show-rules" onclick="openRulesInfoModal()"
                            class="hidden bg-white rounded-3xl p-4 border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer hover:shadow-lg hover:border-orange-200 transition group">
                            <div
                                class="w-14 h-14 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-700">เกณฑ์คะแนน</h3>
                                <p class="text-[10px] text-slate-400">กฎระเบียบ & เกรด</p>
                            </div>
                        </div>

                        <!-- Request Leave Button -->
                        <div onclick="openModal('leaveModal')"
                            class="bg-white rounded-3xl p-4 border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer hover:shadow-lg hover:border-blue-200 transition group">
                            <div
                                class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                <i class="fas fa-paper-plane"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-700">ส่งใบลา</h3>
                                <p class="text-[10px] text-slate-400">ลากิจ/ป่วย/อื่นๆ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Message (When already checked) -->
                <div id="already-checked"
                    class="hidden bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 text-center">
                    <i class="fas fa-check-circle text-4xl text-blue-600 mb-3"></i>
                    <h3 class="font-black text-blue-700 mb-2">บันทึกเวลาวันนี้แล้ว</h3>
                    <p id="check-time-display" class="text-sm text-blue-600 font-bold">-</p>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden mt-6">
                    <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-100 font-black text-slate-800">
                        ประวัติการทำงานและ OT</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-400 font-bold uppercase text-[10px]">
                                <tr>
                                    <th class="px-6 py-3">วันที่</th>
                                    <th class="px-6 py-3">เวลาเข้างาน</th>
                                    <th class="px-6 py-3">เวลาออกจาก</th>
                                    <th class="px-6 py-3">รายการ</th>
                                    <th class="px-6 py-3">เหตุผล</th>
                                    <th class="px-6 py-3 text-center">OT (ชม.)</th>
                                    <th class="px-6 py-3 text-center">หักคะแนน</th>
                                    <th class="px-6 py-3 text-center">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="emp-history-list" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
                <div id="attendance-actions" class="hidden"></div>
            </section>

            <!-- ================= SITE ADMIN VIEW ================= -->
            <section id="view-admin" class="hidden space-y-6 animate-slide-in">
                <div class="flex space-x-2 mb-4 bg-slate-100 p-1 rounded-xl w-fit">
                    <button onclick="switchAdminSubTab('yard')" id="btn-adm-tab-yard"
                        class="px-6 py-2 rounded-lg text-sm font-bold admin-subtab-active shadow-sm transition">จัดการราย
                        Yard</button>
                    <button onclick="switchAdminSubTab('all')" id="btn-adm-tab-all"
                        class="px-6 py-2 rounded-lg text-sm font-bold admin-subtab-inactive hover:bg-white/50 transition">พนักงานทั้งหมด</button>
                </div>

                <!-- View 1: Yard Management -->
                <div id="adm-view-yard-container">
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex flex-col md:flex-row gap-6 justify-between items-end">
                            <div class="flex flex-wrap gap-4 items-center">
                                <div class="space-y-1">
                                    <label class="block text-[10px] font-black text-slate-400 uppercase">เลือกไซต์งาน
                                        (Yard)</label>
                                    <div class="flex gap-2 items-center">
                                        <select id="adminSiteSelector" onchange="renderAdminView()"
                                            class="bg-slate-100 border-none rounded-xl px-4 py-2 font-bold text-slate-800"></select>
                                        <button onclick="openManageYardsModal()"
                                            class="bg-slate-100 text-slate-600 w-10 h-10 rounded-xl hover:bg-slate-200 transition"
                                            title="จัดการสถานที่ทำงาน"><i class="fas fa-cog"></i></button>
                                    </div>
                                    <p id="admin-yard-time-display" class="text-[10px] text-blue-600 font-bold ml-1">
                                    </p>
                                </div>
                                <div class="space-y-1">
                                    <label class="block text-[10px] font-black text-slate-400 uppercase">เลือกวันที่
                                        (ตรวจสอบย้อนหลัง)</label>
                                    <input type="date" id="admDateSelector" onchange="renderAdminView()"
                                        class="bg-slate-100 border-none rounded-xl px-4 py-2 font-bold text-slate-800">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button id="btn-add-emp" onclick="openModal('addEmpModal')"
                                    class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-800 transition">เพิ่มพนักงาน</button>
                                <button id="btn-import-excel" onclick="openModal('importExcelModal')"
                                    class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">Upload
                                    รายชื่อเข้าระบบ</button>
                                <!-- Updated: Open Export Modal instead of direct function -->
                                <button id="btn-export-yard" onclick="openExportModal('yard')"
                                    class="bg-green-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-green-600 transition flex items-center gap-1 shadow-lg shadow-green-200">
                                    <i class="fas fa-file-export"></i> Export รายงาน
                                </button>
                                <button id="btn-manage-holidays" onclick="openManageHolidaysModal()"
                                    class="bg-purple-100 text-purple-600 px-4 py-2.5 rounded-xl hover:bg-purple-200 transition shadow-sm font-bold text-sm flex items-center gap-1"><i
                                        class="fas fa-calendar-check"></i> วันหยุด</button>
                                <button id="btn-manage-geofence" onclick="openGeofenceModal()"
                                    class="bg-teal-100 text-teal-600 px-4 py-2.5 rounded-xl hover:bg-teal-200 transition shadow-sm font-bold text-sm flex items-center gap-1"><i
                                        class="fas fa-map-marker-alt"></i> พื้นที่งาน</button>
                                <button id="btn-settings"
                                    onclick="openModal('manageRulesModal'); renderRuleSettings(); renderGradeSettings();"
                                    class="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-xl hover:bg-slate-300 transition shadow-sm font-bold text-sm flex items-center gap-1">
                                    <i class="fas fa-sliders-h"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
                        <div class="lg:col-span-3 space-y-6">
                            <div class="grid grid-cols-3 gap-4">
                                <div onclick="openAdminYardDetail('all')"
                                    class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center cursor-pointer hover:shadow-md transition group">
                                    <span
                                        class="text-[10px] font-black text-slate-400 uppercase mb-1 group-hover:text-blue-500">พนักงานทั้งหมด</span>
                                    <span id="adm-stats-total"
                                        class="text-3xl font-black text-slate-800 group-hover:text-blue-600">0</span>
                                </div>
                                <div onclick="openAdminYardDetail('absent')"
                                    class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center cursor-pointer hover:shadow-md transition group">
                                    <span
                                        class="text-[10px] font-black text-slate-400 uppercase mb-1 group-hover:text-red-500">ลา/ขาด</span>
                                    <span id="adm-stats-absent"
                                        class="text-3xl font-black text-red-500 group-hover:scale-110 transition-transform">0</span>
                                </div>
                                <div onclick="openAdminYardDetail('present')"
                                    class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center cursor-pointer hover:shadow-md transition group">
                                    <span
                                        class="text-[10px] font-black text-slate-400 uppercase mb-1 group-hover:text-green-500">มาทำงาน</span>
                                    <span id="adm-stats-present"
                                        class="text-3xl font-black text-green-500 group-hover:scale-110 transition-transform">0</span>
                                </div>
                            </div>

                            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                                <div
                                    class="p-6 bg-slate-50/50 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                                    <span id="adm-list-title"
                                        class="font-black text-slate-700 text-lg">รายชื่อพนักงาน</span>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="handleBulkAttendance(11)"
                                            class="bg-green-100 text-green-700 text-xs font-bold px-3 py-2 rounded-xl transition hover:bg-green-200 shadow-sm"><i
                                                class="fas fa-check-double mr-1"></i> มาทั้งหมด</button>
                                        <button onclick="handleBulkAttendance(6)"
                                            class="bg-yellow-100 text-yellow-700 text-xs font-bold px-3 py-2 rounded-xl transition hover:bg-yellow-200 shadow-sm"><i
                                                class="fas fa-clock mr-1"></i> สายทั้งหมด</button>
                                        <button onclick="handleBulkAttendance(8)"
                                            class="bg-red-100 text-red-700 text-xs font-bold px-3 py-2 rounded-xl transition hover:bg-red-200 shadow-sm"><i
                                                class="fas fa-times-circle mr-1"></i> </button>
                                        <button onclick="openBulkTransferModal('yardSelect')"
                                            class="bg-orange-100 text-orange-700 text-xs font-bold px-3 py-2 rounded-xl transition hover:bg-orange-200 shadow-sm"><i
                                                class="fas fa-exchange-alt mr-1"></i> ย้ายกลุ่ม</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-slate-50 text-slate-400 font-bold uppercase text-[10px]">
                                            <tr>
                                                <th class="p-4 w-10"><input type="checkbox" id="selectAllYardCheck"
                                                        onchange="toggleSelectAllYard(this)"></th>
                                                <th class="p-4">พนักงาน / เช็คชื่อ</th>
                                                <th class="p-4 text-center">สถานะ</th>
                                                <th class="p-4 text-center">เวลาเช็ค</th>
                                                <th class="p-4 text-center w-24 bg-blue-50 text-blue-600">OT วันนี้
                                                    (ชม.)</th>
                                                <th class="p-4 text-center">รวม OT เดือนนี้</th>
                                                <th class="p-4 text-center">ปฏิทิน</th>
                                                <th class="p-4 text-right">การจัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adm-employee-list" class="divide-y divide-slate-50"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div id="penalty-box-container"
                                class="bg-red-600 rounded-3xl p-6 text-white shadow-lg shadow-red-200">
                                <h4 class="text-[10px] font-bold uppercase opacity-80 mb-2">ลงโทษด่วน</h4>
                                <form onsubmit="handlePenaltySubmit(event)" class="space-y-3">
                                    <select id="penaltyEmpSelect"
                                        class="w-full bg-white border-none rounded-xl text-xs py-2 text-slate-800 font-bold outline-none focus:ring-2 focus:ring-red-300"
                                        required></select>
                                    <select id="penaltyType"
                                        class="w-full bg-white border-none rounded-xl text-xs py-2 text-slate-800 font-bold outline-none focus:ring-2 focus:ring-red-300"
                                        required></select>
                                    <button type="submit"
                                        class="w-full bg-red-800 text-white font-black py-2 rounded-xl text-xs hover:bg-red-900 transition shadow-md">บันทึกโทษ</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View 2: All Employees (New) with Credentials -->
                <div id="adm-view-all-container" class="hidden">
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                            <div class="relative w-full md:w-1/2">
                                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                                <input type="text" id="allEmpSearch" onkeyup="renderAdminAllEmployees()"
                                    placeholder="ค้นหาชื่อ, รหัสพนักงาน..."
                                    class="w-full bg-slate-100 border-none rounded-xl pl-10 pr-4 py-3 font-bold text-slate-800 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex gap-2">
                                <!-- Updated: Open Export Modal -->
                                <button id="btn-export-all" onclick="openExportModal('all')"
                                    class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition flex items-center gap-2">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button onclick="openBulkTransferModal('allEmpSelect')"
                                    class="bg-orange-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-orange-200 hover:bg-orange-600 transition flex items-center gap-2">
                                    <i class="fas fa-exchange-alt"></i> ย้ายกลุ่มที่เลือก
                                </button>
                                <button onclick="deleteBulkEmployees()"
                                    class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-600 transition flex items-center gap-2">
                                    <i class="fas fa-trash-alt"></i> ลบที่เลือก
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto max-h-[600px]">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-50 text-slate-400 font-bold uppercase text-[10px] sticky top-0 z-10">
                                    <tr>
                                        <th class="p-4 w-10"><input type="checkbox" onchange="toggleSelectAllAll(this)">
                                        </th>
                                        <th class="p-4">พนักงาน</th>
                                        <th class="p-4">ตำแหน่ง/สังกัด</th>
                                        <th class="p-4 text-center">ชื่อเล่น</th> <!-- New Column -->
                                        <th class="p-4 text-center">Username</th>
                                        <th class="p-4 text-center">Password</th>
                                        <th class="p-4 text-center">ปฏิทิน</th>
                                        <th class="p-4 text-center">คะแนน</th>
                                        <th class="p-4 text-right">ดูข้อมูล</th>
                                    </tr>
                                </thead>
                                <tbody id="adm-all-employee-list" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ================= MANAGER VIEW ================= -->
            <section id="view-manager" class="hidden space-y-8 animate-slide-in">
                <!-- Same Manager View Content -->
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-black text-slate-800">Dashboard ผู้จัดการ</h2>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-slate-500">วันที่:</span>
                            <input type="date" id="mgrDateSelector" onchange="renderManagerView()"
                                class="bg-slate-100 border-none rounded-xl px-4 py-2 font-bold text-slate-800 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-6">
                    <h3 class="font-black text-lg text-slate-800 mb-4 flex items-center gap-2"><i
                            class="fas fa-bullhorn text-orange-500"></i> ประกาศข่าวสาร (ถึงทุกคน)</h3>
                    <div class="flex flex-col gap-3">
                        <textarea id="mgr-announcement-input" rows="3"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                            placeholder="พิมพ์ข้อความประกาศที่นี่..."></textarea>
                        <div class="flex gap-2 justify-end">
                            <button onclick="deleteAnnouncement()"
                                class="bg-red-50 text-red-500 px-6 py-2 rounded-xl font-bold text-sm hover:bg-red-100 transition"><i
                                    class="fas fa-trash-alt mr-1"></i> ลบประกาศ</button>
                            <button onclick="postAnnouncement()"
                                class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-blue-700 transition shadow-lg shadow-blue-200"><i
                                    class="fas fa-paper-plane mr-1"></i> โพสต์ประกาศ</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="mgr-site-grid"></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                            <div class="p-6 bg-slate-900 text-white flex justify-between items-center font-black">
                                <span><i class="fas fa-hourglass-half text-yellow-400 mr-2"></i>คำขอรออนุมัติ</span>
                                <span id="mgr-pending-count"
                                    class="bg-yellow-400 text-slate-900 text-[10px] px-2 py-0.5 rounded-full ml-2">0</span>
                            </div>
                            <div id="mgr-request-list"
                                class="divide-y divide-slate-100 max-h-[300px] overflow-y-auto custom-scrollbar"></div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div
                                class="p-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center font-black text-slate-700">
                                <span><i
                                        class="fas fa-history text-slate-400 mr-2"></i>ประวัติการอนุมัติและรายการย้อนหลัง</span>
                            </div>
                            <div id="mgr-history-list"
                                class="divide-y divide-slate-100 max-h-[500px] overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>

                    <div
                        class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden h-fit sticky top-24">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center font-black">
                            <div class="flex items-center gap-4">
                                Ranking พนักงาน
                                <div class="flex bg-slate-100 rounded-lg p-1">
                                    <button onclick="setRankingMode('top')" id="btn-rank-top"
                                        class="px-3 py-1 text-[10px] rounded-md font-bold transition bg-white text-slate-800 shadow-sm">Top</button>
                                    <button onclick="setRankingMode('low')" id="btn-rank-low"
                                        class="px-3 py-1 text-[10px] rounded-md font-bold transition text-slate-500 hover:text-slate-700">Low</button>
                                </div>
                            </div>
                            <button onclick="exportEmployeeReport()" class="text-blue-600 text-xs font-bold"><i
                                    class="fas fa-file-export"></i></button>
                        </div>
                        <div id="mgr-emp-ranking" class="p-4 space-y-3"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Face Scan Modal -->
    <div id="faceScanModal"
        class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl text-slate-800 flex items-center gap-3">
                    <i id="faceScanIcon" class="fas fa-camera text-blue-600"></i>
                    <span id="faceScanTitle">สแกนใบหน้าเพื่อเช็คชื่อ</span>
                </h3>
                <button onclick="closeFaceScanModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Mode Indicator -->
            <div id="faceModeIndicator" class="mb-4"></div>

            <!-- Webcam Container -->
            <div class="relative">
                <!-- Video Preview -->
                <div class="relative bg-slate-900 rounded-2xl overflow-hidden aspect-video">
                    <video id="faceVideo" autoplay muted playsinline
                        class="w-full h-full object-cover transform scale-x-[-1]"></video>
                    <!-- Canvas for Face Detection Overlay -->
                    <canvas id="faceCanvas" class="absolute inset-0 transform scale-x-[-1]"></canvas>

                    <!-- Face Detection Indicator -->
                    <div id="faceDetectionStatus"
                        class="absolute top-4 left-4 bg-slate-900/80 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2">
                        <div id="faceDetectionDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span id="faceDetectionText" class="text-white text-sm font-bold">กำลังตรวจจับใบหน้า...</span>
                    </div>

                    <!-- Liveness Prompt -->
                    <div id="livenessPrompt"
                        class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-600 text-white px-8 py-4 rounded-2xl shadow-2xl text-center animate-bounce">
                        <i class="fas fa-hand-point-up text-3xl mb-2"></i>
                        <p class="font-black text-xl" id="livenessText">กรุณากระพริบตา</p>
                    </div>

                    <!-- Face Guide Oval -->
                    <div id="faceGuide"
                        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-80 border-4 border-dashed border-white/30 rounded-full pointer-events-none">
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mt-4 bg-slate-100 h-3 rounded-full overflow-hidden">
                    <div id="faceProgress" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%">
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="mt-6 bg-blue-50 rounded-2xl p-4">
                <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i>
                    <span id="instructionTitle">คำแนะนำ</span>
                </h4>
                <ul id="faceInstructions" class="text-sm text-blue-800 space-y-1">
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-600 mt-1"></i>
                        <span>จัดตำแหน่งใบหน้าให้อยู่ในกรอบวงกลม</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-600 mt-1"></i>
                        <span>ทำตามคำสั่งที่ปรากฏบนหน้าจอ</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-600 mt-1"></i>
                        <span>อยู่ในที่ที่มีแสงสว่างเพียงพอ</span>
                    </li>
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex gap-3">
                <button onclick="closeFaceScanModal()"
                    class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition">
                    ยกเลิก
                </button>
                <button id="retryFaceButton" onclick="retryFaceScan()"
                    class="hidden flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
                    <i class="fas fa-redo mr-2"></i>ลองใหม่
                </button>
            </div>

            <!-- Status Messages -->
            <div id="faceStatusMessage" class="mt-4 text-center font-bold text-sm"></div>
        </div>
    </div>

    <!-- Modals (Same as before + any necessary ones) -->
    <!-- Calendar Modal -->
    <div id="calendarModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl animate-slide-in flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-purple-600"></i> ปฏิทินการทำงาน
                </h3>
                <button onclick="closeModal('calendarModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex justify-between items-center mb-4 bg-slate-50 p-2 rounded-xl">
                <button onclick="changeCalendarMonth(-1)"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-slate-500"><i
                        class="fas fa-chevron-left"></i></button>
                <span id="calMonthYear" class="font-bold text-slate-700">...</span>
                <button onclick="changeCalendarMonth(1)"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-slate-500"><i
                        class="fas fa-chevron-right"></i></button>
            </div>

            <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                <div class="text-red-500 font-bold text-xs">อา</div>
                <div class="text-slate-500 font-bold text-xs">จ</div>
                <div class="text-slate-500 font-bold text-xs">อ</div>
                <div class="text-slate-500 font-bold text-xs">พ</div>
                <div class="text-slate-500 font-bold text-xs">พฤ</div>
                <div class="text-slate-500 font-bold text-xs">ศ</div>
                <div class="text-slate-500 font-bold text-xs">ส</div>
            </div>

            <div id="calendarGrid" class="grid grid-cols-7 gap-1 overflow-y-auto custom-scrollbar flex-1">
                <!-- JS Generated Days -->
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100 grid grid-cols-2 gap-2 text-xs">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-green-100 border border-green-300"></div> มาทำงาน
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-100 border border-yellow-300"></div> สาย
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-100 border border-red-300"></div> ขาด/ลา/โทษ
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-blue-100 border border-blue-300"></div> ลา/หยุด
                </div>
                <div class="flex items-center gap-2"><span
                        class="bg-blue-500 text-white text-[8px] px-1 rounded-full">OT</span> มีโอที</div>
                <div class="flex items-center gap-2"><span
                        class="bg-red-500 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full">-1</span>
                    หักคะแนน</div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-purple-100 border border-purple-300"></div> วันหยุด
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Manage Holidays, Bulk Transfer, Add Employee, etc.) included but summarized for brevity -->
    <!-- [Include other modals here from previous code] -->
    <!-- Modal: Manage Holidays -->
    <div id="manageHolidaysModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl animate-slide-in flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fas fa-umbrella-beach text-purple-500"></i> จัดการวันหยุด
                </h3>
                <button onclick="closeModal('manageHolidaysModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 pr-2 space-y-6">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <h4 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2"><i
                            class="fas fa-redo text-slate-400"></i> วันหยุดประจำสัปดาห์</h4>
                    <div class="grid grid-cols-4 gap-2">
                        <!-- Checkboxes 0-6 -->
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="0"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            อาทิตย์</label>
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="1"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            จันทร์</label>
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="2"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            อังคาร</label>
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="3"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            พุธ</label>
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="4"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            พฤหัส</label>
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="5"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            ศุกร์</label>
                        <label
                            class="flex items-center gap-2 text-xs font-bold cursor-pointer bg-white p-2 rounded-lg border border-slate-200 hover:border-purple-300 has-[:checked]:bg-purple-50 has-[:checked]:border-purple-300 has-[:checked]:text-purple-700 transition"><input
                                type="checkbox" name="weeklyHoliday" value="6"
                                class="rounded text-purple-600 focus:ring-purple-500" onchange="saveHolidays()">
                            เสาร์</label>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2"><i
                            class="fas fa-star text-yellow-400"></i> วันหยุดประจำปี / พิเศษ</h4>
                    <div class="flex gap-2 mb-4">
                        <input type="date" id="newHolidayDate"
                            class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2 font-bold text-sm text-slate-800 focus:ring-2 focus:ring-purple-500">
                        <input type="text" id="newHolidayName" placeholder="ชื่อวันหยุด"
                            class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2 font-bold text-sm text-slate-800 focus:ring-2 focus:ring-purple-500">
                        <button onclick="addAnnualHoliday()"
                            class="bg-purple-600 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-purple-700 shadow-md transition">เพิ่ม</button>
                    </div>
                    <div
                        class="bg-white border border-slate-100 rounded-2xl overflow-hidden max-h-48 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase sticky top-0">
                                <tr>
                                    <th class="p-3 pl-4">วันที่</th>
                                    <th class="p-3">ชื่อวันหยุด</th>
                                    <th class="p-3 text-right pr-4">ลบ</th>
                                </tr>
                            </thead>
                            <tbody id="annualHolidaysList" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal: Bulk Transfer -->
    <div id="bulkTransferModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-black">ย้ายกลุ่มพนักงาน</h3>
                <button onclick="closeModal('bulkTransferModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <p class="text-sm text-slate-500 mb-6">คุณเลือกพนักงาน <span id="bulkTransferCount"
                    class="font-black text-blue-600 text-lg">0</span> คน</p>
            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">ย้ายไปที่ Yard (ปลายทาง)</label>
            <select id="bulkTargetYard"
                class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold text-slate-800 mb-6"></select>
            <div class="flex gap-2">
                <button onclick="closeModal('bulkTransferModal')"
                    class="flex-1 bg-slate-100 font-bold py-3 rounded-xl text-slate-500">ยกเลิก</button>
                <button onclick="confirmBulkTransfer()"
                    class="flex-1 bg-orange-500 text-white font-black py-3 rounded-xl shadow-lg hover:bg-orange-600">ยืนยันการย้าย</button>
            </div>
        </div>
    </div>
    <!-- Modal: Add Employee (Updated) -->
    <div id="addEmpModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">เพิ่มพนักงานใหม่</h3>
                <button onclick="closeModal('addEmpModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <form onsubmit="handleAddEmployee(event)" class="space-y-4">
                <input type="text" id="newEmpName" placeholder="ชื่อ-นามสกุล"
                    class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold" required>
                <!-- Added Nickname Input -->
                <input type="text" id="newEmpNickname" placeholder="ชื่อเล่น"
                    class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold">

                <input type="text" id="newEmpCode" placeholder="รหัสพนักงาน"
                    class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold" required>
                <input type="text" id="newEmpPosition" placeholder="ตำแหน่ง"
                    class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase">กำหนดคะแนนรวมเริ่มต้น</label>
                    <input type="number" id="newEmpBaseScore" value="30"
                        class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold text-blue-600">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" onclick="closeModal('addEmpModal')"
                        class="flex-1 bg-slate-100 font-bold py-3 rounded-xl">ยกเลิก</button>
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal: Manage History -->
    <div id="manageHistoryModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl animate-slide-in max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black flex items-center gap-2"><i class="fas fa-history text-blue-600"></i>
                    จัดการคะแนนและประวัติ</h3>
                <button onclick="closeModal('manageHistoryModal')" class="text-slate-400"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 mb-6 flex justify-between items-center">
                <div>
                    <!-- Updated: Name with Edit Button -->
                    <div class="flex items-center gap-2">
                        <span id="mh-emp-name" class="font-black text-slate-800 text-lg">...</span>
                        <button onclick="editCurrentEmpName()"
                            class="text-slate-400 hover:text-blue-600 transition bg-white/50 hover:bg-white w-6 h-6 rounded-full flex items-center justify-center shadow-sm"
                            title="แก้ไขชื่อ">
                            <i class="fas fa-pen text-[10px]"></i>
                        </button>
                    </div>
                    <p id="mh-emp-code" class="text-slate-500 font-bold text-sm">...</p>
                </div>
                <div class="text-right">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">คะแนนรวมเริ่มต้น</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="mh-base-score"
                            class="w-20 bg-white border border-blue-200 rounded-lg px-2 py-1 font-black text-blue-600 text-center">
                        <button onclick="updateBaseScore()"
                            class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-black">บันทึก</button>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-3">รายการประวัติ (ลบเพื่อคืนคะแนน /
                    ยกเลิกสถานะ)</h4>
                <div id="mh-history-list" class="space-y-3"></div>
            </div>
        </div>
    </div>
    <!-- Modal: Manage Rules -->
    <div id="manageRulesModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-lg">ตั้งค่าเกณฑ์และคะแนน</h3><button
                    onclick="closeModal('manageRulesModal')"><i class="fas fa-times"></i></button>
            </div>

            <!-- NEW: Show Rules to Employee Toggle -->
            <div class="bg-purple-50 p-4 rounded-xl mb-4 border border-purple-100 flex items-center justify-between">
                <div>
                    <h4 class="text-[10px] font-black uppercase text-purple-600 mb-1">การแสดงผลพนักงาน</h4>
                    <p class="text-xs text-slate-500">เปิดเพื่อให้พนักงานเห็นกฎและเกณฑ์คะแนน</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleShowRules" onchange="toggleShowRulesToEmp(this.checked)"
                        class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600">
                    </div>
                </label>
            </div>

            <!-- Staff Password Setting -->
            <div class="bg-orange-50 p-4 rounded-xl mb-4 border border-orange-100">
                <h4 class="text-[10px] font-black uppercase text-orange-600 mb-2">รหัสผ่านสำหรับ Staff (เจ้าหน้าที่)
                </h4>
                <div class="flex gap-2">
                    <input type="text" id="staffPasswordInput"
                        class="flex-1 p-2 rounded-lg text-sm font-bold border-none" placeholder="รหัสผ่าน Staff">
                    <button onclick="updateStaffPassword()"
                        class="bg-orange-600 text-white px-4 py-2 rounded-lg text-xs font-black whitespace-nowrap hover:bg-orange-700 transition">บันทึก</button>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100">
                <h4 class="text-[10px] font-black uppercase text-blue-600 mb-2">คะแนนตั้งต้นมาตรฐาน (สำหรับพนักงานทุกคน)
                </h4>
                <div class="flex gap-2">
                    <input type="number" id="globalBaseScoreInput"
                        class="flex-1 p-2 rounded-lg text-sm font-bold text-center border-none" value="30"
                        placeholder="คะแนน">
                    <button onclick="applyGlobalBaseScore()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-black whitespace-nowrap hover:bg-blue-700 transition">ปรับปรุงทุกคน</button>
                </div>
                <p class="text-[10px] text-slate-400 mt-2">* จะเปลี่ยนคะแนนตั้งต้นของพนักงานทั้งหมดเป็นค่านี้ทันที</p>
            </div>
            <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100">
                <h4 class="text-[10px] font-black uppercase text-slate-500 mb-2">เพิ่ม/แก้ไขประเภทการลา</h4>
                <form onsubmit="addRule(event)" class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="newRuleName" placeholder="ชื่อ (เช่น ลากิจ)"
                            class="w-full p-2 rounded-lg text-xs font-bold border-none" required>
                        <input type="number" step="0.1" id="newRuleDed" placeholder="หัก (ปกติ)"
                            class="w-full p-2 rounded-lg text-xs font-bold border-none" required>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">หมวดหมู่สถิติ
                            (นับเป็น...)</label>
                        <select id="newRuleCategory"
                            class="w-full bg-white border border-slate-200 p-2 rounded-lg text-xs font-bold text-slate-700 outline-none">
                            <option value="leave">นับเป็น "วันลา" (Leave)</option>
                            <option value="penalty">นับเป็น "สาย/ขาด/โทษ" (Penalty)</option>
                            <option value="none">ไม่นับสถิติ (เช่น มาทำงาน, วันหยุด)</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2"><input type="checkbox" id="newRuleSelectable" checked
                                class="rounded text-green-600 focus:ring-green-500"><label for="newRuleSelectable"
                                class="text-xs font-bold text-slate-600">ให้พนักงานเลือกได้</label></div>
                        <div class="flex items-center gap-2"><input type="checkbox" id="enableTier"
                                onchange="toggleTierInputs()" class="rounded text-blue-600 focus:ring-blue-500"><label
                                for="enableTier" class="text-xs font-bold text-slate-600">ใช้เกณฑ์ขั้นบันได</label>
                        </div>
                    </div>

                    <!-- Updated Tier Input Section -->
                    <div id="tierInputs" class="hidden space-y-3 bg-white p-3 rounded-lg border border-slate-200 mt-2">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div><label class="text-[9px] text-slate-400 block">นับตาม (สะสมต่อปี)</label><select
                                    id="tierCountType" onchange="updateTierUnitLabels()"
                                    class="w-full text-xs font-bold p-1 border rounded">
                                    <option value="times">จำนวนครั้ง</option>
                                    <option value="days">จำนวนวัน</option>
                                </select></div>
                            <div><label class="text-[9px] text-slate-400 block">วิธีหักคะแนน</label><select
                                    id="tierDeductType" class="w-full text-xs font-bold p-1 border rounded">
                                    <option value="per_request">ต่อครั้งที่ลา</option>
                                    <option value="per_day">ต่อวันที่ลา</option>
                                </select></div>
                        </div>

                        <div class="text-[10px] font-black text-slate-500 uppercase">กำหนดช่วงเกณฑ์ (สูงสุดถึงต่ำสุด)
                        </div>
                        <div id="tierRowsContainer" class="space-y-2">
                            <!-- JS will inject rows here -->
                        </div>

                        <button type="button" onclick="addTierRow()"
                            class="w-full py-2 border-2 border-dashed border-slate-200 text-slate-400 rounded-lg text-xs font-bold hover:border-blue-300 hover:text-blue-500 hover:bg-blue-50 transition flex items-center justify-center gap-1">
                            <i class="fas fa-plus"></i> เพิ่มช่วงคะแนน
                        </button>

                        <div
                            class="flex items-center gap-2 text-xs bg-red-50 p-2 rounded-lg border border-red-100 mt-2">
                            <span class="text-red-700 font-bold whitespace-nowrap flex-1">กรณีเกินกว่ากำหนดทั้งหมด
                                ให้หัก:</span>
                            <input type="number" step="0.1" id="tierDefaultRate"
                                class="w-16 text-center border rounded p-1 font-bold text-red-600 focus:ring-1 focus:ring-red-500"
                                value="1">
                            <span class="text-red-700 font-bold">คะแนน</span>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-black hover:bg-slate-900 transition shadow-lg">บันทึกรายการ</button>
                </form>
            </div>
            <div class="overflow-y-auto max-h-64">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-[10px] text-slate-400 uppercase">
                            <th class="text-center py-2 w-10">เลือกได้</th>
                            <th class="text-left py-2">ประเภท</th>
                            <th class="text-center py-2">หัก</th>
                            <th class="text-center py-2">เงื่อนไข</th>
                            <th class="text-right py-2"></th>
                        </tr>
                    </thead>
                    <tbody id="rulesTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
        <div class="mt-8 border-t border-slate-200 pt-6">
            <h4 class="font-black text-sm text-slate-800 mb-4 flex items-center gap-2 uppercase tracking-wider">
                <i class="fas fa-medal text-yellow-500"></i> จัดการเกรดและสีการ์ด (คะแนนความประพฤติ)
            </h4>

            <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 grid grid-cols-3 gap-2">
                <input type="text" id="newGradeName" placeholder="ชื่อเกรด (เช่น A+)"
                    class="col-span-1 p-2 rounded-lg text-xs font-bold border-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="newGradeMin" placeholder="Min (ต่ำสุด)"
                    class="col-span-1 p-2 rounded-lg text-xs font-bold border-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="newGradeMax" placeholder="Max (สูงสุด)"
                    class="col-span-1 p-2 rounded-lg text-xs font-bold border-none focus:ring-2 focus:ring-blue-500">

                <input type="text" id="newGradeText" placeholder="ข้อความแสดง (เช่น ยอดเยี่ยม)"
                    class="col-span-2 p-2 rounded-lg text-xs font-bold border-none focus:ring-2 focus:ring-blue-500">

                <select id="newGradeColor"
                    class="col-span-1 p-2 rounded-lg text-xs font-bold text-slate-700 outline-none border-none bg-white">
                    <option value="gold">สีทอง</option>
                    <option value="green">สีเขียว</option>
                    <option value="blue">สีน้ำเงิน</option>
                    <option value="purple">สีม่วง</option>
                    <option value="orange">สีส้ม</option>
                    <option value="red">สีแดง</option>
                    <option value="gray">สีเทา</option>
                    <option value="black">สีดำ</option>
                </select>

                <button onclick="addGrade()"
                    class="col-span-3 bg-slate-800 text-white py-2 rounded-lg text-xs font-black hover:bg-slate-900 transition shadow-lg">บันทึกเกรด</button>
            </div>

            <div class="overflow-y-auto max-h-48 border border-slate-100 rounded-xl">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr class="text-[10px] text-slate-500 uppercase">
                            <th class="pl-4 py-2">เกรด</th>
                            <th class="text-center py-2">ช่วงคะแนน (Min-Max)</th>
                            <th class="text-center py-2">สี</th>
                            <th class="text-right pr-4 py-2">ลบ</th>
                        </tr>
                    </thead>
                    <tbody id="gradesTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Modal: Manage Yards -->
    <div id="manageYardsModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl animate-slide-in flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800">จัดการสถานที่ทำงาน</h3><button
                    onclick="closeModal('manageYardsModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                <h4 class="text-xs font-bold text-slate-500 mb-2 uppercase">เพิ่มสถานที่ใหม่</h4>
                <div class="flex gap-2"><input type="text" id="newYardName" placeholder="ชื่อสถานที่"
                        class="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold"><input
                        type="time" id="newYardTime" value="08:30"
                        class="bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold w-24"><button
                        onclick="addYard()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-black hover:bg-blue-700 transition">เพิ่ม</button>
                </div>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white sticky top-0 text-slate-400 font-bold uppercase text-[10px]">
                        <tr>
                            <th class="p-2">ชื่อสถานที่</th>
                            <th class="p-2 text-center">เวลาเข้างาน</th>
                            <th class="p-2 text-center">GPS</th>
                            <th class="p-2 text-right">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="yardsTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Modal: Yard Daily Detail -->
    <div id="yardDailyDetailModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl animate-slide-in max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="font-black text-xl text-slate-800" id="yardDetailTitle">รายละเอียด Yard</h3>
                    <p class="text-sm text-slate-500" id="yardDetailDate"></p>
                </div>
                <button onclick="closeModal('yardDailyDetailModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex space-x-2 mb-4 bg-slate-100 p-1 rounded-xl">
                <button onclick="filterYardDetail('all')"
                    class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-slate-800 shadow-sm"
                    id="btn-yd-all">ทั้งหมด</button>
                <button onclick="filterYardDetail('present')"
                    class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-white/50"
                    id="btn-yd-present">มาทำงาน</button>
                <button onclick="filterYardDetail('late')"
                    class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-white/50"
                    id="btn-yd-late">สาย</button>
                <button onclick="filterYardDetail('absent')"
                    class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-white/50"
                    id="btn-yd-absent">ขาด/ลา</button>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-400 font-bold uppercase text-[10px] sticky top-0">
                        <tr>
                            <th class="p-3">พนักงาน</th>
                            <th class="p-3">ตำแหน่ง</th>
                            <th class="p-3 text-center">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="yardDetailList" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Modal: Import Excel -->
    <div id="importExcelModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md animate-slide-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-xl">นำเข้า Excel</h3><button onclick="closeModal('importExcelModal')"
                    class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="block w-full mb-4">
            <button onclick="processExcelFile()"
                class="w-full bg-green-600 text-white font-black py-3 rounded-xl">เริ่มนำเข้า</button>
        </div>
    </div>

    <!-- Modal: GPS Geofence Setup -->
    <div id="geofenceModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-4xl shadow-2xl animate-slide-in flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fas fa-map-marked-alt text-blue-600"></i>
                    ตั้งค่า GPS Geofence: <span id="geofence-yard-name" class="text-blue-600"></span>
                </h3>
                <button onclick="closeModal('geofenceModal')" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 overflow-hidden">
                <!-- Left: Map -->
                <div class="lg:col-span-2">
                    <div class="bg-slate-100 rounded-2xl p-4 h-full flex flex-col">
                        <h4 class="text-xs font-bold text-slate-500 mb-2 uppercase">
                            <i class="fas fa-map text-green-500 mr-1"></i> แผนที่ (คลิกเพื่อเลือกตำแหน่ง)
                        </h4>
                        <div id="geofence-map"
                            class="flex-1 rounded-xl overflow-hidden border-2 border-slate-200 bg-white min-h-[400px]">
                            <div class="flex items-center justify-center h-full text-slate-500">
                                <i class="fas fa-spinner fa-spin text-2xl mr-2"></i>
                                <span class="font-bold">กำลังโหลดแผนที่...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Form -->
                <div class="flex flex-col gap-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-200">
                        <h4 class="text-xs font-bold text-blue-600 mb-3 uppercase">
                            <i class="fas fa-info-circle mr-1"></i> พิกัด GPS
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label
                                    class="block text-[10px] font-black text-slate-500 uppercase mb-1">Latitude</label>
                                <input type="number" step="any" id="geofence-lat" placeholder="เช่น 13.7563"
                                    class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-black text-slate-500 uppercase mb-1">Longitude</label>
                                <input type="number" step="any" id="geofence-lng" placeholder="เช่น 100.5018"
                                    class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-slate-500 uppercase mb-1">รัศมี
                                    (เมตร)</label>
                                <input type="number" id="geofence-radius" placeholder="เช่น 100" value="100"
                                    class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:ring-2 focus:ring-blue-500">
                                <p class="text-[10px] text-slate-500 mt-1">
                                    <i class="fas fa-lightbulb text-yellow-500"></i>
                                    ระบบจะเพิ่ม +20m tolerance อัตโนมัติ
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-2xl border border-green-200">
                        <h4 class="text-xs font-bold text-green-600 mb-2 uppercase">
                            <i class="fas fa-location-arrow mr-1"></i> ตำแหน่งปัจจุบันของคุณ
                        </h4>
                        <button onclick="useCurrentLocation()"
                            class="w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-black hover:bg-green-700 transition shadow-lg">
                            <i class="fas fa-crosshairs mr-2"></i>ใช้ตำแหน่งปัจจุบัน
                        </button>
                    </div>

                    <button onclick="saveGeofence()"
                        class="mt-auto bg-blue-600 text-white px-6 py-3 rounded-xl text-sm font-black hover:bg-blue-700 transition shadow-lg">
                        <i class="fas fa-save mr-2"></i>บันทึก Geofence
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Edit Profile Modal with Phone Input -->
    <div id="editProfileModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-slate-800">แก้ไขข้อมูลส่วนตัว</h3>
                <button onclick="closeModal('editProfileModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <form onsubmit="handleEditProfile(event)" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">ชื่อเล่น</label>
                    <input type="text" id="editProfileNickname"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Added Phone Input -->
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">เบอร์โทรศัพท์</label>
                    <input type="tel" id="editProfilePhone" placeholder="08xxxxxxxx"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">Username
                        (สำหรับเข้าระบบ)</label>
                    <input type="text" id="editProfileUsername" required
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">Password
                        (รหัสผ่านใหม่)</label>
                    <input type="text" id="editProfilePassword" required
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="pt-2">
                    <button type="submit"
                        class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-95">บันทึกการเปลี่ยนแปลง</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Rules & Criteria Modal -->
    <div id="rulesInfoModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl animate-slide-in max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fas fa-book-open text-orange-500"></i> กฎระเบียบและเกณฑ์คะแนน
                </h3>
                <button onclick="closeModal('rulesInfoModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-6 pr-2">
                <!-- Grades Section -->
                <div>
                    <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i
                            class="fas fa-medal text-yellow-500"></i> เกณฑ์เกรด (คะแนนความประพฤติ)</h4>
                    <div class="overflow-hidden border border-slate-100 rounded-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase">
                                <tr>
                                    <th class="p-3">เกรด</th>
                                    <th class="p-3 text-center">ช่วงคะแนน (Min-Max)</th>
                                    <th class="p-3 text-right">ความหมาย</th>
                                </tr>
                            </thead>
                            <tbody id="publicGradesTable" class="divide-y divide-slate-50">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Rules Section -->
                <div>
                    <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i
                            class="fas fa-clipboard-list text-blue-500"></i> การหักคะแนน (ขาด/ลา/มาสาย)</h4>
                    <div class="overflow-hidden border border-slate-100 rounded-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase">
                                <tr>
                                    <th class="p-3">รายการ</th>
                                    <th class="p-3 text-right">คะแนนที่หัก</th>
                                </tr>
                            </thead>
                            <tbody id="publicRulesTable" class="divide-y divide-slate-50">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2">* คะแนนรวมคิดจาก "คะแนนเต็ม - คะแนนที่ถูกหัก"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Request Leave (RESTORED) -->
    <div id="leaveModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md animate-slide-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-xl">ขอลาหยุด</h3>
                <button onclick="closeModal('leaveModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="leaveForm" onsubmit="handleLeaveSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">ประเภทการลา</label>
                    <select id="leaveType" onchange="updateLeaveInfo()"
                        class="w-full bg-slate-100 border border-slate-200 p-3 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"></select>
                    <p id="leaveInfoText" class="text-xs text-blue-500 font-bold ml-1 mt-1"></p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">ตั้งแต่วันที่</label>
                        <input type="date" id="leaveStartDate" required
                            class="w-full bg-slate-100 border border-slate-200 p-3 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">ถึงวันที่</label>
                        <input type="date" id="leaveEndDate" required
                            class="w-full bg-slate-100 border border-slate-200 p-3 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">เหตุผลการลา <span
                            class="text-red-500">*</span></label>
                    <textarea id="leaveReason" required rows="3"
                        class="w-full bg-slate-100 border border-slate-200 p-3 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="ระบุเหตุผล (จำเป็นต้องระบุ)..."></textarea>
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-95">ส่งคำขอ</button>
            </form>
        </div>
    </div>

    <!-- NEW Modal: Score Details Popup -->
    <div id="scoreDetailModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl animate-slide-in flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2" id="scoreDetailTitle">
                    รายละเอียด
                </h3>
                <button onclick="closeModal('scoreDetailModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="scoreDetailList" class="overflow-y-auto flex-1 space-y-2 pr-2 custom-scrollbar">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- NEW Modal: Export Options -->
    <div id="exportOptionsModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[130] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800">เลือกช่วงเวลา Export</h3>
                <button onclick="closeModal('exportOptionsModal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex gap-4 bg-slate-50 p-1 rounded-xl">
                    <button onclick="toggleExportMode('monthly')" id="btn-export-monthly"
                        class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-blue-600">รายเดือน</button>
                    <button onclick="toggleExportMode('yearly')" id="btn-export-yearly"
                        class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-white/50">รายปี</button>
                </div>

                <div id="export-month-wrapper">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">เดือน</label>
                    <select id="exportMonthSelect"
                        class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold text-slate-700 outline-none">
                        <option value="0">มกราคม</option>
                        <option value="1">กุมภาพันธ์</option>
                        <option value="2">มีนาคม</option>
                        <option value="3">เมษายน</option>
                        <option value="4">พฤษภาคม</option>
                        <option value="5">มิถุนายน</option>
                        <option value="6">กรกฎาคม</option>
                        <option value="7">สิงหาคม</option>
                        <option value="8">กันยายน</option>
                        <option value="9">ตุลาคม</option>
                        <option value="10">พฤศจิกายน</option>
                        <option value="11">ธันวาคม</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">ปี (พ.ศ.)</label>
                    <input type="number" id="exportYearInput"
                        class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold text-slate-700 outline-none"
                        placeholder="2567">
                </div>
            </div>

            <button onclick="confirmExport()"
                class="w-full bg-green-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-green-700 transition transform active:scale-95">
                ดาวน์โหลดรายงาน
            </button>
        </div>
    </div>

    <!-- Face Recognition Modal -->
    <div id="faceRecognitionModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-[150] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl animate-slide-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fas fa-camera text-blue-600"></i> <span id="face-modal-title">แสกนใบหน้า</span>
                </h3>
                <button onclick="closeFaceModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Camera Preview -->
            <div class="relative mb-4 bg-slate-900 rounded-2xl overflow-hidden" style="aspect-ratio: 4/3;">
                <video id="faceVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                <canvas id="faceCanvas" class="absolute inset-0 w-full h-full"></canvas>

                <!-- Overlay Guide -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-48 h-48 border-4 border-white/50 rounded-full animate-pulse"></div>
                </div>
            </div>

            <!-- Status Display -->
            <div id="face-status" class="text-center mb-4">
                <p class="text-sm font-bold text-slate-600">กรุณาจัดใบหน้าให้อยู่ในกรอบ</p>
                <div id="gps-status" class="text-xs text-slate-400 mt-2">
                    <i class="fas fa-map-marker-alt"></i> กำลังตรวจสอบตำแหน่ง...
                </div>
            </div>

            <!-- Capture Button -->
            <button id="capture-btn" onclick="captureFace()"
                class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-95">
                <i class="fas fa-camera mr-2"></i> ถ่ายภาพและบันทึก
            </button>

            <!-- Loading State -->
            <div id="face-loading" class="hidden text-center py-4">
                <div
                    class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-2">
                </div>
                <p class="text-sm font-bold text-slate-600">กำลังประมวลผล...</p>
            </div>
        </div>
    </div>

    <!-- Geofence Management Modal -->
    <div id="manageGeofenceModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl animate-slide-in flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fas fa-map-marked-alt text-indigo-600"></i> จัดการพื้นที่ทำงาน (GPS Geofence)
                </h3>
                <button onclick="closeModal('manageGeofenceModal')" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Add New Geofence -->
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
                <h4 class="text-xs font-bold text-indigo-600 mb-3 uppercase">เลือกไซต์งาน (Yard) หรือเพิ่มใหม่</h4>

                <!-- Yard Selector -->
                <div class="mb-3">
                    <label class="block text-xs font-bold text-slate-600 mb-1">เลือกไซต์งานที่มีอยู่</label>
                    <select id="yardSelector" onchange="loadSelectedYard()"
                        class="w-full bg-white border border-indigo-200 rounded-lg px-3 py-2 text-sm font-bold">
                        <option value="">-- เลือกไซต์งานเพื่อแก้ไข หรือเพิ่มใหม่ --</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="newGeofenceName" placeholder="ชื่อพื้นที่ (เช่น สำนักงานใหญ่)"
                        class="col-span-2 bg-white border border-indigo-200 rounded-lg px-3 py-2 text-sm font-bold">

                    <input type="number" step="0.000001" id="newGeofenceLat" placeholder="Latitude (เช่น 13.7563)"
                        class="bg-white border border-indigo-200 rounded-lg px-3 py-2 text-sm font-bold">

                    <input type="number" step="0.000001" id="newGeofenceLng" placeholder="Longitude (เช่น 100.5018)"
                        class="bg-white border border-indigo-200 rounded-lg px-3 py-2 text-sm font-bold">

                    <input type="number" id="newGeofenceRadius" placeholder="รัศมี (เมตร)" value="100"
                        class="bg-white border border-indigo-200 rounded-lg px-3 py-2 text-sm font-bold">

                    <button onclick="getCurrentLocation()"
                        class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-600 transition flex items-center justify-center gap-1">
                        <i class="fas fa-crosshairs"></i> ใช้ตำแหน่งปัจจุบัน
                    </button>
                </div>

                <!-- Interactive Map -->
                <div class="mb-3">
                    <label class="block text-xs font-bold text-indigo-600 mb-2 flex items-center gap-2">
                        <i class="fas fa-map-marked-alt"></i> เลือกตำแหน่งบนแผนที่
                    </label>
                    <div id="geofenceMap" class="w-full h-64 rounded-lg border-2 border-indigo-200 overflow-hidden">
                    </div>
                    <p class="text-xs text-slate-500 mt-1 italic">
                        <i class="fas fa-info-circle"></i> คลิกบนแผนที่เพื่อเลือกตำแหน่ง / ลากวงกลมเพื่อปรับรัศมี
                    </p>
                </div>

                <button onclick="addGeofence()"
                    class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-black hover:bg-indigo-700 transition">
                    เพิ่มพื้นที่
                </button>
            </div>

            <!-- Geofence List -->
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white sticky top-0 text-slate-400 font-bold uppercase text-[10px]">
                        <tr>
                            <th class="p-2">ชื่อพื้นที่</th>
                            <th class="p-2 text-center">พิกัด (Lat, Lng)</th>
                            <th class="p-2 text-center">รัศมี (ม.)</th>
                            <th class="p-2 text-right">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="geofenceTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <p class="text-xs text-slate-400">
                    <i class="fas fa-info-circle mr-1"></i>
                    พนักงานจะต้องอยู่ภายในรัศมีที่กำหนดจึงจะแสกนหน้าเข้า-ออกงานได้
                </p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-500 translate-y-32 z-[200]">
        <i class="fas fa-info-circle text-blue-400"></i><span id="toast-message" class="text-sm font-bold"></span>
    </div>
    <div id="dateDetailModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
        <div
            class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl animate-slide-in flex flex-col relative overflow-hidden">
            <div id="dd-header-bg" class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-500 to-blue-600">
            </div>

            <div class="relative z-10">
                <div class="flex justify-between items-start mb-4">
                    <div class="text-white">
                        <p id="dd-date-display" class="text-sm opacity-90 font-bold">...</p>
                        <h3 id="dd-status-title" class="text-2xl font-black mt-1">...</h3>
                    </div>
                    <button onclick="closeModal('dateDetailModal')"
                        class="bg-white/20 hover:bg-white/40 text-white rounded-full w-8 h-8 flex items-center justify-center transition backdrop-blur-md"><i
                            class="fas fa-times"></i></button>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 space-y-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 text-lg">
                            <i class="far fa-clock"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">เวลาที่บันทึก</p>
                            <p id="dd-time-display" class="font-bold text-slate-800 text-lg">-</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 text-lg">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">ล่วงเวลา (OT)</p>
                            <p id="dd-ot-display" class="font-bold text-slate-800 text-lg">-</p>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-xl p-3 border border-slate-100 mt-2">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">เหตุผล / หมายเหตุ</p>
                        <p id="dd-reason-display" class="text-sm text-slate-600 italic">...</p>
                    </div>

                    <div id="dd-deduction-box"
                        class="flex justify-between items-center bg-red-50 p-3 rounded-xl border border-red-100 hidden">
                        <span class="text-xs font-bold text-red-700">ถูกหักคะแนน</span>
                        <span id="dd-deduction-val" class="text-lg font-black text-red-600">-0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Updated Firebase Configuration for hrv2-5a910
        const firebaseConfig = {
            apiKey: "AIzaSyD882G0IdrmDrvL-msOBTs8SXabO4xTVzo",
            authDomain: "hrv2-5a910.firebaseapp.com",
            databaseURL: "https://hrv2-5a910-default-rtdb.firebaseio.com",
            projectId: "hrv2-5a910",
            storageBucket: "hrv2-5a910.firebasestorage.app",
            messagingSenderId: "148469028946",
            appId: "1:148469028946:web:47a8f5d4aa2f1f8373e78b",
            measurementId: "G-7ESNYYFJBZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const ADMIN_PIN = "admin";

        let appData = {
            currentUserId: 0,
            adminSelectedSite: "ระยอง",
            staffPassword: "staff",
            settings: { showRulesToEmp: false }, // NEW: Setting for showing rules
            // ==================== NEW: Geofence & Face Data ====================
            geofences: [], // Geofence locations for GPS check-in
            faceData: {},  // Face descriptors for face recognition (empId -> descriptor array)
            // ===================================================================
            grades: [
                { min: 28, max: 30, name: 'S-Class', text: 'ระดับพระเจ้า', color: 'gold' },
                { min: 25, max: 27, name: 'A', text: 'ดีเยี่ยม', color: 'green' },
                { min: 20, max: 24, name: 'B', text: 'ผ่านเกณฑ์', color: 'blue' },
                { min: 15, max: 19, name: 'C', text: 'ต้องปรับปรุง', color: 'orange' },
                { min: 0, max: 14, name: 'F', text: 'วิกฤต', color: 'red' }
            ],
            locations: [
                { name: "ระยอง", startTime: "08:30" },
                { name: "หนองยายบู่", startTime: "08:30" },
                { name: "28 ไร่", startTime: "08:30" },
                { name: "ซอย 5", startTime: "08:30" },
                { name: "มหาพร", startTime: "08:30" }
            ],
            employees: [],
            history: [],
            leaveRules: {
                1: { name: "ลาป่วย", deduction: 0.5, note: "ตามแพทย์สั่ง" },
                2: { name: "ลาป่วยจากการทำงาน", deduction: 0, note: "ตามแพทย์สั่ง" },
                3: { name: "ลากิจ", deduction: 0.5, note: "ล่วงหน้า 1 วัน" },
                4: { name: "ลาคลอด", deduction: 0, note: "ล่วงหน้า 7 วัน" },
                5: { name: "ลาพักผ่อนประจำปี", deduction: 0, note: "ตามสิทธิ์สะสม" },
                6: { name: "มาสาย < 30 นาที", deduction: 0.5, isSystem: true },
                7: { name: "มาสาย > 30 นาที", deduction: 1.0, isSystem: true },
                8: { name: "ขาดงาน", deduction: 1.0, isSystem: true },
                11: { name: "มาทำงาน", deduction: 0, isSystem: true }
            },
            holidays: {
                weekly: [],
                annual: []
            }
        };

        // User Session
        let session = {
            isLoggedIn: false,
            role: null, // 'admin', 'employee', or 'staff'
            userId: null
        };

        let tempEmpId = null;
        let calendarTargetEmpId = null;
        let calendarCurrentDate = new Date();
        let xlsxLoaded = false;

        // ========================================================================

        async function loadSheetJS() {
            if (xlsxLoaded) return;
            return new Promise((resolve) => {
                if (window.XLSX) { xlsxLoaded = true; resolve(); }
                else { setTimeout(resolve, 1000); }
            });
        }

        // ==================== GEOFENCE VALIDATION ====================
        let currentUserLocation = null;
        let currentYard = null;

        // Function to check if point is inside circle (geofence)
        function isInsideGeofence(lat, lng, geofence) {
            const R = 6371000; // Earth radius in meters
            const dLat = (geofence.lat - lat) * Math.PI / 180;
            const dLon = (geofence.lng - lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat * Math.PI / 180) * Math.cos(geofence.lat * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            // Add 20 meter tolerance for GPS accuracy
            const toleranceBuffer = 20; // meters  
            const effectiveRadius = parseFloat(geofence.radius) + toleranceBuffer;

            // Debug logging
            console.log(`🔍 Checking geofence "${geofence.name}":`, {
                userPosition: { lat, lng },
                geofenceCenter: { lat: geofence.lat, lng: geofence.lng },
                setRadius: geofence.radius + ' m',
                effectiveRadius: effectiveRadius + ' m (+20m tolerance)',
                actualDistance: distance.toFixed(2) + ' m',
                isInside: distance <= effectiveRadius
            });

            return distance <= effectiveRadius;
        }

        // Update location status UI with map
        let locationMap = null;
        let userMarker = null;
        let geofenceCircles = [];

        function updateLocationStatus(isInside, yardName = null) {
            const statusEl = document.getElementById('emp-location-status');
            const yardNameEl = document.getElementById('emp-yard-name');
            const iconEl = document.getElementById('emp-location-icon');

            if (isInside && yardName) {
                statusEl.innerText = 'อยู่ในพื้นที่';
                yardNameEl.innerText = yardName;
                iconEl.className = 'fas fa-map-marker-alt text-xl text-green-400';
                currentYard = yardName;
            } else {
                statusEl.innerText = 'อยู่นอกพื้นที่';
                yardNameEl.innerText = 'ไม่อยู่ในพื้นที่การทำงาน';
                iconEl.className = 'fas fa-map-marker-alt text-xl text-red-400';
                currentYard = null;
            }
        }

        // Initialize or update map
        function initializeLocationMap(userLat, userLng, foundYard = null) {
            const mapContainer = document.getElementById('emp-location-map');

            // Initialize map if not exists
            if (!locationMap) {
                mapContainer.innerHTML = ''; // Clear loading message
                locationMap = L.map('emp-location-map').setView([userLat, userLng], 15);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(locationMap);
            } else {
                // Update view
                locationMap.setView([userLat, userLng], 15);
            }

            // Remove old markers and circles
            if (userMarker) {
                locationMap.removeLayer(userMarker);
            }
            geofenceCircles.forEach(circle => locationMap.removeLayer(circle));
            geofenceCircles = [];

            // Add user marker with pulsing animation
            const markerColor = foundYard ? '#22c55e' : '#ef4444';
            userMarker = L.marker([userLat, userLng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div class="pulse-marker" style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(locationMap);

            userMarker.bindPopup(`<b>ตำแหน่งของคุณ</b><br>${foundYard ? `✅ พื้นที่: ${foundYard}` : '❌ อยู่นอกพื้นที่'}`).openPopup();

            // Draw all geofences
            (appData.geofences || []).forEach(geofence => {
                if (geofence.lat && geofence.lng && geofence.radius) {
                    const circle = L.circle([geofence.lat, geofence.lng], {
                        color: geofence.name === foundYard ? '#22c55e' : '#94a3b8',
                        fillColor: geofence.name === foundYard ? '#86efac' : '#cbd5e1',
                        fillOpacity: 0.2,
                        radius: geofence.radius,
                        weight: 2
                    }).addTo(locationMap);

                    circle.bindPopup(`<b>${geofence.name}</b><br>รัศมี: ${geofence.radius} เมตร`);
                    geofenceCircles.push(circle);
                }
            });
        }

        // Auto-check employee location on login (without opening face modal)
        function autoCheckEmployeeLocation() {
            const mapDisplay = document.getElementById('emp-location-display');
            if (!mapDisplay) return;

            if (!navigator.geolocation) {
                console.warn('Geolocation not supported');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    currentUserLocation = { lat: userLat, lng: userLng };

                    console.log('🔄 Auto GPS Check:', currentUserLocation);

                    // Check all geofences
                    let foundYard = null;
                    for (const geofence of appData.geofences || []) {
                        if (geofence.lat && geofence.lng && geofence.radius) {
                            if (isInsideGeofence(userLat, userLng, geofence)) {
                                foundYard = geofence.name;
                                break;
                            }
                        }
                    }

                    // Update status and map (without opening face modal)
                    updateLocationStatus(!!foundYard, foundYard);
                    initializeLocationMap(userLat, userLng, foundYard);
                },
                (error) => {
                    console.error('Auto GPS Check error:', error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // ================================================================

        async function init() {
            try {
                await signInAnonymously(auth);
                // Load data first, then check login status
                onValue(ref(db, 'hrms_v6_data'), (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // FIX: จับค่า userId ของเซสชั่นปัจจุบันไว้ก่อน เพื่อไม่ให้โดนทับ
                        const activeUserId = (session.isLoggedIn && session.role === 'employee') ? session.userId : null;

                        appData = {
                            ...appData, ...data,
                            employees: data.employees || [],
                            history: data.history ? Object.values(data.history) : [],
                            leaveRules: data.leaveRules || appData.leaveRules,
                            holidays: {
                                weekly: (data.holidays && data.holidays.weekly) || [],
                                annual: (data.holidays && data.holidays.annual) || []
                            },
                            staffPassword: data.staffPassword || "staff",
                            staffPassword: data.staffPassword || "staff",
                            settings: data.settings || { showRulesToEmp: false }, // Default setting
                            announcement: data.announcement || "" // NEW: Announcement Data
                        };
                        // Migration: If locations are strings, convert to objects
                        if (appData.locations.length > 0 && typeof appData.locations[0] === 'string') {
                            appData.locations = appData.locations.map(l => ({ name: l, startTime: "08:30" }));
                        }

                        // FIX: คืนค่า currentUserId ให้ถูกต้องตาม Session ของพนักงาน
                        if (activeUserId) {
                            appData.currentUserId = activeUserId;
                        }

                    } else saveData();

                    document.getElementById('loadingOverlay').classList.add('opacity-0', 'pointer-events-none');

                    // Check LocalStorage for Auto Login
                    const storedAuth = localStorage.getItem('2ps_auth');
                    if (storedAuth && !session.isLoggedIn) {
                        const authData = JSON.parse(storedAuth);
                        attemptLogin(authData.username, authData.password, true); // Silent login
                    }

                    // If already logged in, just update UI
                    if (session.isLoggedIn) {
                        updateUI();
                    }
                });
            } catch (err) { console.error(err); }

            setInterval(() => {
                const el = document.getElementById('emp-current-time');
                if (el) el.innerText = new Date().toLocaleTimeString('th-TH');
            }, 1000);
            document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('th-TH', { dateStyle: 'full' });
        }

        async function saveData() {
            // FIX: สร้างสำเนาข้อมูลและลบ currentUserId ออกก่อนบันทึก
            // เพื่อไม่ให้สถานะหน้าจอของ Admin ไปกระทบพนักงานคนอื่นใน Database
            const dataToSave = { ...appData };
            delete dataToSave.currentUserId;

            await set(ref(db, 'hrms_v6_data'), dataToSave);
        }

        // --- LOGIN LOGIC ---
        window.handleLogin = (e) => {
            e.preventDefault();
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();
            const remember = document.getElementById('rememberMe').checked;

            attemptLogin(u, p, false, remember);
        };

        function attemptLogin(u, p, isSilent = false, remember = false) {
            // Admin Check
            if (u === 'admin' && p === 'admin') {
                loginSuccess('admin', null, remember, u, p);
                return;
            }

            // Staff Check
            if (u === 'staff' && p === appData.staffPassword) {
                loginSuccess('staff', null, remember, u, p);
                return;
            }

            // Employee Check
            const emp = appData.employees.find(e => e.username === u && e.password === p);
            if (emp) {
                loginSuccess('employee', emp.id, remember, u, p);
                return;
            }

            if (!isSilent) alert("ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง");
        }

        function loginSuccess(role, userId, remember, u, p) {
            session = { isLoggedIn: true, role, userId };
            appData.currentUserId = userId || 0;

            if (remember) {
                localStorage.setItem('2ps_auth', JSON.stringify({ username: u, password: p }));
            }

            // Hide Login, Show App
            const loginScreen = document.getElementById('loginScreen');
            loginScreen.classList.add('login-fade-out');
            setTimeout(() => loginScreen.classList.add('hidden'), 500); // Completely hide after fade

            const mainApp = document.getElementById('mainApp');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');

            // UI Adjustments based on Role
            const roleTabs = document.getElementById('roleTabs');
            const adminSwitcher = document.getElementById('adminUserSwitcher');
            const userDisplay = document.getElementById('loggedInUserDisplay');
            const btnEditProfile = document.getElementById('btn-edit-profile'); // NEW

            if (role === 'admin') {
                roleTabs.classList.remove('hidden');
                adminSwitcher.classList.remove('hidden'); // Admin can switch user context
                adminSwitcher.classList.add('md:flex');
                if (btnEditProfile) btnEditProfile.classList.add('hidden'); // Hide edit profile
                userDisplay.innerText = "ผู้ใช้งาน: Admin";
                switchRole('admin'); // Default to Admin view
            } else if (role === 'staff') {
                // STAFF ROLE UI SETUP
                roleTabs.classList.add('hidden'); // Staff sees no role tabs (Fixed view)
                adminSwitcher.classList.add('hidden');
                adminSwitcher.classList.remove('md:flex');
                if (btnEditProfile) btnEditProfile.classList.add('hidden'); // Hide edit profile
                userDisplay.innerText = "ผู้ใช้งาน: เจ้าหน้าที่ (Staff)";
                switchRole('admin'); // Force Admin view (Yard Manager)
                // Restrictions applied in renderAdminView
            } else {
                roleTabs.classList.add('hidden'); // Employees don't see tabs
                adminSwitcher.classList.add('hidden');
                adminSwitcher.classList.remove('md:flex');
                if (btnEditProfile) btnEditProfile.classList.remove('hidden'); // Show edit profile

                const emp = appData.employees.find(e => e.id === userId);
                userDisplay.innerText = `ผู้ใช้งาน: ${emp ? emp.name : 'พนักงาน'}`;
                switchRole('employee');
            }
            updateUI();
        }

        window.handleLogout = () => {
            localStorage.removeItem('2ps_auth');
            location.reload(); // Simple reload to reset everything
        };

        // --- EXISTING LOGIC ---

        function calculateScores() {
            const currentYear = new Date().getFullYear(); // Updated: Yearly Reset Logic
            appData.employees.forEach(emp => {
                let deduction = 0;
                // Only subtract deduction if status is confirmed (Present, Penalty, Approved) AND in current year
                const history = appData.history.filter(h => {
                    const hYear = new Date(h.date).getFullYear();
                    return h.empId === emp.id &&
                        (h.status === 'Approved' || h.status === 'Present' || h.status === 'Penalty') &&
                        hYear === currentYear;
                });
                history.forEach(h => deduction += h.deduction || 0);
                const base = emp.baseScore || 30;
                emp.score = Math.max(0, base - deduction);
            });
        }

        function updateUI() {
            calculateScores();
            renderUserSwitcher();
            renderEmployeeView();
            // Render views if admin or staff
            if (session.role === 'admin' || session.role === 'staff') {
                renderAdminView();
                renderAdminAllEmployees();
                // Only admin sees manager view logic processing
                if (session.role === 'admin') {
                    renderManagerView();
                }
            }

            // Auto-check GPS location for employee view
            if (session.role === 'employee') {
                setTimeout(() => {
                    autoCheckEmployeeLocation();
                }, 1000); // Check after 1 second delay
            }

            renderLeaveTypeSelect();
        }

        function renderUserSwitcher() {
            const select = document.getElementById('userSwitcher');
            if (!select) return;
            select.innerHTML = '';
            appData.employees.forEach(e => {
                const opt = document.createElement('option');
                // Updated: Show Name + Nickname in switcher
                opt.value = e.id;
                opt.text = `${e.name} ${e.nickname ? '(' + e.nickname + ')' : ''}`;
                opt.selected = e.id == appData.currentUserId;
                select.appendChild(opt);
            });
        }

        function renderLeaveTypeSelect() {
            const select = document.getElementById('leaveType');
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '';
            Object.entries(appData.leaveRules).forEach(([k, v]) => {
                // Show only if NOT system AND isSelectable is true (or undefined which defaults to true)
                if (!v.isSystem && v.isSelectable !== false) {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.text = v.name;
                    select.appendChild(opt);
                }
            });
            if (currentVal && appData.leaveRules[currentVal] && appData.leaveRules[currentVal].isSelectable !== false) {
                select.value = currentVal;
            } else if (select.options.length > 0) {
                select.value = select.options[0].value;
            }
            updateLeaveInfo();
        }

        function getTodayStr() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // --- EMPLOYEE VIEW (UPDATED LOGIC) ---
        function renderEmployeeView() {
            const emp = appData.employees.find(e => e.id == appData.currentUserId);
            if (!emp) return;

            const base = emp.baseScore || 30;
            // Updated name display to include nickname
            document.getElementById('emp-name-display').innerText = `${emp.name} ${emp.nickname ? '(' + emp.nickname + ')' : ''}`;
            document.getElementById('emp-pos-display').innerText = emp.position || 'พนักงาน';
            document.getElementById('emp-code-display').innerText = 'รหัส: ' + emp.code;
            // Display Phone Number
            const phoneEl = document.getElementById('emp-phone-display');
            if (phoneEl) {
                if (emp.phone) {
                    phoneEl.innerHTML = `<i class="fas fa-phone-alt text-xs mr-1 text-blue-500"></i> ${emp.phone}`;
                } else {
                    phoneEl.innerHTML = `<i class="fas fa-phone-alt text-xs mr-1 text-slate-300"></i> <span class="text-slate-300">ไม่ระบุ</span>`;
                }
            }

            document.getElementById('emp-score').innerText = emp.score;
            document.getElementById('emp-base-display').innerText = `/ ${base}`;

            // Show Start Time
            const yard = appData.locations.find(l => (typeof l === 'object' ? l.name : l) === emp.location);
            const startTime = yard ? (yard.startTime || "08:30") : "08:30";
            document.getElementById('emp-work-start-time').innerText = `เข้างานปกติ ${startTime} น.`;



            // -----------------------------------------------------------
            // 🟢 4. ส่วนแสดงผลเกรดและสี (วางใน renderEmployeeView)
            // -----------------------------------------------------------

            // NEW: Render Announcement
            const annCard = document.getElementById('emp-announcement-card');
            const annText = document.getElementById('emp-announcement-text');

            if (appData.announcement && appData.announcement.trim() !== "") {
                annCard.classList.remove('hidden');
                annText.innerText = appData.announcement;
            } else {
                annCard.classList.add('hidden');
            }

            // 1. คำนวณ % คะแนน (ใช้สำหรับแสดงหลอดพลังเท่านั้น)
            const pct = (base > 0) ? (emp.score / base) * 100 : 0;

            const card = document.getElementById('emp-score-card');
            const statusText = document.getElementById('emp-status-text');
            const bar = document.getElementById('emp-score-bar');

            // 2. ดึงข้อมูลเกรดมาเรียง (จากคะแนนมาก -> น้อย)
            // ถ้าแอดมินยังไม่เคยตั้งค่า ให้ใช้ค่า Default สีฟ้าไปก่อน
            const gradesList = (appData.grades && appData.grades.length > 0)
                ? appData.grades
                : [{ min: 0, max: 100, name: 'Normal', text: 'ปกติ', color: 'blue' }];

            // ไม่ต้อง Sort ก็ได้ถ้าใช้การวน Loop หาช่วงที่ Match

            // 3. เปรียบเทียบหาเกรดที่ได้ (ใช้คะแนนดิบ emp.score เทียบกับ min-max)
            let currentGrade = gradesList.find(g => emp.score >= g.min && emp.score <= g.max);

            // กรณีคะแนนต่ำเตี้ยเรี่ยดินจนไม่เข้าเกณฑ์ไหนเลย หรือสูงเกิน
            if (!currentGrade) {
                // Fallback Logic: Check if score is extremely low (below min of lowest grade)
                if (emp.score < Math.min(...gradesList.map(g => g.min))) {
                    currentGrade = { name: 'F-', text: 'ต่ำกว่าเกณฑ์', color: 'gray' };
                } else {
                    // Default just in case
                    currentGrade = { name: '-', text: 'ไม่ระบุ', color: 'gray' };
                }
            }

            // 4. แปลงชื่อสีเป็น Class (ดึงจาก colorMap ที่ประกาศไว้ข้างบน)
            // ถ้าหาสีไม่เจอ ให้ใช้สีเทา
            const colorClasses = colorMap[currentGrade.color] || colorMap['gray'];

            // 5. พ่นค่าลงหน้าจอ (Update UI)

            // 5.1 รีเซ็ต Class การ์ดให้สะอาดก่อน
            card.className = "rounded-3xl p-6 text-white shadow-xl relative overflow-hidden group transition-all duration-700";

            // 5.2 ใส่สีพื้นหลังใหม่ (Gradient)
            // colorClasses[0] = สีเริ่ม, colorClasses[1] = สีจบ
            card.classList.add("bg-gradient-to-br", colorClasses[0], colorClasses[1]);

            // 5.3 อัปเดตหัวข้อการ์ด (ใส่ชื่อเกรด เช่น A+)
            const headerHtml = `
                <div class="flex flex-row justify-between items-center w-full">
                    <span class="text-sm font-bold opacity-90">คะแนนความประพฤติ (ปีนี้)</span>
                    
                    <span class="text-5xl font-black text-white drop-shadow-lg tracking-tighter border-b-4 border-white/20 leading-none pb-1 ml-2" 
                          style="text-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                        ${currentGrade.name}
                    </span>
                </div>`;

            // ค้นหา <h3> ในการ์ดแล้วเปลี่ยนข้อความ
            const headerEl = card.querySelector('h3');
            if (headerEl) {
                // ล้าง Class เดิมของ h3 ออกเพื่อให้จัด Layout ใหม่ได้อิสระ
                headerEl.className = "w-full";
                headerEl.innerHTML = headerHtml;
            }

            // 5.4 อัปเดตข้อความสถานะ (เช่น ยอดเยี่ยม)
            statusText.innerText = currentGrade.text;

            // 5.5 เปลี่ยนสีพื้นหลังของคำว่าสถานะ (ใช้สีจางๆ ให้ดูหรู)
            statusText.className = `text-[10px] font-bold text-white inline-block px-3 py-1 rounded-full bg-white/20 backdrop-blur-md border border-white/20 shadow-inner`;

            // 5.6 อัปเดตหลอดพลัง (Bar)
            bar.style.width = Math.max(0, Math.min(100, pct)) + '%';

            // -----------------------------------------------------------

            // History & Stats Logic
            const historyBody = document.getElementById('emp-history-list');
            if (historyBody) {
                historyBody.innerHTML = '';

                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const myHistory = appData.history.filter(h => h.empId == emp.id).sort((a, b) => b.timestamp.localeCompare(a.timestamp));

                // Calculate Total Monthly OT
                let totalMonthlyOT = 0;
                myHistory.forEach(h => {
                    const d = new Date(h.date);
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear && h.otHours) {
                        totalMonthlyOT += parseFloat(h.otHours);
                    }
                });
                const otSumEl = document.getElementById('emp-ot-sum');
                if (otSumEl) otSumEl.innerText = totalMonthlyOT;

                // --- LOGIC UPDATE HERE: แยกประเภทการนับ ---

                // 1. นับการลา (Leave): เปลี่ยนจากนับครั้ง (.length) เป็นรวมจำนวนวัน (.reduce)
                // แก้ไข: นับรวมการลาทุกประเภท (รวมถึงที่หัก 0 คะแนน) ถ้าหมวดหมู่เป็น leave หรือ ID <= 5
                const leaveCount = myHistory.filter(h => {
                    const typeId = h.type;
                    const rule = appData.leaveRules[typeId];
                    const isLeave = (parseInt(typeId) <= 5) || (rule && rule.category === 'leave');

                    return isLeave &&
                        (h.status === 'Approved' || h.status === 'Pending') &&
                        new Date(h.date).getFullYear() === currentYear;
                }).reduce((sum, h) => {
                    // คำนวณระยะห่างระหว่างวันเริ่ม (date) กับวันสิ้นสุด (endDate)
                    const start = new Date(h.date);
                    const end = new Date(h.endDate || h.date); // ถ้าไม่มีวันสิ้นสุด ให้ใช้วันเริ่ม
                    const diffTime = Math.abs(end - start);
                    const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // แปลงเป็นวัน +1
                    return sum + days;
                }, 0);

                // 2. นับสาย/โทษ (Penalty): นับ Type 6, 7 (สาย), Type 8 (ขาด) หรือสถานะ Penalty หรือหมวดหมู่ penalty
                const penaltyCount = myHistory.filter(h => {
                    const isYear = new Date(h.date).getFullYear() === currentYear;
                    const type = parseInt(h.type);
                    const rule = appData.leaveRules[type];
                    // 6=สาย<30, 7=สาย>30, 8=ขาดงาน
                    const isDiscipline = (type === 6 || type === 7 || type === 8 || h.status === 'Penalty' || (rule && rule.category === 'penalty'));
                    return isYear && isDiscipline;
                }).length;

                // Update UI Text
                const elLeaveCard = document.getElementById('stat-leave-count-card');
                if (elLeaveCard) elLeaveCard.innerText = leaveCount;

                const elPenaltyCard = document.getElementById('stat-penalty-count-card');
                if (elPenaltyCard) elPenaltyCard.innerText = penaltyCount;

                // Render Table
                myHistory.forEach(h => {
                    const row = document.createElement('tr');
                    const statusBadge = h.status === 'Pending' ? 'bg-yellow-100 text-yellow-700' : (h.status === 'Rejected' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
                    const otDisplay = h.otHours ? `<span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold">+${h.otHours} ชม.</span>` : '-';

                    let actionHtml = `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${statusBadge}">${h.status}</span>`;
                    if (h.status === 'Pending') {
                        actionHtml += `<button onclick="cancelRequest(${h.id})" class="ml-2 text-slate-400 hover:text-red-500 transition" title="ยกเลิกคำขอ"><i class="fas fa-trash-alt"></i></button>`;
                    }

                    let timeStr = "-";
                    if (h.timestamp) {
                        const d = new Date(h.timestamp);
                        timeStr = `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')} น.`;
                    }

                    row.innerHTML = `<td class="px-6 py-4 text-xs">${h.date}</td>
                                     <td class="px-6 py-4 text-xs font-bold text-slate-600">${timeStr}</td>
                                     <td class="px-6 py-4 font-bold">${appData.leaveRules[h.type]?.name || 'พิเศษ'}</td>
                                     <td class="px-6 py-4 italic text-xs">"${h.reason}"</td>
                                     <td class="px-6 py-4 text-center">${otDisplay}</td>
                                     <td class="px-6 py-4 text-center font-black ${h.deduction > 0 ? 'text-red-500' : 'text-slate-300'}">-${h.deduction || 0}</td>
                                     <td class="px-6 py-4 text-center flex items-center justify-center">${actionHtml}</td>`;
                    historyBody.appendChild(row);
                });
            }

            // Check In Status for Today
            const today = new Date().toISOString().slice(0, 10); // Simple date format
            const hasChecked = appData.history.find(h => h.empId == emp.id && h.date === today && (h.type == 11 || h.type == 6 || h.type == 7));

            // Show/hide check-in and check-out buttons
            const checkinContainer = document.getElementById('checkin-container');
            const checkoutContainer = document.getElementById('checkout-container');
            const alreadyCheckedContainer = document.getElementById('already-checked-container');
            const alreadyChecked = document.getElementById('already-checked');

            // Always show both check-in and check-out buttons
            if (checkinContainer) checkinContainer.classList.remove('hidden');
            if (checkoutContainer) checkoutContainer.classList.remove('hidden');

            if (hasChecked) {
                // Has checked in already
                // Check if already checked out
                if (hasChecked.checkOutTime) {
                    // Already checked out - show complete message in top section
                    if (alreadyCheckedContainer) alreadyCheckedContainer.classList.remove('hidden');
                    if (alreadyChecked) {
                        alreadyChecked.classList.remove('hidden');
                        const checkTimeDisplay = document.getElementById('check-time-display');
                        if (checkTimeDisplay) {
                            checkTimeDisplay.innerText = `เข้างาน: ${hasChecked.checkInTime || '-'} | ออกงาน: ${hasChecked.checkOutTime || '-'}`;
                        }
                    }
                } else {
                    // Checked in but not checked out yet
                    if (alreadyCheckedContainer) alreadyCheckedContainer.classList.add('hidden');
                    if (alreadyChecked) alreadyChecked.classList.add('hidden');

                    // Update checkout duration display
                    const durationEl = document.getElementById('checkout-work-duration');
                    if (durationEl && hasChecked.checkInTime) {
                        const checkInTime = new Date(hasChecked.date + ' ' + hasChecked.checkInTime);
                        const now = new Date();
                        const hours = Math.floor((now - checkInTime) / (1000 * 60 * 60));
                        const minutes = Math.floor(((now - checkInTime) % (1000 * 60 * 60)) / (1000 * 60));
                        durationEl.innerText = `ทำงานมาแล้ว ${hours} ชม. ${minutes} นาที`;
                    }
                }
            } else {
                // Haven't checked in yet
                if (alreadyCheckedContainer) alreadyCheckedContainer.classList.add('hidden');
                if (alreadyChecked) alreadyChecked.classList.add('hidden');
            }

            const actionContainer = document.getElementById('attendance-actions');
            if (actionContainer) {
                actionContainer.classList.add('hidden'); // Hide old action container
            }

            // Toggle Rules Button Visibility
            const btnRules = document.getElementById('btn-show-rules');
            if (btnRules) {
                if (appData.settings && appData.settings.showRulesToEmp) {
                    btnRules.classList.remove('hidden');
                    btnRules.classList.add('flex');
                } else {
                    btnRules.classList.add('hidden');
                    btnRules.classList.remove('flex');
                }
            }
        }

        // --- NEW: Rules Info Modal ---
        window.openRulesInfoModal = function () {
            // Populate Grades Table
            const gradesBody = document.getElementById('publicGradesTable');
            gradesBody.innerHTML = '';

            const sortedGrades = [...appData.grades].sort((a, b) => b.min - a.min);
            sortedGrades.forEach(g => {
                const colorClass = colorMap[g.color] || colorMap['gray'];
                gradesBody.innerHTML += `
                    <tr class="border-b border-slate-50 last:border-none hover:bg-slate-50">
                        <td class="p-3">
                            <span class="font-black text-slate-800">${g.name}</span>
                            <div class="w-16 h-1 rounded-full bg-gradient-to-r ${colorClass[0]} ${colorClass[1]} mt-1 opacity-60"></div>
                        </td>
                        <td class="p-3 text-center text-xs font-bold text-slate-600">${g.min} - ${g.max}</td>
                        <td class="p-3 text-right text-xs text-slate-500">${g.text}</td>
                    </tr>
                `;
            });

            // Populate Rules Table
            const rulesBody = document.getElementById('publicRulesTable');
            rulesBody.innerHTML = '';

            // Filter only active rules and sort loosely (Leave first, then Penalty)
            Object.values(appData.leaveRules).forEach(r => {
                // Show rule if not hidden system logic (optional) - let's show all relevant ones
                // e.g. Show types 1-8. Type 11 (Work) doesn't need to be shown as a deduction rule.
                if (r.name === 'มาทำงาน') return;

                let deductionText = "";
                if (r.useTiers) {
                    deductionText = `<span class="text-blue-600 font-bold">ขั้นบันได</span>`;
                } else {
                    deductionText = `<span class="text-red-500 font-bold">-${r.deduction}</span>`;
                }

                rulesBody.innerHTML += `
                    <tr class="border-b border-slate-50 last:border-none hover:bg-slate-50">
                        <td class="p-3 text-sm font-bold text-slate-700">${r.name}</td>
                        <td class="p-3 text-right text-sm">${deductionText}</td>
                    </tr>
                `;
            });

            openModal('rulesInfoModal');
        };

        // --- NEW: Toggle Show Rules Setting ---
        window.toggleShowRulesToEmp = function (checked) {
            if (!appData.settings) appData.settings = {};
            appData.settings.showRulesToEmp = checked;
            saveData();
            showToast(`การแสดงกฎให้พนักงาน: ${checked ? 'เปิด' : 'ปิด'}`);
        };


        // --- ACTIONS ---
        // NEW: Function to cancel request
        window.cancelRequest = function (id) {
            const record = appData.history.find(h => h.id === id);
            // Verify ownership and status
            if (record && record.empId === appData.currentUserId && record.status === 'Pending') {
                if (confirm("คุณต้องการยกเลิกคำขอนี้ใช่หรือไม่?")) {
                    appData.history = appData.history.filter(h => h.id !== id);
                    saveData();
                    showToast("ยกเลิกคำขอเรียบร้อยแล้ว");
                    updateUI(); // Refresh UI
                }
            } else {
                showToast("ไม่สามารถยกเลิกรายการนี้ได้");
            }
        };

        window.updateOT = function (empId, otValue) {
            const date = document.getElementById('admDateSelector').value || getTodayStr();
            // Fix: Ensure NaN is converted to 0
            let hours = parseFloat(otValue);
            if (isNaN(hours)) hours = 0;

            // Check if record exists
            const existingIndex = appData.history.findIndex(h => h.empId == empId && h.date === date);

            if (existingIndex !== -1) {
                appData.history[existingIndex].otHours = hours;
            } else {
                // Create Present record with OT
                appData.history.push({
                    id: Date.now() + Math.random(),
                    empId: empId,
                    date: date,
                    type: 11,
                    status: 'Present',
                    deduction: 0,
                    reason: "บันทึก OT อัตโนมัติ",
                    otHours: hours,
                    timestamp: new Date().toISOString()
                });
            }
            saveData();
            showToast(`บันทึก OT ${hours} ชม. เรียบร้อย`);
            renderAdminView(); // Refresh to update total month OT
        };

        // --- ADMIN VIEW ---
        window.switchAdminSubTab = function (mode) {
            const btnYard = document.getElementById('btn-adm-tab-yard');
            const btnAll = document.getElementById('btn-adm-tab-all');
            const viewYard = document.getElementById('adm-view-yard-container');
            const viewAll = document.getElementById('adm-view-all-container');

            if (mode === 'yard') {
                btnYard.classList.add('admin-subtab-active', 'shadow-sm');
                btnYard.classList.remove('admin-subtab-inactive', 'hover:bg-white/50');
                btnAll.classList.add('admin-subtab-inactive', 'hover:bg-white/50');
                btnAll.classList.remove('admin-subtab-active', 'shadow-sm');
                viewYard.classList.remove('hidden');
                viewAll.classList.add('hidden');
            } else {
                btnAll.classList.add('admin-subtab-active', 'shadow-sm');
                btnAll.classList.remove('admin-subtab-inactive', 'hover:bg-white/50');
                btnYard.classList.add('admin-subtab-inactive', 'hover:bg-white/50');
                btnYard.classList.remove('admin-subtab-active', 'shadow-sm');
                viewAll.classList.remove('hidden');
                viewYard.classList.add('hidden');
                renderAdminAllEmployees();
            }
        };

        // NEW: Quick Check Function (Toggle Logic)
        window.quickCheck = function (empId, typeId) {
            const date = document.getElementById('admDateSelector').value || getTodayStr();
            const existingRecord = appData.history.find(h => h.empId == empId && h.date === date);

            // Case 1: Clicked same button -> Undo (Remove record)
            if (existingRecord && existingRecord.type == typeId) {
                // ADDED CONFIRMATION HERE
                if (confirm("คุณต้องการยกเลิกสถานะนี้ใช่หรือไม่?")) {
                    appData.history = appData.history.filter(h => h.id !== existingRecord.id);
                    showToast("ยกเลิกการเช็คชื่อเรียบร้อย");
                }
            }
            // Case 2: Different button or No record -> Save (Overwrite/Add)
            else {
                const rule = appData.leaveRules[typeId];
                let status = 'Present';
                if (typeId === 8) status = 'Penalty';
                // Note: saveAttendanceRecord already handles removing old records for the same day (overwrite logic)
                saveAttendanceRecord(empId, date, typeId, rule.deduction, "เช็คชื่อหน้างาน", status);
                showToast("บันทึกเรียบร้อย");
            }

            saveData();
            renderAdminView(); // Re-render to show active state
        };

        // NEW: Edit Check-In Time Logic
        window.editCheckInTime = function (recordId) {
            const pin = prompt("กรุณาใส่รหัส Admin เพื่อแก้ไขเวลา:");
            if (pin !== ADMIN_PIN) {
                if (pin !== null) alert("รหัสผ่านไม่ถูกต้อง");
                return;
            }

            const record = appData.history.find(h => h.id === recordId);
            if (!record) return;

            let defaultTime = "08:30";
            if (record.timestamp) {
                const d = new Date(record.timestamp);
                defaultTime = `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
            }

            const newTime = prompt("แก้ไขเวลา (HH:mm):", defaultTime);
            if (!newTime) return;

            const timeParts = newTime.split(':');
            if (timeParts.length !== 2) { alert("รูปแบบเวลาไม่ถูกต้อง"); return; }

            const h = parseInt(timeParts[0]);
            const m = parseInt(timeParts[1]);

            if (isNaN(h) || isNaN(m)) { alert("เวลาต้องเป็นตัวเลข"); return; }

            // Construct new date based on the record's date
            const dateParts = record.date.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
            const day = parseInt(dateParts[2]);

            const newDate = new Date(year, month, day, h, m);

            record.timestamp = newDate.toISOString();
            // Also update formatted string for display consistency if needed
            record.checkInTime = newTime;

            saveData();
            showToast(`แก้ไขเวลาเป็น ${newTime} น. เรียบร้อย`);
            renderAdminView();
        }

        window.renderAdminView = function () {
            // Apply Staff Restrictions
            const isStaff = session.role === 'staff';

            // Toggle visibility based on Role
            const toggleEl = (id, show) => {
                const el = document.getElementById(id);
                if (el) el.style.display = show ? 'block' : 'none';
                else if (el) el.style.display = 'flex'; // Handle flex buttons potentially
            };

            // Elements to HIDE for Staff
            const staffHiddenIds = [
                'btn-add-emp',
                'btn-import-excel',
                'btn-export-yard',
                'btn-manage-holidays',
                'btn-settings',
                'penalty-box-container',
                'btn-export-all' // From All Employees view
            ];

            staffHiddenIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (isStaff) el.classList.add('hidden');
                    else el.classList.remove('hidden');
                }
            });


            const siteSelect = document.getElementById('adminSiteSelector');
            if (!siteSelect.innerHTML) {
                appData.locations.forEach(loc => {
                    const opt = document.createElement('option');
                    // Support object structure
                    const val = typeof loc === 'object' ? loc.name : loc;
                    opt.value = val;
                    opt.text = val;
                    siteSelect.appendChild(opt);
                });
                siteSelect.value = appData.adminSelectedSite;
            } else appData.adminSelectedSite = siteSelect.value;

            // Show Start Time for selected Yard
            const currentYardObj = appData.locations.find(l => l.name === appData.adminSelectedSite);
            const startTimeDisplay = currentYardObj ? currentYardObj.startTime : "08:30";
            document.getElementById('admin-yard-time-display').innerText = `เวลาเข้างาน: ${startTimeDisplay} น.`;

            // Date Selection Logic (Auto-set if empty)
            const dateInput = document.getElementById('admDateSelector');
            if (!dateInput.value) {
                dateInput.value = getTodayStr();
            }
            const selectedDate = dateInput.value;
            const selectedDateObj = new Date(selectedDate);
            const currentMonth = selectedDateObj.getMonth();
            const currentYear = selectedDateObj.getFullYear();

            const siteEmps = appData.employees.filter(e => e.location === appData.adminSelectedSite);
            const tbody = document.getElementById('adm-employee-list');
            tbody.innerHTML = '';

            let presentCount = 0;
            let absentCount = 0;

            siteEmps.forEach(e => {
                // Get Daily Record
                const dailyRecords = appData.history.filter(h => h.empId == e.id && h.date === selectedDate);
                const status = dailyRecords[dailyRecords.length - 1];

                // Calculate Monthly OT
                let monthlyOT = 0;
                appData.history.forEach(h => {
                    if (h.empId == e.id && h.otHours) {
                        const d = new Date(h.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            monthlyOT += parseFloat(h.otHours);
                        }
                    }
                });

                // Count Stats
                if (status) {
                    const type = parseInt(status.type);
                    if (type === 11 || type === 6 || type === 7) presentCount++;
                    else absentCount++;
                }

                const otValue = (status && status.otHours) ? status.otHours : '';

                // Determine button states
                const isMa = status && status.type == 11;
                const isSai = status && (status.type == 6 || status.type == 7);
                const isKhad = status && status.type == 8;

                // Format Timestamp Display
                let timestampDisplay = "-";
                let recordId = null;
                if (status && status.timestamp) {
                    const d = new Date(status.timestamp);
                    timestampDisplay = `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')} น.`;
                    recordId = status.id;
                }

                // Render Name with Nickname
                const nameDisplay = `${e.name} <span class="text-slate-500 font-normal text-xs">(${e.nickname || '-'})</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" name="yardSelect" value="${e.id}"></td>
                    <td class="p-4">
                        <div class="flex items-center justify-between gap-4">
                            <div>
                                <div class="font-bold text-slate-800 cursor-pointer hover:text-blue-600 transition" onclick="openManageHistory(${e.id})" title="คลิกเพื่อดูประวัติ">${nameDisplay}</div>
                                <div class="text-[10px] text-slate-400">${e.code} | ${e.position || '-'}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="quickCheck(${e.id}, 11)" class="w-8 h-8 rounded-full border flex items-center justify-center transition ${isMa ? 'bg-green-500 text-white border-green-600 shadow-md scale-110' : 'bg-white text-slate-300 border-slate-200 hover:border-green-400 hover:text-green-500'}" title="มา"><i class="fas fa-check"></i></button>
                                <button onclick="quickCheck(${e.id}, 6)" class="w-8 h-8 rounded-full border flex items-center justify-center transition ${isSai ? 'bg-yellow-400 text-white border-yellow-500 shadow-md scale-110' : 'bg-white text-slate-300 border-slate-200 hover:border-yellow-400 hover:text-yellow-500'}" title="สาย"><i class="fas fa-clock"></i></button>
                                <button onclick="quickCheck(${e.id}, 8)" class="w-8 h-8 rounded-full border flex items-center justify-center transition ${isKhad ? 'bg-red-500 text-white border-red-600 shadow-md scale-110' : 'bg-white text-slate-300 border-slate-200 hover:border-red-400 hover:text-red-500'}" title="ขาด"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-center">${status ? `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${status.type == 11 || status.type == 6 || status.type == 7 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${appData.leaveRules[status.type]?.name}</span>` : '<span class="text-slate-300 italic text-[10px]">-</span>'}</td>
                    <td class="p-4 text-center text-xs font-bold text-slate-500 group relative">
                        ${timestampDisplay}
                        ${recordId ? `<button onclick="editCheckInTime(${recordId})" class="ml-2 text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" title="แก้ไขเวลา"><i class="fas fa-edit"></i></button>` : ''}
                    </td>
                    <td class="p-4 text-center">
                        <input type="number" step="0.5" class="w-16 text-center border rounded bg-blue-50 text-blue-700 font-bold focus:ring-2 focus:ring-blue-500" value="${otValue}" onchange="updateOT(${e.id}, this.value)" placeholder="-">
                    </td>
                    <td class="p-4 text-center font-black text-slate-700">${monthlyOT > 0 ? monthlyOT : '-'}</td>
                    <td class="p-4 text-center">
                        <button onclick="openCalendarModal(${e.id})" class="text-purple-500 hover:text-purple-700 bg-purple-50 p-2 rounded-lg transition"><i class="fas fa-calendar-alt"></i></button>
                    </td>
                    <td class="p-4 text-right flex gap-1 justify-end">
                        <button onclick="openAdminYardDetail('all')" class="bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 mr-1"><i class="fas fa-list"></i></button>
                        <button onclick="openManageHistory(${e.id})" class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600">ประวัติ</button>
                        ${!isStaff ? `<button onclick="deleteEmployee(${e.id})" class="text-slate-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('adm-stats-total').innerText = siteEmps.length;
            document.getElementById('adm-stats-absent').innerText = absentCount;
            document.getElementById('adm-stats-present').innerText = presentCount;
            document.getElementById('adm-list-title').innerText = `รายชื่อพนักงาน (${new Date(selectedDate).toLocaleDateString('th-TH')})`;

            const pSelect = document.getElementById('penaltyEmpSelect');
            pSelect.innerHTML = ''; siteEmps.forEach(e => { const opt = document.createElement('option'); opt.value = e.id; opt.text = e.name; pSelect.appendChild(opt); });
            const ptSelect = document.getElementById('penaltyType');
            ptSelect.innerHTML = ''; Object.entries(appData.leaveRules).forEach(([k, v]) => { if (k != 11) { const opt = document.createElement('option'); opt.value = k; opt.text = v.name; ptSelect.appendChild(opt); } });
        }

        // Updated for Credential Management
        window.updateEmpCredential = (id, field, value) => {
            const emp = appData.employees.find(e => e.id === id);
            if (emp) {
                emp[field] = value.trim();
                saveData();
                // Optional: showToast('บันทึกข้อมูลแล้ว') if you want frequent feedback, but might be annoying while typing
            }
        };

        window.renderAdminAllEmployees = function () {
            const tbody = document.getElementById('adm-all-employee-list');
            const search = document.getElementById('allEmpSearch').value.toLowerCase();
            tbody.innerHTML = '';

            // Get selected month/year for OT calculation
            const dateInput = document.getElementById('admDateSelector').value || getTodayStr();
            const dateObj = new Date(dateInput);
            const currentMonth = dateObj.getMonth();
            const currentYear = dateObj.getFullYear();

            appData.employees.forEach(e => {
                if (e.name.toLowerCase().includes(search) || e.code.toLowerCase().includes(search)) {
                    // Calculate Monthly OT
                    let monthlyOT = 0;
                    appData.history.forEach(h => {
                        if (h.empId == e.id && h.otHours) {
                            const d = new Date(h.date);
                            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                                monthlyOT += parseFloat(h.otHours);
                            }
                        }
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-4"><input type="checkbox" name="allEmpSelect" value="${e.id}"></td>
                        <td class="p-4"><div class="font-bold text-slate-800 cursor-pointer hover:text-blue-600" onclick="openManageHistory(${e.id})">${e.name}</div><div class="text-[10px] text-slate-400">${e.code}</div></td>
                        <td class="p-4 text-slate-600"><div class="text-xs">${e.position || '-'}</div><div class="text-[9px] bg-slate-100 inline-block px-1 rounded">${e.location}</div></td>
                        
                        <!-- Added Nickname Input -->
                        <td class="p-4 text-center">
                            <input type="text" value="${e.nickname || ''}" onchange="updateEmpCredential(${e.id}, 'nickname', this.value)" placeholder="ชื่อเล่น" class="w-20 text-xs border border-slate-200 rounded px-2 py-1 bg-slate-50 focus:bg-white transition text-center text-slate-700 font-bold">
                        </td>

                        <!-- Credential Inputs -->
                        <td class="p-4 text-center">
                            <input type="text" value="${e.username || ''}" onchange="updateEmpCredential(${e.id}, 'username', this.value)" placeholder="Username" class="w-24 text-xs border border-slate-200 rounded px-2 py-1 bg-blue-50/50 focus:bg-white transition text-center text-blue-600 font-bold">
                        </td>
                        <td class="p-4 text-center">
                            <input type="text" value="${e.password || ''}" onchange="updateEmpCredential(${e.id}, 'password', this.value)" placeholder="Password" class="w-24 text-xs border border-slate-200 rounded px-2 py-1 bg-red-50/50 focus:bg-white transition text-center text-red-600 font-bold">
                        </td>

                        <td class="p-4 text-center">
                            <button onclick="openCalendarModal(${e.id})" class="text-purple-500 hover:text-purple-700 bg-purple-50 p-2 rounded-lg transition"><i class="fas fa-calendar-alt"></i></button>
                        </td>
                        <td class="p-4 text-center font-black text-slate-700">${e.score}</td>
                        <td class="p-4 text-right">
                            <button onclick="openManageHistory(${e.id})" class="text-slate-400 hover:text-blue-600"><i class="fas fa-search"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        };

        window.toggleSelectAllAll = function (source) {
            const boxes = document.getElementsByName('allEmpSelect');
            boxes.forEach(b => b.checked = source.checked);
        };

        // --- HOLIDAYS LOGIC (NEW) ---
        window.openManageHolidaysModal = function () {
            // Render Weekly
            const checkboxes = document.getElementsByName('weeklyHoliday');
            checkboxes.forEach(cb => {
                cb.checked = appData.holidays.weekly.includes(parseInt(cb.value));
            });

            // Render Annual
            renderAnnualHolidaysList();

            openModal('manageHolidaysModal');
        };

        window.saveHolidays = function () {
            // Save Weekly
            const checkboxes = document.getElementsByName('weeklyHoliday');
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) selected.push(parseInt(cb.value));
            });
            appData.holidays.weekly = selected;
            saveData();
            // Note: Annual are saved immediately on add/delete
        };

        window.addAnnualHoliday = function () {
            const date = document.getElementById('newHolidayDate').value;
            const name = document.getElementById('newHolidayName').value;

            if (!date || !name) { showToast("กรุณากรอกวันที่และชื่อวันหยุด"); return; }

            if (appData.holidays.annual.some(h => h.date === date)) {
                showToast("วันนี้ถูกเพิ่มไปแล้ว");
                return;
            }

            appData.holidays.annual.push({ date, name });
            // Sort by date
            appData.holidays.annual.sort((a, b) => a.date.localeCompare(b.date));

            saveData();
            renderAnnualHolidaysList();
            document.getElementById('newHolidayDate').value = '';
            document.getElementById('newHolidayName').value = '';
            showToast("เพิ่มวันหยุดเรียบร้อย");
        };

        window.deleteAnnualHoliday = function (date) {
            if (confirm("ต้องการลบวันหยุดนี้?")) {
                appData.holidays.annual = appData.holidays.annual.filter(h => h.date !== date);
                saveData();
                renderAnnualHolidaysList();
            }
        };

        window.renderAnnualHolidaysList = function () {
            const tbody = document.getElementById('annualHolidaysList');
            tbody.innerHTML = '';

            if (appData.holidays.annual.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-xs">ยังไม่มีวันหยุดประจำปี</td></tr>';
                return;
            }

            appData.holidays.annual.forEach(h => {
                tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition">
                        <td class="p-3 pl-4 font-bold text-slate-700">${new Date(h.date).toLocaleDateString('th-TH')}</td>
                        <td class="p-3 text-slate-600">${h.name}</td>
                        <td class="p-3 text-right pr-4">
                            <button onclick="deleteAnnualHoliday('${h.date}')" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
        };


        // --- NEW: MANAGE YARDS LOGIC ---
        window.openManageYardsModal = function () {
            renderYardsList();
            openModal('manageYardsModal');
        };

        window.renderYardsList = function () {
            const tbody = document.getElementById('yardsTableBody');
            tbody.innerHTML = '';
            appData.locations.forEach(loc => {
                // Ensure loc is object
                const name = typeof loc === 'object' ? loc.name : loc;
                const time = typeof loc === 'object' ? loc.startTime : "08:30";

                tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50">
                        <td class="p-2 font-bold text-slate-700 text-xs">${name}</td>
                        <td class="p-2 text-center">
                            <input type="time" value="${time}" onchange="updateYardTime('${name}', this.value)" class="border border-slate-200 rounded px-2 py-1 text-xs font-bold text-center bg-white focus:ring-2 focus:ring-blue-500">
                        </td>
                        <td class="p-2 text-right">
                            <button onclick="deleteYard('${name}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.addYard = function () {
            const name = document.getElementById('newYardName').value.trim();
            const time = document.getElementById('newYardTime').value;

            if (!name) { showToast("กรุณากรอกชื่อสถานที่"); return; }

            // Check duplicates
            const exists = appData.locations.some(l => (typeof l === 'object' ? l.name : l) === name);
            if (exists) { showToast("มีสถานที่นี้อยู่แล้ว"); return; }

            appData.locations.push({ name: name, startTime: time });
            saveData();

            document.getElementById('newYardName').value = '';
            renderYardsList();

            // Update Selectors
            const siteSelect = document.getElementById('adminSiteSelector');
            siteSelect.innerHTML = ''; // Force redraw next time
            if (siteSelect) renderAdminView();

            showToast("เพิ่มสถานที่เรียบร้อย");
        };

        window.deleteYard = function (name) {
            if (confirm(`ยืนยันการลบสถานที่ "${name}"?\n(พนักงานในสังกัดนี้จะยังคงอยู่ แต่ชื่อสถานที่อาจหายไปจากตัวเลือก)`)) {
                appData.locations = appData.locations.filter(l => (typeof l === 'object' ? l.name : l) !== name);
                saveData();
                renderYardsList();
                // Update Selectors
                const siteSelect = document.getElementById('adminSiteSelector');
                siteSelect.innerHTML = '';
                if (siteSelect) renderAdminView();
            }
        };

        window.updateYardTime = function (name, newTime) {
            const idx = appData.locations.findIndex(l => (typeof l === 'object' ? l.name : l) === name);
            if (idx !== -1) {
                appData.locations[idx] = { name: name, startTime: newTime };
                saveData();
                showToast(`อัปเดตเวลาเข้างานของ ${name} เป็น ${newTime} น.`);

                // Refresh views if this yard is selected
                if (appData.adminSelectedSite === name) {
                    document.getElementById('admin-yard-time-display').innerText = `เวลาเข้างาน: ${newTime} น.`;
                }
            }
        };


        // --- CALENDAR LOGIC (UPDATED) ---
        window.openCalendarModal = function (empId) {
            calendarTargetEmpId = empId || appData.currentUserId; // Default to current user
            calendarCurrentDate = new Date();
            renderCalendar();
            openModal('calendarModal');
        };

        window.changeCalendarMonth = function (delta) {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + delta);
            renderCalendar();
        };

        window.renderCalendar = function () {
            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();

            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            document.getElementById('calMonthYear').innerText = `${monthNames[month]} ${year + 543}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // ช่องว่างก่อนวันเริ่มเดือน
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div></div>`;
            }

            // วนลูปสร้างวันที่ 1 ถึงสิ้นเดือน
            for (let d = 1; d <= daysInMonth; d++) {
                // 1. สร้างตัวแปร "เวลาของลูปปัจจุบัน" (บังคับเวลาเป็น 00:00:00 เพื่อความชัวร์)
                const loopDate = new Date(year, month, d);
                loopDate.setHours(0, 0, 0, 0);
                const loopTime = loopDate.getTime(); // แปลงเป็นตัวเลข milliseconds

                // 2. Filter ข้อมูล (ใช้ Logic เดียวกับ Admin แต่ครอบคลุมช่วงวัน)
                const dailyRecords = appData.history.filter(h => {
                    // เช็คว่าเป็นของพนักงานคนนี้ไหม
                    if (h.empId != calendarTargetEmpId) return false;
                    // ไม่เอาสถานะที่ถูกปฏิเสธ
                    if (h.status === 'Rejected') return false;

                    // แปลงวันที่เริ่ม (Start) จาก Database เป็น Time
                    // ข้อดี: new Date("2026-1-6") และ new Date("2026-01-06") จะได้ค่าเวลาเท่ากันเป๊ะ!
                    const startDate = new Date(h.date);
                    startDate.setHours(0, 0, 0, 0);

                    // แปลงวันที่สิ้นสุด (End) - ถ้าไม่มีให้ใช้วันเดียวกับ Start
                    const endDate = h.endDate ? new Date(h.endDate) : new Date(h.date);
                    endDate.setHours(0, 0, 0, 0);

                    // เปรียบเทียบตัวเลข: เวลาในปฏิทิน ต้องอยู่ระหว่าง เริ่มต้น และ สิ้นสุด
                    return loopTime >= startDate.getTime() && loopTime <= endDate.getTime();
                });

                // 3. เรียงลำดับเอาตัว "ล่าสุด" (Timestamp มากสุด) ขึ้นก่อน (เพื่อให้เหมือนหน้า Admin)
                dailyRecords.sort((a, b) => {
                    const tA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                    const tB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                    return tB - tA;
                });

                // 4. เลือกตัวแรก (ตัวล่าสุด)
                const record = dailyRecords.length > 0 ? dailyRecords[0] : null;

                // --- ส่วนแสดงผล (เหมือนเดิม) ---
                // ตรวจสอบวันหยุด
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayOfWeek = new Date(year, month, d).getDay();
                const isWeeklyHoliday = appData.holidays.weekly.includes(dayOfWeek);
                const annualHoliday = appData.holidays.annual.find(h => h.date === dateStr);

                let bgClass = "bg-slate-50";
                let textClass = "text-slate-700";
                let badge = "";

                if (annualHoliday) {
                    bgClass = "bg-purple-100 border border-purple-200";
                    textClass = "text-purple-700";
                    badge = `<div class="absolute bottom-1 left-1 text-[8px] text-purple-600 font-bold truncate max-w-full">${annualHoliday.name}</div>`;
                } else if (isWeeklyHoliday) {
                    bgClass = "bg-slate-100 border border-slate-200";
                    textClass = "text-slate-400";
                    badge = `<div class="absolute bottom-1 left-1 text-[8px] text-slate-400 font-bold">หยุด</div>`;
                }

                if (record) {
                    const type = parseInt(record.type);
                    const rule = appData.leaveRules[type];
                    // แก้ไข: เช็คว่าเป็นวันลาหรือไม่ (รวมถึงที่สร้างใหม่และหัก 0 คะแนน)
                    const isLeave = (type <= 5) || (rule && rule.category === 'leave');
                    const isPenalty = (type === 8 || record.status === 'Penalty' || (rule && rule.category === 'penalty'));

                    if (type === 11) { bgClass = "bg-green-100 border border-green-200"; textClass = "text-green-700"; badge = ""; }
                    else if (type === 6 || type === 7) { bgClass = "bg-yellow-100 border border-yellow-200"; textClass = "text-yellow-700"; badge = ""; }
                    else if (isPenalty) { bgClass = "bg-red-100 border border-red-200"; textClass = "text-red-700"; badge = ""; }
                    else if (isLeave) { bgClass = "bg-blue-50 border border-blue-200"; textClass = "text-blue-700"; badge = ""; }

                    if (record.otHours > 0) {
                        badge += `<div class="absolute bottom-1 right-1 bg-blue-500 text-white text-[8px] px-1 rounded-full shadow font-bold">OT ${record.otHours}</div>`;
                    }
                    if (record.deduction > 0) {
                        badge += `<div class="absolute top-1 right-1 bg-red-500 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full shadow font-bold">-${record.deduction}</div>`;
                    }
                }

                let timeDisplay = "";
                if (record && record.timestamp) {
                    const type = parseInt(record.type);
                    if (type === 11 || type === 6 || type === 7) {
                        const dObj = new Date(record.timestamp);
                        timeDisplay = `<div class="text-[9px] font-bold text-slate-500 mt-1">${dObj.getHours().toString().padStart(2, '0')}:${dObj.getMinutes().toString().padStart(2, '0')}</div>`;
                    }
                }

                grid.innerHTML += `
                    <div onclick="openDateDetail('${dateStr}')" class="h-20 ${bgClass} rounded-xl p-1 relative flex flex-col justify-between transition hover:scale-105 cursor-pointer shadow-sm overflow-hidden ring-2 ring-transparent hover:ring-blue-200" title="คลิกดูรายละเอียด">
                        <span class="${textClass} text-sm font-bold ml-1">${d}</span>
                        ${record ? `<span class="text-[9px] ${textClass} leading-tight truncate px-1 font-medium z-10">${appData.leaveRules[record.type]?.name || 'N/A'}</span>` : ''}
                        ${timeDisplay}
                        ${badge}
                    </div>
                `;
            }
        };

        window.openDateDetail = function (dateStr) {
            // 1. ดึงข้อมูล
            // หาประวัติของพนักงานคนนี้ ในวันที่เลือก
            const record = appData.history.find(h =>
                h.empId == calendarTargetEmpId &&
                h.date === dateStr &&
                h.status !== 'Rejected'
            );

            // หาข้อมูลวันหยุด
            const dateObj = new Date(dateStr);
            const dayOfWeek = dateObj.getDay();
            const isWeeklyHoliday = appData.holidays.weekly.includes(dayOfWeek);
            const annualHoliday = appData.holidays.annual.find(h => h.date === dateStr);

            // 2. เตรียมข้อมูลแสดงผล
            const dateDisplay = dateObj.toLocaleDateString('th-TH', { dateStyle: 'full' });
            document.getElementById('dd-date-display').innerText = dateDisplay;

            const elHeader = document.getElementById('dd-header-bg');
            const elTitle = document.getElementById('dd-status-title');
            const elTime = document.getElementById('dd-time-display');
            const elOt = document.getElementById('dd-ot-display');
            const elReason = document.getElementById('dd-reason-display');
            const elDedBox = document.getElementById('dd-deduction-box');
            const elDedVal = document.getElementById('dd-deduction-val');

            // Reset ค่า
            elDedBox.classList.add('hidden');
            elTime.innerText = "-";
            elOt.innerText = "ไม่มี";
            elReason.innerText = "-";

            // 3. กำหนดสีและข้อความตามสถานะ
            if (record) {
                const type = parseInt(record.type);
                const ruleName = appData.leaveRules[type]?.name || 'บันทึกพิเศษ';
                elTitle.innerText = ruleName;
                elReason.innerText = record.reason || "-";

                // จัดการสีพื้นหลัง Header
                if (type === 11) { // มาทำงาน
                    elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-green-500 to-green-600";
                } else if (type === 6 || type === 7) { // สาย
                    elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-yellow-400 to-yellow-500";
                } else if (type === 8 || type === 99) { // ขาด/โทษ
                    elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-red-500 to-red-600";
                } else { // ลา
                    elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-500 to-blue-600";
                }

                // แสดงเวลา
                if (record.timestamp) {
                    const t = new Date(record.timestamp);
                    elTime.innerText = `${t.getHours().toString().padStart(2, '0')}:${t.getMinutes().toString().padStart(2, '0')} น.`;
                } else if (record.checkInTime) {
                    elTime.innerText = record.checkInTime + " น.";
                }

                // แสดง OT
                if (record.otHours > 0) {
                    elOt.innerText = `${record.otHours} ชั่วโมง`;
                    elOt.className = "font-black text-blue-600 text-lg";
                } else {
                    elOt.className = "font-bold text-slate-800 text-lg";
                }

                // แสดงการหักคะแนน
                if (record.deduction > 0) {
                    elDedBox.classList.remove('hidden');
                    elDedVal.innerText = `-${record.deduction}`;
                }

            } else if (annualHoliday) {
                // วันหยุดนักขัตฤกษ์
                elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-purple-500 to-purple-600";
                elTitle.innerText = "วันหยุดพิเศษ";
                elReason.innerText = annualHoliday.name;
            } else if (isWeeklyHoliday) {
                // วันหยุดประจำสัปดาห์
                elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-slate-400 to-slate-500";
                elTitle.innerText = "วันหยุดประจำสัปดาห์";
                elReason.innerText = "พักผ่อน";
            } else {
                // วันธรรมดาที่ไม่มีบันทึก
                elHeader.className = "absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-slate-200 to-slate-300";
                elTitle.innerText = "ไม่มีบันทึก";
                elTitle.classList.add('text-slate-500'); // ปรับสีตัวหนังสือหน่อยเพราะพื้นหลังอ่อน
                elReason.innerText = "ยังไม่มีข้อมูลการลงเวลา";

                // แก้สีตัวหนังสือกลับถ้าเป็นเคสปกติ
                setTimeout(() => elTitle.classList.remove('text-slate-500'), 200);
            }

            openModal('dateDetailModal');
        };

        // --- NEW: Export Logic with Date Selection ---
        let currentExportContext = 'yard'; // 'yard' or 'all'
        let currentExportMode = 'monthly'; // 'monthly' or 'yearly'

        window.openExportModal = function (context) {
            currentExportContext = context;
            const today = new Date();

            // Set defaults
            document.getElementById('exportMonthSelect').value = today.getMonth();
            document.getElementById('exportYearInput').value = today.getFullYear() + 543;

            // Default to monthly
            toggleExportMode('monthly');
            openModal('exportOptionsModal');
        };

        window.toggleExportMode = function (mode) {
            currentExportMode = mode;
            const btnMonthly = document.getElementById('btn-export-monthly');
            const btnYearly = document.getElementById('btn-export-yearly');
            const monthWrapper = document.getElementById('export-month-wrapper');

            if (mode === 'monthly') {
                btnMonthly.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                btnMonthly.classList.remove('text-slate-500', 'hover:bg-white/50');
                btnYearly.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                btnYearly.classList.add('text-slate-500', 'hover:bg-white/50');
                monthWrapper.classList.remove('hidden');
            } else {
                btnYearly.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                btnYearly.classList.remove('text-slate-500', 'hover:bg-white/50');
                btnMonthly.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                btnMonthly.classList.add('text-slate-500', 'hover:bg-white/50');
                monthWrapper.classList.add('hidden');
            }
        };

        window.confirmExport = function () {
            const month = parseInt(document.getElementById('exportMonthSelect').value);
            const yearTH = parseInt(document.getElementById('exportYearInput').value);
            const yearAD = yearTH - 543; // Convert to AD for comparison

            if (isNaN(yearAD)) { showToast("กรุณาระบุปีให้ถูกต้อง"); return; }

            if (currentExportContext === 'yard') {
                exportYardReport(currentExportMode, month, yearAD);
            } else {
                exportAllEmployeesReport(currentExportMode, month, yearAD);
            }
            closeModal('exportOptionsModal');
        };

        // --- NEW: Open Score Details Modal ---
        window.openScoreDetail = function (type) {
            const empId = appData.currentUserId;
            const currentYear = new Date().getFullYear();
            let title = "";
            let records = [];
            let iconClass = "";

            if (type === 'leave') {
                title = "ประวัติการลา (ปีนี้)";
                iconClass = "fa-file-alt text-blue-500";
                // Filter Leave: Type <= 5 OR category='leave', Approved or Pending
                records = appData.history.filter(h => {
                    const hYear = new Date(h.date).getFullYear();
                    const rule = appData.leaveRules[h.type];
                    const isLeave = (parseInt(h.type) <= 5) || (rule && rule.category === 'leave');
                    return h.empId == empId && isLeave && (h.status === 'Approved' || h.status === 'Pending') && hYear === currentYear;
                });
            } else {
                title = "ประวัติสาย/ขาด/โทษ (ปีนี้)";
                iconClass = "fa-exclamation-triangle text-red-500";
                // Filter Penalty: Type 6,7,8 or Status 'Penalty' or category='penalty'
                records = appData.history.filter(h => {
                    const hYear = new Date(h.date).getFullYear();
                    const typeId = parseInt(h.type);
                    const rule = appData.leaveRules[typeId];
                    const isPenalty = (typeId === 6 || typeId === 7 || typeId === 8 || h.status === 'Penalty' || (rule && rule.category === 'penalty'));
                    return h.empId == empId && isPenalty && hYear === currentYear;
                });
            }

            // Sort Descending (Newest first)
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            const listContainer = document.getElementById('scoreDetailList');
            listContainer.innerHTML = '';

            document.getElementById('scoreDetailTitle').innerHTML = `<i class="fas ${iconClass}"></i> ${title}`;

            if (records.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-slate-400 flex flex-col items-center">
                        <i class="far fa-folder-open text-3xl mb-2 opacity-50"></i>
                        <span class="text-sm">ไม่มีประวัติรายการนี้</span>
                    </div>`;
            } else {
                records.forEach(r => {
                    const dateObj = new Date(r.date);
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                    const ruleName = appData.leaveRules[r.type]?.name || 'พิเศษ';

                    // Deduction Badge
                    let dedBadge = '';
                    if (r.deduction > 0) {
                        dedBadge = `<span class="bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded-full font-bold">-${r.deduction} คะแนน</span>`;
                    } else {
                        dedBadge = `<span class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold">ไม่หัก</span>`;
                    }

                    // Status Text
                    let statusText = '';
                    if (r.status === 'Pending') statusText = '<span class="text-yellow-500 text-[9px] font-bold"><i class="fas fa-clock"></i> รออนุมัติ</span>';
                    else if (r.status === 'Approved') statusText = '<span class="text-green-500 text-[9px] font-bold"><i class="fas fa-check"></i> อนุมัติ</span>';
                    else if (r.status === 'Penalty') statusText = '<span class="text-red-500 text-[9px] font-bold"><i class="fas fa-gavel"></i> บทลงโทษ</span>';

                    // --- NEW: Calculate specific dates for display ---
                    let dateListHtml = "";
                    if (r.endDate && r.endDate !== r.date) {
                        let dList = [];
                        let cDate = new Date(r.date);
                        let eDate = new Date(r.endDate);
                        while (cDate <= eDate) {
                            const dow = cDate.getDay();
                            const dS = cDate.toISOString().split('T')[0];
                            const isWeekly = appData.holidays.weekly.includes(dow);
                            const isAnnual = appData.holidays.annual.some(h => h.date === dS);

                            if (!isWeekly && !isAnnual) {
                                dList.push(cDate.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }));
                            }
                            cDate.setDate(cDate.getDate() + 1);
                        }
                        if (dList.length > 0) {
                            dateListHtml = `<div class="text-[10px] text-indigo-500 font-bold mt-1 bg-indigo-50 inline-block px-2 py-1 rounded-lg border border-indigo-100"><i class="fas fa-calendar-day mr-1"></i>ระบุวัน: ${dList.join(', ')}</div>`;
                        }
                    }
                    // -----------------------------------------------

                    listContainer.innerHTML += `
                        <div class="bg-slate-50 border border-slate-100 p-3 rounded-xl flex flex-col gap-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="bg-white border border-slate-200 text-slate-600 px-2 py-0.5 rounded text-xs font-bold font-mono">${dateStr}</span>
                                        <span class="font-bold text-slate-800 text-sm">${ruleName}</span>
                                    </div>
                                    ${dateListHtml}
                                    <div class="text-xs text-slate-500 mt-1 pl-1 italic">"${r.reason || '-'}"</div>
                                </div>
                                <div class="text-right flex flex-col items-end gap-1">
                                    ${dedBadge}
                                    ${statusText}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            openModal('scoreDetailModal');
        };

        // --- UPDATED: EXPORT ALL EMPLOYEES REPORT ---
        window.exportAllEmployeesReport = function (mode, selectedMonth, selectedYear) {
            const wb = XLSX.utils.book_new();

            // Logic to filter history
            const filterHistory = (history) => {
                return history.filter(h => {
                    const d = new Date(h.date);
                    if (mode === 'monthly') {
                        return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;
                    } else {
                        return d.getFullYear() === selectedYear;
                    }
                });
            };

            const periodText = mode === 'monthly'
                ? `เดือน_${selectedMonth + 1}_ปี_${selectedYear + 543}`
                : `ประจำปี_${selectedYear + 543}`;

            // 1. Summary Sheet
            const summaryData = appData.employees.map(emp => {
                const history = filterHistory(appData.history.filter(h => h.empId === emp.id));

                const late = history.filter(h => h.type === 6 || h.type === 7).length;
                const absent = history.filter(h => h.type === 8).length;

                // แก้ไข: นับรวมการลาทุกประเภทสำหรับ Export
                const leave = history.filter(h => {
                    const rule = appData.leaveRules[h.type];
                    const isLeave = (h.type <= 5) || (rule && rule.category === 'leave');
                    return isLeave && h.status === 'Approved';
                }).length;

                const penalty = history.filter(h => h.status === 'Penalty' && h.type !== 8).length;
                const totalOT = history.reduce((sum, h) => sum + (parseFloat(h.otHours) || 0), 0);

                return {
                    "รหัส": emp.code,
                    "ชื่อ-นามสกุล": emp.name,
                    "ชื่อเล่น": emp.nickname || "-",
                    "ตำแหน่ง": emp.position || "-",
                    "สังกัด": emp.location,
                    "คะแนนคงเหลือ": emp.score,
                    "มาสาย (ครั้ง)": late,
                    "ขาดงาน (ครั้ง)": absent,
                    "ลา (วัน)": leave,
                    "โทษวินัย (ครั้ง)": penalty,
                    "รวม OT (ชม.)": totalOT
                };
            });

            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "สรุปภาพรวม");

            // 2. Individual Sheets
            appData.employees.forEach(emp => {
                const history = filterHistory(appData.history.filter(h => h.empId === emp.id))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const sheetData = history.map(h => ({
                    "วันที่": h.date,
                    "รายการ": appData.leaveRules[h.type]?.name || "พิเศษ",
                    "รายละเอียด": h.reason,
                    "สถานะ": h.status,
                    "หักคะแนน": h.deduction,
                    "OT (ชม.)": h.otHours || 0
                }));

                if (sheetData.length === 0) {
                    sheetData.push({ "หมายเหตุ": "ไม่มีประวัติในช่วงเวลานี้" });
                } else {
                    // Add Summary Row at the bottom
                    const totalOT = history.reduce((sum, h) => sum + (parseFloat(h.otHours) || 0), 0);
                    sheetData.push({}); // Empty row
                    sheetData.push({ "รายการ": ">>> สรุปยอดรวม <<<", "OT (ชม.)": totalOT });
                }

                const wsEmp = XLSX.utils.json_to_sheet(sheetData);
                let sheetName = emp.name.replace(/[\\/?*\[\]]/g, "").substring(0, 30);
                if (wb.SheetNames.includes(sheetName)) {
                    sheetName = (sheetName.substring(0, 25) + "_" + emp.id).substring(0, 30);
                }

                XLSX.utils.book_append_sheet(wb, wsEmp, sheetName);
            });

            XLSX.writeFile(wb, `Report_All_${periodText}.xlsx`);
            showToast("Export ไฟล์เรียบร้อยแล้ว");
        };

        // --- UPDATED: EXPORT YARD REPORT ---
        window.exportYardReport = function (mode, selectedMonth, selectedYear) {
            const currentYard = appData.adminSelectedSite;
            const employees = appData.employees.filter(e => e.location === currentYard);

            if (employees.length === 0) {
                showToast("ไม่มีพนักงานใน Yard นี้");
                return;
            }

            const wb = XLSX.utils.book_new();

            // Logic to filter history
            const filterHistory = (history) => {
                return history.filter(h => {
                    const d = new Date(h.date);
                    if (mode === 'monthly') {
                        return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;
                    } else {
                        return d.getFullYear() === selectedYear;
                    }
                });
            };

            const periodText = mode === 'monthly'
                ? `เดือน_${selectedMonth + 1}_ปี_${selectedYear + 543}`
                : `ประจำปี_${selectedYear + 543}`;

            // 1. Summary Sheet
            const summaryData = employees.map(emp => {
                const history = filterHistory(appData.history.filter(h => h.empId === emp.id));

                const present = history.filter(h => h.type === 11).length;
                const late = history.filter(h => h.type === 6 || h.type === 7).length;
                const absent = history.filter(h => h.type === 8).length;

                // แก้ไข: นับรวมการลาทุกประเภทสำหรับ Export Yard
                const leave = history.filter(h => {
                    const rule = appData.leaveRules[h.type];
                    const isLeave = (h.type <= 5) || (rule && rule.category === 'leave');
                    return isLeave && h.status === 'Approved';
                }).length;

                const totalOT = history.reduce((sum, h) => sum + (parseFloat(h.otHours) || 0), 0);

                return {
                    "รหัส": emp.code,
                    "ชื่อ-นามสกุล": emp.name,
                    "ชื่อเล่น": emp.nickname || "-",
                    "ตำแหน่ง": emp.position || "-",
                    "คะแนนคงเหลือ": emp.score,
                    "มาทำงาน (วัน)": present,
                    "สาย (ครั้ง)": late,
                    "ขาดงาน (ครั้ง)": absent,
                    "ลา (วัน)": leave,
                    "รวม OT (ชม.)": totalOT
                };
            });

            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "ภาพรวม Yard");

            // 2. Individual Sheets
            employees.forEach(emp => {
                const history = filterHistory(appData.history.filter(h => h.empId === emp.id))
                    .sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort Oldest -> Newest for report

                const sheetData = history.map(h => ({
                    "วันที่": h.date,
                    "รายการ": appData.leaveRules[h.type]?.name || "พิเศษ",
                    "รายละเอียด": h.reason,
                    "OT (ชม.)": h.otHours || 0,
                    "หักคะแนน": h.deduction,
                    "สถานะ": h.status
                }));

                if (sheetData.length === 0) {
                    sheetData.push({ "หมายเหตุ": "ไม่มีประวัติในช่วงเวลานี้" });
                } else {
                    const totalOT = history.reduce((sum, h) => sum + (parseFloat(h.otHours) || 0), 0);
                    sheetData.push({});
                    sheetData.push({ "รายการ": ">>> สรุปยอดรวม <<<", "OT (ชม.)": totalOT });
                }

                const wsEmp = XLSX.utils.json_to_sheet(sheetData);
                // Sanitize sheet name to avoid excel errors
                let sheetName = emp.name.replace(/[\\/?*\[\]]/g, "").substring(0, 30);
                if (wb.SheetNames.includes(sheetName)) {
                    sheetName = (sheetName.substring(0, 25) + "_" + emp.id).substring(0, 30);
                }

                XLSX.utils.book_append_sheet(wb, wsEmp, sheetName);
            });

            XLSX.writeFile(wb, `Report_${currentYard}_${periodText}.xlsx`);
            showToast("ส่งออกไฟล์เรียบร้อย");
        }

        window.exportEmployeeReport = function () {
            // Keep this for Manager view (Export All) if needed, or redirect to use same logic
            const wb = XLSX.utils.book_new();
            const summary = appData.employees.map(e => ({
                "รหัส": e.code, "ชื่อ": e.name, "ชื่อเล่น": e.nickname || "-", "ตำแหน่ง": e.position || "-", "Yard": e.location, "คะแนน": e.score
            }));
            const wsSummary = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, wsSummary, "ภาพรวมพนักงาน");
            XLSX.writeFile(wb, `HR_Full_Report_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showToast("ส่งออกไฟล์เรียบร้อย");
        };

        // ---Point Cancellation & History Logic ---
        window.openManageHistory = function (empId) {
            const emp = appData.employees.find(e => e.id == empId);
            if (!emp) return;
            tempEmpId = empId;

            // Add safety checks
            const elName = document.getElementById('mh-emp-name');
            const elCode = document.getElementById('mh-emp-code');
            const elBase = document.getElementById('mh-base-score');
            const list = document.getElementById('mh-history-list');

            if (elName) elName.innerText = `${emp.name} ${emp.nickname ? '(' + emp.nickname + ')' : ''}`;
            if (elCode) elCode.innerText = emp.code;
            if (elBase) elBase.value = emp.baseScore || 30;

            if (list) {
                list.innerHTML = '';
                const history = appData.history.filter(h => h.empId == empId).sort((a, b) => b.timestamp.localeCompare(a.timestamp));

                if (history.length === 0) list.innerHTML = '<p class="text-center text-slate-400 py-8 text-sm">ไม่พบประวัติ</p>';

                history.forEach(h => {
                    const item = document.createElement('div');
                    item.className = "bg-white border border-slate-100 p-4 rounded-xl shadow-sm flex justify-between items-center animate-slide-in";
                    const typeName = appData.leaveRules[h.type]?.name || 'บันทึกพิเศษ';
                    item.innerHTML = `
                        <div>
                            <div class="flex gap-2 items-center"><span class="text-xs font-black text-slate-700">${h.date}</span><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${typeName}</span></div>
                            <p class="text-xs text-slate-400 mt-1">${h.reason}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right"><p class="text-xs font-black text-red-500">-${h.deduction || 0}</p><p class="text-[9px] font-bold text-slate-300 uppercase">${h.status}</p></div>
                            <button onclick="deleteHistoryRecord(${h.id})" class="text-red-300 hover:text-red-500 transition p-2" title="ลบรายการ"><i class="fas fa-times-circle text-lg"></i></button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            openModal('manageHistoryModal');
        };

        // NEW: Function to edit employee name directly from history modal
        window.editCurrentEmpName = function () {
            if (!tempEmpId) return;
            const emp = appData.employees.find(e => e.id == tempEmpId);
            if (!emp) return;

            const newName = prompt("แก้ไขชื่อ-นามสกุล:", emp.name);
            if (newName && newName.trim() !== "") {
                emp.name = newName.trim();
                saveData();

                // Update UI in Modal
                const elName = document.getElementById('mh-emp-name');
                if (elName) elName.innerText = `${emp.name} ${emp.nickname ? '(' + emp.nickname + ')' : ''}`;

                showToast("แก้ไขชื่อเรียบร้อยแล้ว");

                // Refresh Background Lists
                if (!document.getElementById('view-admin').classList.contains('hidden')) {
                    renderAdminView();
                    renderAdminAllEmployees();
                }
                if (!document.getElementById('view-manager').classList.contains('hidden')) {
                    renderManagerView();
                }
            }
        };

        window.updateBaseScore = function () {
            const val = parseInt(document.getElementById('mh-base-score').value);
            const emp = appData.employees.find(e => e.id == tempEmpId);
            if (emp) { emp.baseScore = val; saveData(); showToast("อัปเดตคะแนนพื้นฐานสำเร็จ"); updateUI(); }
        };

        window.deleteHistoryRecord = function (hid) {
            const pin = prompt("กรุณาใส่รหัส Admin เพื่อยืนยันการลบรายการ:");
            if (pin === ADMIN_PIN) {
                if (confirm("ยืนยันการลบรายการนี้? คะแนนจะถูกคืนกลับให้พนักงาน")) {
                    appData.history = appData.history.filter(h => h.id != hid);
                    saveData();
                    showToast("ลบรายการเรียบร้อยแล้ว");
                    openManageHistory(tempEmpId);
                    updateUI();
                }
            } else if (pin !== null) {
                alert("รหัสผ่านไม่ถูกต้อง! ไม่สามารถลบรายการได้");
            }
        };

        // --- NEW: Global Base Score Logic ---
        window.applyGlobalBaseScore = function () {
            const val = parseInt(document.getElementById('globalBaseScoreInput').value);
            if (!val || val < 0) { showToast("กรุณาระบุคะแนนที่ถูกต้อง"); return; }

            if (confirm(`คุณต้องการกำหนดคะแนนตั้งต้นของพนักงานทุกคนเป็น ${val} คะแนน ใช่หรือไม่?`)) {
                appData.employees.forEach(emp => {
                    emp.baseScore = val;
                });
                saveData();
                showToast("ปรับปรุงคะแนนตั้งต้นเรียบร้อย");
                updateUI();
                closeModal('manageRulesModal');
            }
        };

        // --- NEW: Bulk Transfer Logic ---
        window.openBulkTransferModal = function (checkboxName) {
            const checkboxes = document.getElementsByName(checkboxName || 'yardSelect');
            const selected = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);

            if (selected.length === 0) {
                showToast("กรุณาเลือกพนักงานอย่างน้อย 1 คน");
                return;
            }

            document.getElementById('bulkTransferModal').dataset.ids = JSON.stringify(selected);
            document.getElementById('bulkTransferCount').innerText = selected.length;

            const select = document.getElementById('bulkTargetYard');
            select.innerHTML = '';
            appData.locations.forEach(loc => {
                const opt = document.createElement('option');
                const val = typeof loc === 'object' ? loc.name : loc;
                opt.value = val;
                opt.text = val;
                select.appendChild(opt);
            });

            openModal('bulkTransferModal');
        };

        window.confirmBulkTransfer = function () {
            const ids = JSON.parse(document.getElementById('bulkTransferModal').dataset.ids || "[]");
            const target = document.getElementById('bulkTargetYard').value;

            if (!target) return;

            if (confirm(`ยืนยันการย้ายพนักงาน ${ids.length} คน ไปที่ ${target}?`)) {
                ids.forEach(id => {
                    const emp = appData.employees.find(e => e.id == id);
                    if (emp) emp.location = target;
                });
                saveData();
                closeModal('bulkTransferModal');
                renderAdminView();
                renderAdminAllEmployees();
                showToast(`ย้ายพนักงานไปที่ ${target} เรียบร้อยแล้ว`);

                const headerChk = document.getElementById('selectAllYardCheck');
                if (headerChk) headerChk.checked = false;
            }
        };

        // --- HANDLERS ---
        // Helper to save attendance cleanly (Overwrite if exists for that day)
        function saveAttendanceRecord(empId, date, typeId, deduction, reason, status = 'Present') {
            // Remove existing records for this emp on this date to ensure overwrite
            appData.history = appData.history.filter(h => !(h.empId == empId && h.date === date));

            // Add new record
            appData.history.push({
                id: Date.now() + Math.random(),
                empId: empId,
                date: date,
                type: typeId,
                status: status,
                deduction: deduction,
                reason: reason,
                timestamp: new Date().toISOString()
            });
        }

        window.handlePenaltySubmit = function (e) {
            e.preventDefault();
            const empId = Number(document.getElementById('penaltyEmpSelect').value);
            const typeId = parseInt(document.getElementById('penaltyType').value);
            const date = document.getElementById('admDateSelector').value || getTodayStr();
            const rule = appData.leaveRules[typeId];

            saveAttendanceRecord(empId, date, typeId, rule.deduction, "Admin ลงโทษวินัย", 'Penalty');

            saveData();
            showToast("บันทึกโทษสำเร็จ");
            renderAdminView();
        };

        window.handleBulkAttendance = function (typeId) {
            const boxes = document.getElementsByName('yardSelect');
            const today = document.getElementById('admDateSelector').value || getTodayStr();
            const rule = appData.leaveRules[typeId];
            let updateCount = 0;

            let status = 'Present';
            if (typeId === 8) status = 'Penalty';

            boxes.forEach(box => {
                if (box.checked) {
                    const empId = Number(box.value);
                    saveAttendanceRecord(empId, today, typeId, rule.deduction, "Admin เช็คชื่อกลุ่ม", status);
                    updateCount++;
                }
            });

            if (updateCount > 0) {
                saveData();
                showToast(`บันทึกสำเร็จ ${updateCount} รายการ`);
                renderAdminView();
                const headerChk = document.getElementById('selectAllYardCheck');
                if (headerChk) headerChk.checked = false;
            } else {
                showToast("กรุณาเลือกพนักงานก่อน");
            }
        };

        const getDaysDiff = (start, end) => {
            const d1 = new Date(start);
            const d2 = new Date(end);
            const diffTime = Math.abs(d2 - d1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        };

        window.handleLeaveSubmit = function (e) {
            e.preventDefault();
            console.log("Submitting Leave Request..."); // Debug
            try {
                const typeId = document.getElementById('leaveType').value;
                const start = document.getElementById('leaveStartDate').value;
                const end = document.getElementById('leaveEndDate').value;
                const reason = document.getElementById('leaveReason').value.trim(); // Get reason and trim whitespace

                if (!typeId) { showToast("กรุณาเลือกประเภทการลา"); return; }
                if (!start || !end) { showToast("กรุณาระบุวันที่เริ่มต้นและสิ้นสุด"); return; }
                if (!reason) { showToast("กรุณาระบุเหตุผลการลา"); return; } // Validate reason
                if (start > end) { showToast("วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด"); return; }

                // Get Rule
                const rule = appData.leaveRules[typeId];
                if (!rule) { showToast("ไม่พบข้อมูลประเภทการลา"); return; }

                // Ensure currentUserId is set (Employee ID)
                const empId = appData.currentUserId;
                const emp = appData.employees.find(e => e.id === empId);

                // Critical Check
                if (!emp) {
                    console.error("Employee not found for ID:", empId);
                    showToast("ไม่พบข้อมูลพนักงานในระบบ (กรุณาล็อกอินใหม่)");
                    return;
                }

                // Check Overlap
                const isOverlap = appData.history.some(h => {
                    if (h.empId === empId && h.status !== 'Rejected') { // Added Cancelled check if we add that status later
                        const hStart = h.date;
                        const hEnd = h.endDate || h.date;
                        // Check logic: (StartA <= EndB) and (EndA >= StartB)
                        return (start <= hEnd && end >= hStart);
                    }
                    return false;
                });

                if (isOverlap) { showToast("⚠️ ไม่สามารถขอลาซ้ำวันที่เดิมได้ (มีรายการอยู่แล้ว)"); return; }

                // Calculate Days
                // --- เริ่มต้นส่วนที่แก้ไข (นับวันโดยหักวันหยุดประจำสัปดาห์ออก) ---

                let days = 0;
                let currentDate = new Date(start);
                const lastDate = new Date(end);

                // วนลูปตั้งแต่วันเริ่มต้น จนถึงวันสิ้นสุด
                while (currentDate <= lastDate) {
                    const dayOfWeek = currentDate.getDay(); // 0 = อาทิตย์, 1 = จันทร์, ...

                    // เช็คว่า "ไม่ใช่วันหยุดประจำสัปดาห์" ใช่ไหม? (ถ้าใช่ ให้ข้าม ไม่ต้องนับ)
                    if (!appData.holidays.weekly.includes(dayOfWeek)) {

                        // (เสริม) เช็ควันหยุดนักขัตฤกษ์/ประจำปีด้วย (ถ้าต้องการให้หักออกด้วย)
                        const dateStr = currentDate.toISOString().split('T')[0]; // แปลงเป็น YYYY-MM-DD
                        const isAnnualHoliday = appData.holidays.annual.some(h => h.date === dateStr);

                        if (!isAnnualHoliday) {
                            days++;
                        }
                    }

                    // ขยับไปวันถัดไป
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // ถ้าคำนวณแล้วเหลือ 0 วัน (แปลว่าเลือกวันหยุดล้วนๆ) ให้แจ้งเตือนและหยุดทำงาน
                if (days === 0) {
                    showToast("วันที่เลือกเป็นวันหยุดทั้งหมด (ไม่จำเป็นต้องลา)");
                    return;
                }

                // --- สิ้นสุดส่วนที่แก้ไข ---
                if (isNaN(days) || days <= 0) { showToast("จำนวนวันไม่ถูกต้อง"); return; }

                // Calculate Deduction
                let deductionRate = rule.deduction || 0; // Safe default

                if (rule.useTiers) {
                    const currentYear = new Date().getFullYear();
                    const empHistory = appData.history.filter(h => {
                        const d = new Date(h.date);
                        return h.empId === empId && h.type === parseInt(typeId) && d.getFullYear() === currentYear && h.status !== 'Rejected';
                    });

                    let usedCount = 0;
                    if (rule.countType === 'days') {
                        usedCount = empHistory.reduce((sum, h) => {
                            const d = getDaysDiff(h.date, h.endDate || h.date);
                            return sum + d;
                        }, 0);
                    } else {
                        usedCount = empHistory.length;
                    }

                    // Calculate rate for the NEXT unit (usedCount + 1)
                    // Logic: Find the first tier where (usedCount + 1) <= limit
                    let appliedRate = null;

                    if (rule.tiers && rule.tiers.length > 0) {
                        // Sort just in case
                        const sortedTiers = [...rule.tiers].sort((a, b) => a.limit - b.limit);
                        const currentTier = sortedTiers.find(t => (usedCount + 1) <= t.limit);

                        if (currentTier) {
                            appliedRate = currentTier.rate;
                        } else {
                            // Exceeds all limits
                            appliedRate = rule.tierDefaultRate !== undefined ? rule.tierDefaultRate : 0;
                        }
                    } else if (rule.tierLimit) {
                        // Backward Compatibility Logic
                        if (usedCount < rule.tierLimit) {
                            appliedRate = rule.tierRate1;
                        } else {
                            appliedRate = rule.tierRate2;
                        }
                    } else {
                        appliedRate = rule.deduction; // Fallback
                    }

                    deductionRate = appliedRate;
                }

                let totalDeduction = 0;
                if (rule.useTiers && rule.deductType === 'per_request') {
                    totalDeduction = deductionRate;
                } else {
                    totalDeduction = days * deductionRate;
                }

                // Final safety for NaN
                if (isNaN(totalDeduction)) totalDeduction = 0;

                // Push Data
                const newRecord = {
                    id: Date.now(),
                    empId: empId,
                    date: start,
                    endDate: end,
                    type: parseInt(typeId),
                    status: 'Pending',
                    deduction: totalDeduction,
                    reason: `${reason} (จำนวน ${days} วัน)`,
                    timestamp: new Date().toISOString()
                };

                appData.history.push(newRecord);

                saveData();
                closeModal('leaveModal');
                document.getElementById('leaveForm').reset(); // Reset form
                showToast(`ส่งคำขอแล้ว (หัก ${totalDeduction} คะแนน)`);

                updateUI(); // Refresh UI to show history immediately

            } catch (ex) {
                console.error("Leave Submit Error:", ex);
                showToast("เกิดข้อผิดพลาด: " + ex.message);
            }
        };

        window.handleAddEmployee = function (e) {
            e.preventDefault();
            // Updated to include nickname
            const nickname = document.getElementById('newEmpNickname').value;
            appData.employees.push({
                id: Date.now(),
                name: document.getElementById('newEmpName').value,
                nickname: nickname,
                code: document.getElementById('newEmpCode').value,
                position: document.getElementById('newEmpPosition').value,
                baseScore: parseInt(document.getElementById('newEmpBaseScore').value) || 30,
                location: appData.adminSelectedSite
            });
            saveData(); closeModal('addEmpModal'); e.target.reset(); showToast("เพิ่มสำเร็จ");
        };

        // --- RENDERERS ---
        window.renderRuleSettings = function () {
            const body = document.getElementById('rulesTableBody'); body.innerHTML = '';

            // NEW: Set Toggle Status
            const toggle = document.getElementById('toggleShowRules');
            if (toggle) toggle.checked = appData.settings.showRulesToEmp || false;

            // Set current Staff Password value
            document.getElementById('staffPasswordInput').value = appData.staffPassword || "staff";

            Object.entries(appData.leaveRules).forEach(([id, rule]) => {
                let deductionText = rule.deduction;
                let tierText = '-';
                if (rule.useTiers) {
                    deductionText = `<span class="text-blue-600 font-bold">แบบขั้นบันได</span>`;

                    // Generate summary text
                    if (rule.tiers && rule.tiers.length > 0) {
                        const parts = rule.tiers.map(t => `ไม่เกิน ${t.limit} (${t.rate})`);
                        tierText = parts.join(', ') + `, เกิน (${rule.tierDefaultRate || 0})`;
                    } else if (rule.tierLimit) {
                        // Fallback display
                        tierText = `${rule.tierLimit} แรก (${rule.tierRate1}), เกิน (${rule.tierRate2})`;
                    }
                }

                const isChecked = rule.isSelectable !== false ? 'checked' : '';
                const disabled = rule.isSystem ? 'disabled opacity-50' : '';

                body.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition">
                        <td class="text-center py-3 border-b border-slate-50">
                            <input type="checkbox" ${isChecked} ${disabled} onchange="toggleRuleSelectable(${id}, this.checked)" class="rounded text-green-600 focus:ring-green-500 cursor-pointer">
                        </td>
                        <td class="py-3 font-bold border-b border-slate-50">
                            <div class="flex items-center gap-2">
                                ${rule.name} 
                                <button onclick="editRule(${id})" class="bg-blue-50 text-blue-500 hover:bg-blue-100 hover:text-blue-700 w-6 h-6 rounded flex items-center justify-center transition"><i class="fas fa-pen text-[10px]"></i></button>
                            </div>
                        </td>
                        <td class="text-center font-bold text-slate-600 border-b border-slate-50 text-xs">${deductionText}</td>
                        <td class="text-left py-3 border-b border-slate-50">
                            <div class="text-[10px] text-slate-400 leading-tight max-w-[200px]">${tierText}</div>
                        </td>
                        <td class="text-right py-3 border-b border-slate-50 pr-2">${!rule.isSystem ? `<button onclick="deleteRule(${id})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>` : '<i class="fas fa-lock text-slate-200"></i>'}</td>
                    </tr>`;
            });
        };

        // NEW: Update Staff Password
        window.updateStaffPassword = function () {
            const newPass = document.getElementById('staffPasswordInput').value.trim();
            if (newPass) {
                appData.staffPassword = newPass;
                saveData();
                showToast("อัปเดตรหัสผ่าน Staff เรียบร้อย");
            } else {
                showToast("กรุณากรอกรหัสผ่าน");
            }
        };

        // NEW: Open Edit Profile Modal
        window.openEditProfileModal = function () {
            const emp = appData.employees.find(e => e.id == appData.currentUserId);
            if (!emp) return;

            document.getElementById('editProfileNickname').value = emp.nickname || '';
            document.getElementById('editProfilePhone').value = emp.phone || ''; // NEW: Fill phone
            document.getElementById('editProfileUsername').value = emp.username || '';
            document.getElementById('editProfilePassword').value = emp.password || '';

            openModal('editProfileModal');
        };

        // NEW: Handle Edit Profile Submit
        window.handleEditProfile = function (e) {
            e.preventDefault();
            const nickname = document.getElementById('editProfileNickname').value.trim();
            const phone = document.getElementById('editProfilePhone').value.trim(); // NEW
            const username = document.getElementById('editProfileUsername').value.trim();
            const password = document.getElementById('editProfilePassword').value.trim();

            if (!username || !password) { showToast("กรุณากรอก Username และ Password"); return; }

            // Check Duplicate Username (excluding self)
            const isDuplicate = appData.employees.some(emp => emp.username === username && emp.id !== appData.currentUserId);
            if (isDuplicate) { showToast("Username นี้มีผู้ใช้งานแล้ว"); return; }

            const empIndex = appData.employees.findIndex(e => e.id == appData.currentUserId);
            if (empIndex !== -1) {
                appData.employees[empIndex].nickname = nickname;
                appData.employees[empIndex].phone = phone; // NEW: Save Phone
                appData.employees[empIndex].username = username;
                appData.employees[empIndex].password = password;

                saveData();

                // Auto-Update Local Storage if 'Remember Me' is active
                const storedAuth = localStorage.getItem('2ps_auth');
                if (storedAuth) {
                    localStorage.setItem('2ps_auth', JSON.stringify({ username: username, password: password }));
                }

                showToast("บันทึกข้อมูลเรียบร้อย");
                closeModal('editProfileModal');

                // Refresh UI
                updateUI();
            }
        };

        window.toggleRuleSelectable = function (id, isChecked) {
            if (appData.leaveRules[id]) {
                appData.leaveRules[id].isSelectable = isChecked;
                saveData();
            }
        };

        window.toggleTierInputs = function () {
            const isChecked = document.getElementById('enableTier').checked;
            const tierSection = document.getElementById('tierInputs');
            const flatInput = document.getElementById('newRuleDed');

            if (isChecked) {
                tierSection.classList.remove('hidden');
                flatInput.disabled = true;
                flatInput.classList.add('bg-slate-100', 'text-slate-400');

                // Initialize with one row if empty
                const container = document.getElementById('tierRowsContainer');
                if (container.children.length === 0) {
                    addTierRow(3, 1); // Default Example
                }
                updateTierUnitLabels();
            } else {
                tierSection.classList.add('hidden');
                flatInput.disabled = false;
                flatInput.classList.remove('bg-slate-100', 'text-slate-400');
            }
        };

        // NEW: Dynamic Tier Rows
        window.addTierRow = function (limit = '', rate = '') {
            const container = document.getElementById('tierRowsContainer');
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 text-xs tier-row animate-slide-in bg-slate-50 p-2 rounded border border-slate-100";
            div.innerHTML = `
                <span class="whitespace-nowrap font-bold text-slate-500">ไม่เกิน</span>
                <input type="number" class="tier-limit w-14 text-center border rounded p-1 font-bold text-slate-700 focus:ring-1 focus:ring-blue-500" placeholder="จำนวน" value="${limit}" required>
                <span class="unit-label text-slate-500">...</span>
                <span class="whitespace-nowrap font-bold text-slate-500">หัก</span>
                <input type="number" step="0.1" class="tier-rate w-14 text-center border rounded p-1 font-bold text-red-500 focus:ring-1 focus:ring-red-500" placeholder="คะแนน" value="${rate}" required>
                <button type="button" onclick="this.parentElement.remove()" class="ml-auto w-6 h-6 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-100 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
            updateTierUnitLabels();
        };

        window.updateTierUnitLabels = function () {
            const type = document.getElementById('tierCountType').value;
            const label = type === 'times' ? 'ครั้ง' : 'วัน';
            document.querySelectorAll('.unit-label').forEach(el => el.innerText = label);
        };

        // --- Helper Function: Calculate Chargeable Days (Shared Logic) ---
        // ฟังก์ชันช่วยคำนวณวันลาที่ต้องหักคะแนน (หักวันหยุดออกแล้ว)
        function calculateChargeableDays(start, end) {
            let days = 0;
            let currentDate = new Date(start);
            const lastDate = new Date(end);

            while (currentDate <= lastDate) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const isAnnualHoliday = appData.holidays.annual.some(h => h.date === dateStr);

                // นับเฉพาะถ้าไม่ใช่วันหยุดประจำสัปดาห์ และ ไม่ใช่วันหยุดนักขัตฤกษ์
                if (!appData.holidays.weekly.includes(dayOfWeek) && !isAnnualHoliday) {
                    days++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return days;
        }

        // --- NEW FUNCTION: Recalculate History ---
        // ฟังก์ชันคำนวณคะแนนย้อนหลังเมื่อมีการเปลี่ยนกฎ
        function recalculateHistoryForRule(ruleId) {
            const rule = appData.leaveRules[ruleId];
            if (!rule) return;

            let updatedCount = 0;

            // วนลูปพนักงานทุกคน
            appData.employees.forEach(emp => {
                // ดึงประวัติของกฎข้อนี้ ของพนักงานคนนี้ เรียงตามวันที่ (เก่า -> ใหม่) เพื่อไล่ลำดับขั้นบันไดถูก
                const empHistory = appData.history
                    .filter(h => h.empId == emp.id && h.type == ruleId && h.status !== 'Rejected')
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                // ตัวแปรเก็บยอดสะสม (แยกตามปี)
                let yearlyUsage = {}; // { 2024: 5, 2025: 2 }

                empHistory.forEach(h => {
                    const year = new Date(h.date).getFullYear();
                    if (!yearlyUsage[year]) yearlyUsage[year] = 0;

                    // 1. คำนวณจำนวนวันของรายการนี้ (ใช้ Logic เดียวกับตอนขอลา)
                    const start = h.date;
                    const end = h.endDate || h.date;
                    const days = calculateChargeableDays(start, end);

                    // ถ้าเป็น 0 วัน (ลาตรงวันหยุดล้วนๆ) ให้คะแนนเป็น 0
                    if (days === 0) {
                        h.deduction = 0;
                        return;
                    }

                    // 2. คำนวณคะแนนที่ต้องหักใหม่
                    let deductionRate = rule.deduction || 0; // ค่าเริ่มต้น (Flat rate)

                    if (rule.useTiers) {
                        // ยอดสะสมเดิมก่อนรายการนี้
                        const usedCount = yearlyUsage[year];

                        // หาเรทราคาจากขั้นบันได
                        let appliedRate = null;
                        if (rule.tiers && rule.tiers.length > 0) {
                            const sortedTiers = [...rule.tiers].sort((a, b) => a.limit - b.limit);
                            // หา Tier แรกที่ยอดสะสม(รวมครั้งนี้ +1 หรือ +วัน) ยังไม่เกิน Limit
                            // ใช้ยอดสะสมปัจจุบัน (usedCount + 1 หรือ usedCount + days) ในการเช็ค
                            const currentCheckUnit = (rule.countType === 'days') ? (usedCount + days) : (usedCount + 1);

                            const currentTier = sortedTiers.find(t => currentCheckUnit <= t.limit);

                            if (currentTier) {
                                appliedRate = currentTier.rate;
                            } else {
                                appliedRate = rule.tierDefaultRate !== undefined ? rule.tierDefaultRate : 0;
                            }
                        } else if (rule.tierLimit) {
                            // Backward Compatibility Logic
                            if (usedCount < rule.tierLimit) {
                                appliedRate = rule.tierRate1;
                            } else {
                                appliedRate = rule.tierRate2;
                            }
                        } else {
                            // กรณีไม่มี Tiers (เป็นไปได้ยากถ้าติ๊ก useTiers)
                            appliedRate = rule.deduction;
                        }
                        deductionRate = appliedRate;
                    }

                    // 3. คำนวณผลรวม
                    let totalDeduction = 0;
                    if (rule.useTiers && rule.deductType === 'per_request') {
                        totalDeduction = deductionRate;
                    } else {
                        // per_day หรือ Flat rate ปกติ
                        totalDeduction = days * deductionRate;
                    }

                    // 4. อัปเดตข้อมูลในประวัติ
                    if (h.deduction !== totalDeduction) {
                        h.deduction = totalDeduction;
                        updatedCount++;
                    }

                    // 5. บวกยอดสะสมเพื่อใช้กับรายการถัดไปในปีเดียวกัน
                    if (rule.useTiers) {
                        if (rule.countType === 'days') {
                            yearlyUsage[year] += days;
                        } else {
                            yearlyUsage[year] += 1;
                        }
                    }
                });
            });

            if (updatedCount > 0) {
                console.log(`Updated ${updatedCount} records for rule ${rule.name}`);
            }
        }

        window.addRule = function (e) {
            e.preventDefault();
            const id = document.getElementById('manageRulesModal').dataset.editId || Date.now();
            const isTiered = document.getElementById('enableTier').checked;
            const isSelectable = document.getElementById('newRuleSelectable').checked;

            // Collect Tiers (เก็บข้อมูลขั้นบันได)
            let tiers = [];
            let defaultRate = 0;
            if (isTiered) {
                const rows = document.querySelectorAll('.tier-row');
                rows.forEach(row => {
                    const lim = parseFloat(row.querySelector('.tier-limit').value);
                    const rate = parseFloat(row.querySelector('.tier-rate').value);
                    if (!isNaN(lim) && !isNaN(rate)) {
                        tiers.push({ limit: lim, rate: rate });
                    }
                });
                tiers.sort((a, b) => a.limit - b.limit);
                defaultRate = parseFloat(document.getElementById('tierDefaultRate').value) || 0;
            }

            // สร้าง Object กฎใหม่
            const newRule = {
                name: document.getElementById('newRuleName').value,
                deduction: parseFloat(document.getElementById('newRuleDed').value) || 0,
                isSystem: false,
                isSelectable: isSelectable,
                // --- [จุดสำคัญ] บันทึกหมวดหมู่ที่เลือก ---
                category: document.getElementById('newRuleCategory').value,
                // ------------------------------------
                useTiers: isTiered,
                tiers: tiers,
                tierDefaultRate: defaultRate,
                countType: document.getElementById('tierCountType').value,
                deductType: document.getElementById('tierDeductType').value
            };

            appData.leaveRules[id] = newRule;

            // --- TRIGGER RECALCULATION ---
            // คำนวณคะแนนย้อนหลังทันทีที่มีการบันทึกกฎ
            recalculateHistoryForRule(id);
            // -----------------------------

            saveData();
            renderRuleSettings();

            // Refresh UI หน้าหลักด้วยเพราะคะแนนเปลี่ยน
            updateUI();

            // Reset Form (ล้างค่าในฟอร์ม)
            e.target.reset();
            document.getElementById('manageRulesModal').dataset.editId = '';
            document.getElementById('enableTier').checked = false;
            document.getElementById('newRuleSelectable').checked = true;
            document.getElementById('newRuleCategory').value = 'leave'; // คืนค่าเริ่มต้นเป็น 'วันลา'
            document.getElementById('tierRowsContainer').innerHTML = '';
            toggleTierInputs();

            showToast("บันทึกเกณฑ์และปรับปรุงคะแนนย้อนหลังเรียบร้อย");
        };

        window.editRule = function (id) {
            const rule = appData.leaveRules[id];
            if (!rule) return;

            document.getElementById('manageRulesModal').dataset.editId = id;
            document.getElementById('newRuleName').value = rule.name;
            document.getElementById('newRuleDed').value = rule.deduction;
            document.getElementById('newRuleSelectable').checked = rule.isSelectable !== false;

            // --- [จุดสำคัญ] ดึงหมวดหมู่มาแสดง ---
            // ถ้ามีค่าเดิมอยู่แล้ว ให้ใช้ค่าเดิม
            // ถ้าไม่มี (เป็นข้อมูลเก่า) ให้เดาจาก ID: 1-5=ลา, 6-8=โทษ, 11=ไม่นับ
            let defaultCat = 'none';
            const numId = parseInt(id);

            if (rule.category) {
                defaultCat = rule.category;
            } else {
                // Logic การเดาสำหรับข้อมูลเก่า
                if (numId <= 5) defaultCat = 'leave'; // ลาป่วย, ลากิจ ฯลฯ
                else if (numId >= 6 && numId <= 8) defaultCat = 'penalty'; // สาย, ขาด
            }
            document.getElementById('newRuleCategory').value = defaultCat;
            // --------------------------------

            const isTiered = rule.useTiers || false;
            document.getElementById('enableTier').checked = isTiered;

            const container = document.getElementById('tierRowsContainer');
            container.innerHTML = '';

            if (isTiered) {
                document.getElementById('tierCountType').value = rule.countType || 'times';
                document.getElementById('tierDeductType').value = rule.deductType || 'per_request';
                document.getElementById('tierDefaultRate').value = rule.tierDefaultRate !== undefined ? rule.tierDefaultRate : (rule.tierRate2 || 0);

                if (rule.tiers && rule.tiers.length > 0) {
                    rule.tiers.forEach(t => addTierRow(t.limit, t.rate));
                } else if (rule.tierLimit) {
                    addTierRow(rule.tierLimit, rule.tierRate1 || 0);
                    document.getElementById('tierDefaultRate').value = rule.tierRate2 || 0;
                } else {
                    addTierRow();
                }
            }

            toggleTierInputs();
        };
        window.deleteRule = function (id) {
            if (confirm("คุณต้องการลบเกณฑ์นี้ใช่หรือไม่?")) {
                delete appData.leaveRules[id];
                saveData();
                renderRuleSettings();
                showToast("ลบเกณฑ์เรียบร้อยแล้ว");
            }
        };

        window.processExcelFile = function () {
            const file = document.getElementById('excelFileInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    let addedCount = 0;

                    jsonData.forEach(row => {
                        // Function to fuzzy match keys (trim spaces to match column headers correctly)
                        const getVal = (targetKeys) => {
                            const key = Object.keys(row).find(k => targetKeys.includes(k.trim()));
                            return key ? String(row[key]).trim() : "";
                        };

                        // 1. Essential Data (Skip if missing)
                        // อ่านคอลัมน์ "ชื่อ-นามสกุล"
                        const name = getVal(['ชื่อ-นามสกุล', 'ชื่อ', 'Name']);
                        // อ่านคอลัมน์ "รหัสพนักงาน"
                        const code = getVal(['รหัสพนักงาน', 'รหัส', 'EmpID', 'ID']);

                        // ถ้าไม่มีชื่อหรือรหัส ให้ข้ามแถวนั้นไปเลย
                        if (!name || !code) return;

                        // 2. Optional Data (Allow empty)
                        // อ่านคอลัมน์ "ชื่อเล่น"
                        const nickname = getVal(['ชื่อเล่น', 'Nickname']);
                        // อ่านคอลัมน์ "ตำแหน่ง"
                        const position = getVal(['ตำแหน่ง', 'Position']);
                        // อ่านคอลัมน์ "สาย" (Line/Yard)
                        const line = getVal(['สาย', 'Line', 'Section', 'Department']);

                        // 3. Logic for Location/Yard
                        // ถ้า Excel ระบุ "สาย" มาให้ใช้ค่านั้น, ถ้าไม่ระบุให้ใช้ Yard ที่แอดมินเลือกอยู่ปัจจุบัน
                        const finalLocation = line !== "" ? line : appData.adminSelectedSite;

                        // 4. Duplicate Check (by Code) - ป้องกันรหัสซ้ำ
                        const exists = appData.employees.some(e => e.code === code);

                        if (!exists) {
                            appData.employees.push({
                                id: Date.now() + Math.random(),
                                name: name,
                                nickname: nickname,
                                code: code,
                                position: position || '-',
                                location: finalLocation,
                                baseScore: 30, // คะแนนเริ่มต้นมาตรฐาน
                                username: code, // Default user = รหัสพนักงาน
                                password: code  // Default pass = รหัสพนักงาน
                            });
                            addedCount++;
                        }
                    });

                    saveData();
                    closeModal('importExcelModal');
                    document.getElementById('excelFileInput').value = ''; // Reset input

                    if (addedCount > 0) {
                        showToast(`นำเข้าพนักงานสำเร็จ ${addedCount} คน`);
                        // Refresh UI
                        renderAdminView();
                        renderAdminAllEmployees();
                    } else {
                        showToast("ไม่พบข้อมูลใหม่ หรือรหัสพนักงานซ้ำกับที่มีอยู่");
                    }

                } catch (error) {
                    console.error("Excel Import Error:", error);
                    showToast("เกิดข้อผิดพลาดในการอ่านไฟล์ Excel");
                }
            };
            reader.readAsArrayBuffer(file);
        };
        // ---------------------------------------------------------
        // 🟢 3. Logic จัดการเกรดและสี (วางใน <script>)
        // ---------------------------------------------------------

        // 3.1 ตัวแปลงโค้ดสี (Color Map)
        // รูปแบบ: [สีเริ่ม (Gradient Start), สีจบ (Gradient End), สีข้อความ (Text Color)]
        const colorMap = {
            'gold': ['from-yellow-400', 'to-yellow-600', 'text-yellow-700 bg-yellow-100'],
            'green': ['from-green-600', 'to-emerald-800', 'text-green-700 bg-green-100'],
            'blue': ['from-blue-600', 'to-indigo-800', 'text-blue-700 bg-blue-100'],
            'purple': ['from-purple-600', 'to-violet-800', 'text-purple-700 bg-purple-100'],
            'orange': ['from-orange-500', 'to-red-600', 'text-orange-700 bg-orange-100'],
            'red': ['from-red-600', 'to-rose-800', 'text-red-700 bg-red-100'],
            'gray': ['from-slate-500', 'to-slate-700', 'text-slate-600 bg-slate-100'],
            'black': ['from-slate-800', 'to-black', 'text-slate-800 bg-slate-200']
        };

        // 3.2 ฟังก์ชันแสดงตารางรายการเกรด
        window.renderGradeSettings = function () {
            const body = document.getElementById('gradesTableBody');
            if (!body) return;
            body.innerHTML = '';

            // ดึงข้อมูลเกรดมาเรียงลำดับ (จากคะแนนมาก -> น้อย)
            // ถ้ายังไม่มีข้อมูล ให้ใช้ Array ว่าง []
            const sortedGrades = (appData.grades || []).sort((a, b) => b.min - a.min);

            // ถ้าไม่มีเกรดเลย ให้ขึ้นข้อความแจ้งเตือน
            if (sortedGrades.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-xs text-slate-300">ยังไม่มีการกำหนดเกรด</td></tr>';
                return;
            }

            // วนลูปสร้างแถวในตาราง
            sortedGrades.forEach((g, index) => {
                // ดึงค่าสีจาก colorMap (ถ้าหาไม่เจอให้ใช้สีเทา)
                const colorClass = colorMap[g.color] || colorMap['gray'];

                body.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition border-b border-slate-50 last:border-none">
                        <td class="pl-4 py-3">
                            <span class="font-black text-slate-800 text-sm">${g.name}</span>
                            <span class="text-[10px] text-slate-400 block truncate max-w-[100px]">${g.text}</span>
                        </td>
                        <td class="text-center font-bold text-blue-600 py-3 text-xs">${g.min} - ${g.max} คะแนน</td>
                        <td class="text-center py-3">
                            <div class="w-6 h-6 rounded-full bg-gradient-to-br ${colorClass[0]} ${colorClass[1]} mx-auto shadow-sm border-2 border-white ring-1 ring-slate-100"></div>
                        </td>
                        <td class="text-right pr-4 py-3">
                            <button onclick="deleteGrade(${index})" class="text-slate-300 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50" title="ลบเกรดนี้">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        };

        // 3.3 ฟังก์ชันบันทึกเกรดใหม่ (เมื่อกดปุ่ม "เพิ่มเกรด")
        window.addGrade = function () {
            // ดึงค่าจากช่องกรอก
            const name = document.getElementById('newGradeName').value.trim();
            const minStr = document.getElementById('newGradeMin').value;
            const maxStr = document.getElementById('newGradeMax').value;
            const min = parseFloat(minStr);
            const max = parseFloat(maxStr);
            const text = document.getElementById('newGradeText').value.trim();
            const color = document.getElementById('newGradeColor').value;

            // ตรวจสอบความถูกต้อง (Validation)
            if (!name) { showToast("กรุณากรอกชื่อเกรด (เช่น A, B, C)"); return; }
            if (minStr === "" || isNaN(min)) { showToast("กรุณากรอกคะแนนขั้นต่ำ (Min)"); return; }
            if (maxStr === "" || isNaN(max)) { showToast("กรุณากรอกคะแนนสูงสุด (Max)"); return; }
            if (min > max) { showToast("คะแนนขั้นต่ำ (Min) ต้องน้อยกว่าคะแนนสูงสุด (Max)"); return; }

            // ถ้ายังไม่มี array grades ให้สร้างใหม่
            if (!appData.grades) appData.grades = [];

            // เพิ่มข้อมูลลงไป
            appData.grades.push({
                name: name,
                min: min,
                max: max,
                text: text || name, // ถ้าไม่ได้กรอกคำอธิบาย ให้ใช้ชื่อเกรดแทน
                color: color
            });

            // ล้างค่าในช่องกรอก (Reset Inputs) ให้พร้อมกรอกอันต่อไป
            document.getElementById('newGradeName').value = '';
            document.getElementById('newGradeMin').value = '';
            document.getElementById('newGradeMax').value = '';
            document.getElementById('newGradeText').value = '';

            // บันทึกลง Database และวาดตารางใหม่
            saveData();
            renderGradeSettings();
            showToast(`เพิ่มเกรด ${name} เรียบร้อย`);
        };

        // 3.4 ฟังก์ชันลบเกรด
        window.deleteGrade = function (index) {
            if (confirm("คุณต้องการลบเกรดนี้ใช่หรือไม่?")) {
                // ต้อง sort ให้ตรงกับตอนแสดงผลก่อนลบ เพื่อให้ index ตรงกัน
                appData.grades.sort((a, b) => b.min - a.min);

                // ลบข้อมูลที่ตำแหน่ง index
                appData.grades.splice(index, 1);

                saveData();
                renderGradeSettings();
                showToast("ลบเกรดเรียบร้อย");
            }
        };
        // ---------------------------------------------------------

        window.renderManagerView = function () {
            const grid = document.getElementById('mgr-site-grid'); grid.innerHTML = '';

            // NEW: Populate Announcement Input
            const annInput = document.getElementById('mgr-announcement-input');
            if (annInput) annInput.value = appData.announcement || "";

            appData.locations.forEach(loc => {
                const emps = appData.employees.filter(e => e.location === (typeof loc === 'object' ? loc.name : loc));
                const avg = emps.length > 0 ? (emps.reduce((a, b) => a + b.score, 0) / emps.length).toFixed(1) : 0;
                // Handle object or string
                const name = typeof loc === 'object' ? loc.name : loc;

                // Add onclick event to each card
                grid.innerHTML += `
                <div onclick="openYardDailyDetail('${name}', '${getTodayStr()}')" class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition cursor-pointer group hover:border-blue-200">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-wider group-hover:text-blue-500 transition">${name}</h4>
                        <i class="fas fa-chevron-right text-slate-300 text-xs group-hover:text-blue-500 transition"></i>
                    </div>
                    <div class="text-3xl font-black text-slate-900 mb-1">${emps.length} <span class="text-xs font-normal text-slate-400">คน</span></div>
                    <div class="text-[10px] font-bold ${avg >= 25 ? 'text-green-600 bg-green-100' : (avg >= 15 ? 'text-yellow-600 bg-yellow-100' : 'text-red-600 bg-red-100')} bg-slate-50 inline-block px-2 py-1 rounded-lg">Avg: ${avg}</div>
                </div>`;
            });

            // ... (rest of function)
            const pending = appData.history.filter(h => h.status === 'Pending');
            document.getElementById('manager-badge').innerText = pending.length;
            document.getElementById('manager-badge').classList.toggle('hidden', pending.length === 0);
            document.getElementById('mgr-pending-count').innerText = pending.length;
            const list = document.getElementById('mgr-request-list');
            list.innerHTML = '';

            if (pending.length === 0) {
                list.innerHTML = '<div class="p-12 text-center text-slate-300 text-sm flex flex-col items-center"><i class="fas fa-check-circle text-4xl mb-3 text-slate-200"></i>ไม่มีรายการรออนุมัติ</div>';
            } else {
                pending.forEach(h => {
                    const emp = appData.employees.find(e => e.id == h.empId);
                    const empName = emp ? `${emp.name} ${emp.nickname ? '(' + emp.nickname + ')' : ''}` : "Unknown";
                    const ruleName = appData.leaveRules[h.type]?.name || "Special";

                    list.innerHTML += `
                        <div class="p-4 flex justify-between items-center group hover:bg-slate-50 transition">
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${empName}</div>
                                <div class="text-[10px] text-slate-500">${ruleName} (${new Date(h.date).toLocaleDateString('th-TH')})</div>
                                <div class="text-[10px] text-slate-400 italic">"${h.reason}"</div>
                            </div>
                            <div class="flex gap-2 opacity-100">
                                 <button onclick="approveRequest(${h.id}, true)" class="w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center transition"><i class="fas fa-check"></i></button>
                                 <button onclick="approveRequest(${h.id}, false)" class="w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                });
            }

            // Render History List
            const historyList = document.getElementById('mgr-history-list');
            historyList.innerHTML = '';
            // UPDATED: Filter only Approved/Rejected items (Leave Requests)
            const historyItems = [...appData.history]
                .filter(h => h.status === 'Approved' || h.status === 'Rejected')
                .sort((a, b) => b.timestamp.localeCompare(a.timestamp))
                .slice(0, 20);

            if (historyItems.length === 0) {
                historyList.innerHTML = '<div class="p-8 text-center text-slate-300 text-sm">ไม่มีประวัติการอนุมัติล่าสุด</div>';
            } else {
                historyItems.forEach(h => {
                    const emp = appData.employees.find(e => e.id == h.empId);
                    const empName = emp ? `${emp.name} ${emp.nickname ? '(' + emp.nickname + ')' : ''}` : `<span class="text-slate-400 italic">ไม่พบข้อมูล (ID:${h.empId})</span>`;
                    const ruleName = appData.leaveRules[h.type]?.name || "ไม่ระบุ";
                    let dateDisplay = new Date(h.date).toLocaleDateString('th-TH');

                    let statusColor = "text-slate-500 bg-slate-100";
                    let statusIcon = "fa-circle";
                    let statusLabel = h.status;

                    if (h.status === 'Approved') {
                        statusColor = "text-green-600 bg-green-50";
                        statusIcon = "fa-check-circle";
                        statusLabel = 'อนุมัติแล้ว';
                    } else if (h.status === 'Rejected') {
                        statusColor = "text-red-600 bg-red-50";
                        statusIcon = "fa-times-circle";
                        statusLabel = 'ปฏิเสธ';
                    }

                    historyList.innerHTML += `
                        <div class="p-4 hover:bg-slate-50 transition flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold">
                                    ${emp ? emp.name.charAt(0) : '?'}
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-800">${empName}</p>
                                    <p class="text-[10px] text-slate-500">${ruleName} <span class="mx-1">•</span> ${dateDisplay}</p>
                                </div>
                            </div>
                            <div class="text-right flex items-center gap-2">
                                <span class="text-[10px] font-bold px-2 py-1 rounded-full ${statusColor}">
                                    <i class="fas ${statusIcon} mr-1"></i> ${statusLabel}
                                </span>
                                <button onclick="deleteManagerHistoryRecord(${h.id})" class="text-slate-300 hover:text-red-500 transition p-1" title="ลบรายการ">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }



            // Render Ranking
            renderRankingList();
        }

        // NEW: Function to delete history record from Manager View
        window.deleteManagerHistoryRecord = function (hid) {
            const pin = prompt("กรุณาใส่รหัส Admin เพื่อยืนยันการลบรายการ:");
            if (pin === ADMIN_PIN) {
                if (confirm("ยืนยันการลบรายการนี้ออกจากฐานข้อมูล? การกระทำนี้ไม่สามารถย้อนกลับได้")) {
                    appData.history = appData.history.filter(h => h.id != hid);
                    saveData();
                    showToast("ลบรายการเรียบร้อยแล้ว");
                    updateUI(); // Recalculate scores and refresh all views
                }
            } else if (pin !== null) {
                alert("รหัสผ่านไม่ถูกต้อง!");
            }
        };

        // NEW: Manager Yard Detail Logic
        // Function to open the detail modal
        window.openYardDailyDetail = function (yardName, date, filter = 'all') {
            // If date is not provided, use today or the value from the manager date selector
            const selectedDate = date || document.getElementById('mgrDateSelector').value || getTodayStr();

            document.getElementById('yardDetailTitle').innerText = yardName;
            document.getElementById('yardDetailDate').innerText = new Date(selectedDate).toLocaleDateString('th-TH', { dateStyle: 'long' });

            // Store current context for filtering
            document.getElementById('yardDailyDetailModal').dataset.yard = yardName;
            document.getElementById('yardDailyDetailModal').dataset.date = selectedDate;

            // Render with filter
            filterYardDetail(filter);

            openModal('yardDailyDetailModal');
        };

        // NEW: Wrapper for Admin to open the detail modal
        window.openAdminYardDetail = function (filter) {
            const yardName = appData.adminSelectedSite;
            const date = document.getElementById('admDateSelector').value || getTodayStr();
            openYardDailyDetail(yardName, date, filter);
        };

        // Function to filter and render the list inside the modal
        window.filterYardDetail = function (filter) {
            const yardName = document.getElementById('yardDailyDetailModal').dataset.yard;
            const date = document.getElementById('yardDailyDetailModal').dataset.date;

            // Visual feedback for tabs
            ['all', 'present', 'late', 'absent'].forEach(f => {
                const btnElement = document.getElementById(`btn-yd-${f}`);
                if (btnElement) {
                    if (f === filter) {
                        btnElement.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                        btnElement.classList.remove('text-slate-500', 'hover:bg-white/50');
                    } else {
                        btnElement.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                        btnElement.classList.add('text-slate-500', 'hover:bg-white/50');
                    }
                }
            });

            const tbody = document.getElementById('yardDetailList');
            tbody.innerHTML = '';

            const employees = appData.employees.filter(e => e.location === yardName);

            employees.forEach(emp => {
                const dailyRecord = appData.history.find(h => h.empId == emp.id && h.date === date);

                let statusType = 'absent'; // Default to absent/unknown if no record
                let statusText = '<span class="text-slate-300 text-xs">ยังไม่ระบุ</span>';

                if (dailyRecord) {
                    const type = parseInt(dailyRecord.type);
                    if (type === 11) { statusType = 'present'; statusText = '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">มาทำงาน</span>'; }
                    else if (type === 6 || type === 7) { statusType = 'late'; statusText = '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">สาย</span>'; }
                    else { statusType = 'absent'; statusText = `<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold">${appData.leaveRules[type]?.name || 'ขาด/ลา'}</span>`; }
                }

                // Filter Logic
                if (filter === 'all' || filter === statusType) {
                    // For 'absent' filter, we want both explicit absent records AND those with no records? 
                    // Or strictly following the buttons? 
                    // Let's make 'absent' filter show explicit absent/leave records AND null records for completeness if it's a workday.
                    // But to keep it simple and consistent with admin dashboard logic:
                    // Present = 11, Late = 6,7, Absent = 8 or Leaves.

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-3">
                            <div class="font-bold text-slate-800 text-sm">${emp.name}</div>
                            <div class="text-[10px] text-slate-400">${emp.code}</div>
                        </td>
                        <td class="p-3 text-xs text-slate-500">${emp.position || '-'}</td>
                        <td class="p-3 text-center">${statusText}</td>
                    `;
                    tbody.appendChild(row);
                }
            });

            if (tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-sm">ไม่พบข้อมูล</td></tr>';
            }
        };

        // --- UTILS ---
        window.switchRole = (role) => {
            ['employee', 'admin', 'manager'].forEach(r => document.getElementById(`view-${r}`).classList.add('hidden'));
            ['employee', 'admin', 'manager'].forEach(r => document.getElementById(`btn-role-${r}`).className = "flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 tab-inactive");
            document.getElementById(`view-${role}`).classList.remove('hidden');
            document.getElementById(`btn-role-${role}`).className = "flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 tab-active";
            updateUI();
        };

        // UPDATED: Added safety check for null element
        window.openModal = (id) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('hidden');
            } else {
                console.warn(`Modal with ID '${id}' not found.`);
            }
        };
        // UPDATED: Added safety check for null element
        window.closeModal = (id) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('hidden');
            }
        };

        window.showToast = (msg) => { const t = document.getElementById('toast'); document.getElementById('toast-message').innerText = msg; t.classList.remove('translate-y-32'); setTimeout(() => t.classList.add('translate-y-32'), 3000); };

        // แก้ไขตรงนี้: เปลี่ยนจาก parseInt เป็น Number เพื่อให้รองรับ ID ที่เป็นทศนิยม
        window.switchCurrentUser = (id) => {
            appData.currentUserId = Number(id);
            updateUI();
        };

        window.approveRequest = (hid, ok) => { const h = appData.history.find(x => x.id == hid); if (h) { h.status = ok ? 'Approved' : 'Rejected'; if (!ok) h.deduction = 0; saveData(); showToast(ok ? "อนุมัติแล้ว" : "ปฏิเสธแล้ว"); renderManagerView(); } };

        window.deleteEmployee = (id) => {
            const pin = prompt("กรุณาใส่รหัส Admin เพื่อยืนยันการลบพนักงาน:");
            if (pin === ADMIN_PIN) {
                if (confirm("ยืนยันการลบพนักงานคนนี้และประวัติทั้งหมด?")) {
                    appData.employees = appData.employees.filter(e => e.id != id);
                    appData.history = appData.history.filter(h => h.empId != id);
                    saveData();
                    showToast("ลบพนักงานเรียบร้อยแล้ว");
                    renderAdminView();
                    renderAdminAllEmployees();
                }
            } else if (pin !== null) {
                alert("รหัสผ่านไม่ถูกต้อง! ไม่สามารถลบพนักงานได้");
            }
        };

        window.deleteBulkEmployees = function () {
            const boxes = document.getElementsByName('allEmpSelect');
            const ids = [];
            boxes.forEach(b => { if (b.checked) ids.push(parseInt(b.value)); });

            if (ids.length === 0) { showToast("กรุณาเลือกพนักงาน"); return; }

            const pin = prompt(`ยืนยันการลบพนักงาน ${ids.length} คน? กรุณาใส่รหัส Admin:`);
            if (pin !== ADMIN_PIN) {
                if (pin !== null) alert("รหัสผ่านไม่ถูกต้อง");
                return;
            }

            appData.employees = appData.employees.filter(e => !ids.includes(e.id));
            appData.history = appData.history.filter(h => !ids.includes(h.empId));
            saveData();
            renderAdminView();
            renderAdminAllEmployees();
            showToast("ลบพนักงานที่เลือกเรียบร้อย");
        };

        window.toggleSelectAllYard = (s) => { const b = document.getElementsByName('yardSelect'); b.forEach(x => x.checked = s.checked); };
        window.updateLeaveInfo = () => { const id = document.getElementById('leaveType').value; const r = appData.leaveRules[id]; if (r) document.getElementById('leaveInfoText').innerText = `${r.note} (หัก ${r.deduction} คะแนน)`; };
        window.resetSystem = () => { if (prompt("รหัส Admin:") === ADMIN_PIN && confirm("ล้างข้อมูล?")) { appData.employees = []; appData.history = []; saveData(); location.reload(); } };



        // --- NEW: Announcement Logic ---
        window.postAnnouncement = function () {
            const text = document.getElementById('mgr-announcement-input').value.trim();
            if (!text) { showToast("กรุณาพิมพ์ข้อความประกาศ"); return; }

            appData.announcement = text;
            saveData();
            showToast("โพสต์ประกาศเรียบร้อยแล้ว");
        };

        window.deleteAnnouncement = function () {
            if (confirm("ลบประกาศปัจจุบัน?")) {
                appData.announcement = "";
                document.getElementById('mgr-announcement-input').value = "";
                saveData();
                showToast("ลบประกาศเรียบร้อย");
            }
        };

        let rankingMode = 'top'; // 'top' or 'low'

        window.setRankingMode = function (mode) {
            rankingMode = mode;
            document.getElementById('btn-rank-top').className = `px-3 py-1 text-[10px] rounded-md font-bold transition ${mode === 'top' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`;
            document.getElementById('btn-rank-low').className = `px-3 py-1 text-[10px] rounded-md font-bold transition ${mode === 'low' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`;
            renderRankingList();
        };

        window.renderRankingList = function () {
            const ranking = document.getElementById('mgr-emp-ranking');
            ranking.innerHTML = '';

            const sortedEmps = [...appData.employees].sort((a, b) => {
                return rankingMode === 'top' ? b.score - a.score : a.score - b.score;
            }).slice(0, 10); // Top 10

            sortedEmps.forEach((e, i) => {
                let scoreColor = "text-slate-800";
                if (e.score >= 28) scoreColor = "text-yellow-500";
                else if (e.score < 15) scoreColor = "text-red-500";

                let rankIcon = "";
                let rankStyle = "bg-white border-slate-100";

                if (i === 0) {
                    rankStyle = "bg-gradient-to-r from-yellow-50 to-white border-yellow-200 shadow-sm";
                    rankIcon = `<div class="w-6 h-6 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-xs shadow-sm"><i class="fas fa-crown"></i></div>`;
                } else if (i === 1) {
                    rankIcon = `<div class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold">2</div>`;
                } else if (i === 2) {
                    rankIcon = `<div class="w-6 h-6 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center text-xs font-bold">3</div>`;
                } else {
                    rankIcon = `<div class="w-6 h-6 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center text-[10px] font-bold">${i + 1}</div>`;
                }

                if (rankingMode === 'low') {
                    // Highlight low performers differently
                    rankStyle = "bg-white border-red-50 hover:bg-red-50/30";
                    rankIcon = `<div class="w-6 h-6 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-[10px] font-black">${i + 1}</div>`;
                }

                ranking.innerHTML += `
                <div class="flex items-center justify-between p-3 rounded-2xl border ${rankStyle} hover:shadow-md transition cursor-pointer group mb-2" onclick="openManageHistory(${e.id})" title="ดูรายละเอียด">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0">
                            ${rankIcon}
                        </div>
                        <div>
                            <p class="font-bold text-sm text-slate-800 group-hover:text-blue-600 transition">${e.name}</p>
                            <p class="text-[10px] text-slate-400 flex items-center gap-1">
                                <i class="fas fa-map-marker-alt text-[9px]"></i> ${e.location}
                                ${e.position ? `<span class="bg-slate-100 px-1 rounded text-[9px] ml-1">${e.position}</span>` : ''}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-lg ${scoreColor} leading-none">${e.score}</div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase">คะแนน</div>
                    </div>
                </div>`;
            });
        };

        // --- FACE RECOGNITION MODAL FUNCTIONS ---
        window.openFaceModal = async function (type) {
            currentCheckType = type;
            const modal = document.getElementById('faceRecognitionModal');
            const title = document.getElementById('face-modal-title');
            const video = document.getElementById('faceVideo');

            // Update title based on type
            title.innerText = type === 'in' ? 'สแกนหน้าเข้างาน' : 'สแกนหน้าออกงาน';

            // Show modal
            modal.classList.remove('hidden');

            // Start camera
            try {
                faceStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });
                video.srcObject = faceStream;

                // Check GPS
                checkGPSLocation();
            } catch (error) {
                console.error('Camera error:', error);
                showToast('ไม่สามารถเปิดกล้องได้');
                closeFaceModal();
            }
        };

        window.closeFaceModal = function () {
            const modal = document.getElementById('faceRecognitionModal');
            const video = document.getElementById('faceVideo');

            // Stop camera
            if (faceStream) {
                faceStream.getTracks().forEach(track => track.stop());
                faceStream = null;
            }

            video.srcObject = null;
            modal.classList.add('hidden');
        };

        window.captureFace = async function () {
            const emp = appData.employees.find(e => e.id == appData.currentUserId);
            if (!emp) return;

            const video = document.getElementById('faceVideo');
            const canvas = document.getElementById('faceCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw current frame
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Get image data (optional: could save to localStorage or send to server)
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            // Show loading
            document.getElementById('capture-btn').classList.add('hidden');
            document.getElementById('face-loading').classList.remove('hidden');

            // Simulate processing (in real app, this would verify face)
            setTimeout(() => {
                // Process check-in/check-out
                if (currentCheckType === 'in') {
                    handleCheckIn();
                } else {
                    handleCheckOut();
                }

                // Close modal
                closeFaceModal();

                // Reset UI
                document.getElementById('capture-btn').classList.remove('hidden');
                document.getElementById('face-loading').classList.add('hidden');
            }, 1500);
        };

        function checkGPSLocation() {
            const statusEl = document.getElementById('gps-status');

            if (!navigator.geolocation) {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> ไม่รองรับ GPS';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    statusEl.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> ตำแหน่ง: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                },
                (error) => {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-orange-500"></i> ไม่สามารถตรวจสอบตำแหน่งได้';
                }
            );
        }

        function handleCheckIn() {
            const emp = appData.employees.find(e => e.id == appData.currentUserId);
            if (!emp) return;

            const today = getTodayStr();
            const existing = appData.history.find(h => h.empId == emp.id && h.date === today);

            if (existing) {
                showToast('คุณได้เช็คชื่อเข้างานวันนี้แล้ว');
                return;
            }

            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];

            // Get yard start time
            const yard = appData.locations.find(l => (typeof l === 'object' ? l.name : l) === emp.location);
            const startTime = yard ? (yard.startTime || "08:30") : "08:30";

            // Check if late
            const [startH, startM] = startTime.split(':').map(Number);
            const startDate = new Date(now);
            startDate.setHours(startH, startM, 0, 0);

            let status = 'Present';
            let deduction = 0;

            if (now > startDate) {
                // Late
                status = 'Late';
                const lateRule = appData.leaveRules['late'];
                deduction = lateRule ? lateRule.deduction : 1;
            }

            appData.history.push({
                id: Date.now(),
                empId: emp.id,
                date: today,
                timestamp: now.toISOString(),
                type: status,
                otHours: 0,
                reason: status === 'Late' ? 'เข้างานสาย' : 'เข้างานปกติ',
                status: status,
                deduction: deduction,
                checkInTime: timeStr,
                checkOutTime: null
            });

            saveData();
            updateUI();
            showToast(status === 'Late' ? '⚠️ เช็คชื่อเข้างานสำเร็จ (สาย)' : '✅ เช็คชื่อเข้างานสำเร็จ');
        }

        function handleCheckOut() {
            const emp = appData.employees.find(e => e.id == appData.currentUserId);
            if (!emp) return;

            const today = getTodayStr();
            const existing = appData.history.find(h => h.empId == emp.id && h.date === today);

            if (!existing) {
                showToast('กรุณาเช็คชื่อเข้างานก่อน');
                return;
            }

            if (existing.checkOutTime) {
                showToast('คุณได้เช็คชื่อออกงานวันนี้แล้ว');
                return;
            }

            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];

            // Update existing record
            existing.checkOutTime = timeStr;

            // Calculate OT if applicable
            const checkIn = new Date(existing.date + ' ' + existing.checkInTime);
            const checkOut = new Date(existing.date + ' ' + timeStr);
            const workHours = (checkOut - checkIn) / (1000 * 60 * 60);

            // Assume 8 hours regular, anything over is OT
            if (workHours > 8) {
                existing.otHours = Math.round((workHours - 8) * 10) / 10;
            }

            saveData();
            updateUI();
            showToast('✅ เช็คชื่อออกงานสำเร็จ' + (existing.otHours > 0 ? ` (OT: ${existing.otHours} ชม.)` : ''));
        }

        // ==================== GEOFENCE MANAGEMENT FUNCTIONS ====================

        let currentEditingGeofenceIndex = null; // Track which geofence is being edited
        let geofenceMap = null; // Leaflet map instance
        let geofenceMarker = null; // Marker on map
        let geofenceCircle = null; // Circle showing radius
        let currentEditingYard = null; // Track which yard is being edited for GPS setup


        window.openGeofenceModal = function () {
            openModal('manageGeofenceModal');
            currentEditingGeofenceIndex = null; // Reset editing mode
            clearGeofenceForm();
            populateYardSelector(); // Populate dropdown
            renderGeofenceList();

            // Initialize map after modal is visible
            setTimeout(() => {
                initGeofenceMap();
            }, 100);
        };

        function populateYardSelector() {
            const selector = document.getElementById('yardSelector');
            if (!selector) return;

            // Clear existing options except first
            selector.innerHTML = '<option value="">-- เลือกไซต์งานเพื่อแก้ไข หรือเพิ่มใหม่ --</option>';

            // Add all locations as options
            appData.locations.forEach((location, index) => {
                const option = document.createElement('option');
                option.value = index;
                const name = typeof location === 'object' ? location.name : location;
                const hasGPS = location.latitude ? ' ✓' : ' (ยังไม่มี GPS)';
                option.textContent = name + hasGPS;
                selector.appendChild(option);
            });
        }

        window.loadSelectedYard = function () {
            const selector = document.getElementById('yardSelector');
            const selectedIndex = selector.value;

            if (selectedIndex === '') {
                // Clear form if no selection
                clearGeofenceForm();
                return;
            }

            const index = parseInt(selectedIndex);
            const location = appData.locations[index];

            // Load data into form
            document.getElementById('newGeofenceName').value = location.name || '';
            document.getElementById('newGeofenceLat').value = location.latitude || '';
            document.getElementById('newGeofenceLng').value = location.longitude || '';
            document.getElementById('newGeofenceRadius').value = location.radius || 100;

            // Set editing mode
            currentEditingGeofenceIndex = index;

            // Update map
            updateGeofenceOnMap();

            // Change button text
            const btn = document.querySelector('#manageGeofenceModal button[onclick="addGeofence()"]');
            if (btn) btn.textContent = 'บันทึกการแก้ไข';

            showToast(`📍 โหลดข้อมูล "${location.name}" แล้ว`);
        };

        function clearGeofenceForm() {
            document.getElementById('newGeofenceName').value = '';
            document.getElementById('newGeofenceLat').value = '';
            document.getElementById('newGeofenceLng').value = '';
            document.getElementById('newGeofenceRadius').value = '100';

            // Reset yard selector
            const selector = document.getElementById('yardSelector');
            if (selector) selector.value = '';

            // Reset button text
            const btn = document.querySelector('#manageGeofenceModal button[onclick="addGeofence()"]');
            if (btn) btn.textContent = 'เพิ่มพื้นที่';
        }

        function renderGeofenceList() {
            const tbody = document.getElementById('geofenceTableBody');
            tbody.innerHTML = '';

            if (!appData.locations || appData.locations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">ยังไม่มีพื้นที่ทำงาน</td></tr>`;
                return;
            }

            appData.locations.forEach((location, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition';

                const lat = location.latitude || '-';
                const lng = location.longitude || '-';
                const radius = location.radius || '-';

                row.innerHTML = `
                    <td class="p-2 font-bold text-slate-700">${location.name || '-'}</td>
                    <td class="p-2 text-center text-xs text-slate-600">${lat}, ${lng}</td>
                    <td class="p-2 text-center text-slate-600">${radius}</td>
                    <td class="p-2 text-right space-x-1">
                        <button onclick="editGeofence(${index})" 
                            class="text-blue-500 hover:text-blue-700 px-2 py-1 rounded transition"
                            title="แก้ไขพื้นที่">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteGeofence(${index})" 
                            class="text-red-500 hover:text-red-700 px-2 py-1 rounded transition"
                            title="ลบพื้นที่">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.editGeofence = function (index) {
            const location = appData.locations[index];

            // Fill form with existing data
            document.getElementById('newGeofenceName').value = location.name || '';
            document.getElementById('newGeofenceLat').value = location.latitude || '';
            document.getElementById('newGeofenceLng').value = location.longitude || '';
            document.getElementById('newGeofenceRadius').value = location.radius || 100;

            // Set editing mode
            currentEditingGeofenceIndex = index;

            // Update map with location data
            updateGeofenceOnMap();

            // Change button text
            const btn = document.querySelector('#manageGeofenceModal button[onclick="addGeofence()"]');
            if (btn) btn.textContent = 'บันทึกการแก้ไข';

            // Scroll to form
            document.getElementById('newGeofenceName').focus();

            showToast('✏️ กำลังแก้ไขพื้นที่');
        };

        window.addGeofence = function () {
            const name = document.getElementById('newGeofenceName').value.trim();
            const lat = parseFloat(document.getElementById('newGeofenceLat').value);
            const lng = parseFloat(document.getElementById('newGeofenceLng').value);
            const radius = parseInt(document.getElementById('newGeofenceRadius').value);

            if (!name) {
                showToast('⚠️ กรุณาใส่ชื่อพื้นที่');
                return;
            }

            if (isNaN(lat) || isNaN(lng)) {
                showToast('⚠️ กรุณาใส่พิกัด GPS ที่ถูกต้อง');
                return;
            }

            if (isNaN(radius) || radius <= 0) {
                showToast('⚠️ กรุณาใส่รัศมีที่ถูกต้อง');
                return;
            }

            // Check if we're in edit mode
            if (currentEditingGeofenceIndex !== null) {
                // Edit existing location
                appData.locations[currentEditingGeofenceIndex] = {
                    name: name,
                    latitude: lat,
                    longitude: lng,
                    radius: radius,
                    startTime: appData.locations[currentEditingGeofenceIndex].startTime || "08:30"
                };
                showToast('✅ แก้ไขพื้นที่สำเร็จ');
                currentEditingGeofenceIndex = null; // Reset edit mode
            } else {
                // Check if location name already exists (for new additions)
                const existingIndex = appData.locations.findIndex(loc =>
                    (typeof loc === 'object' ? loc.name : loc) === name
                );

                if (existingIndex !== -1) {
                    // Update existing location with GPS data
                    appData.locations[existingIndex] = {
                        name: name,
                        latitude: lat,
                        longitude: lng,
                        radius: radius,
                        startTime: appData.locations[existingIndex].startTime || "08:30"
                    };
                    showToast('✅ อัพเดตพื้นที่สำเร็จ');
                } else {
                    // Add new location
                    appData.locations.push({
                        name: name,
                        latitude: lat,
                        longitude: lng,
                        radius: radius,
                        startTime: "08:30"
                    });
                    showToast('✅ เพิ่มพื้นที่สำเร็จ');
                }
            }

            // Clear form
            clearGeofenceForm();

            saveData();
            renderGeofenceList();
            updateUI(); // Update location selectors
        };

        window.deleteGeofence = function (index) {
            if (!confirm(`ต้องการลบพื้นที่ "${appData.locations[index].name}" หรือไม่?`)) {
                return;
            }

            appData.locations.splice(index, 1);
            saveData();
            renderGeofenceList();
            updateUI();
            showToast('🗑️ ลบพื้นที่สำเร็จ');
        };

        window.getCurrentLocation = function () {
            if (!navigator.geolocation) {
                showToast('⚠️ เบราว์เซอร์ไม่รองรับ GPS');
                return;
            }

            showToast('📍 กำลังค้นหาตำแหน่ง...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('newGeofenceLat').value = position.coords.latitude.toFixed(6);
                    document.getElementById('newGeofenceLng').value = position.coords.longitude.toFixed(6);
                    updateGeofenceOnMap();
                    showToast('✅ ได้รับตำแหน่งแล้ว');
                },
                (error) => {
                    showToast('⚠️ ไม่สามารถค้นหาตำแหน่งได้');
                    console.error('Geolocation error:', error);
                }
            );
        };

        function updateGeofenceOnMap() {
            if (!geofenceMap) return;

            const lat = parseFloat(document.getElementById('newGeofenceLat').value);
            const lng = parseFloat(document.getElementById('newGeofenceLng').value);
            const radius = parseInt(document.getElementById('newGeofenceRadius').value) || 100;

            if (isNaN(lat) || isNaN(lng)) return;

            // Remove existing marker and circle
            if (geofenceMarker) {
                geofenceMap.removeLayer(geofenceMarker);
            }
            if (geofenceCircle) {
                geofenceMap.removeLayer(geofenceCircle);
            }

            // Add new marker
            geofenceMarker = L.marker([lat, lng], {
                draggable: true
            }).addTo(geofenceMap);

            // Add circle for radius
            geofenceCircle = L.circle([lat, lng], {
                radius: radius,
                color: '#14b8a6',
                fillColor: '#14b8a6',
                fillOpacity: 0.2
            }).addTo(geofenceMap);

            // Center map on marker
            geofenceMap.setView([lat, lng], 15);

            // Handle marker drag
            geofenceMarker.on('dragend', function (e) {
                const newLat = e.target.getLatLng().lat;
                const newLng = e.target.getLatLng().lng;

                document.getElementById('newGeofenceLat').value = newLat.toFixed(6);
                document.getElementById('newGeofenceLng').value = newLng.toFixed(6);

                updateGeofenceOnMap();
            });
        }

        // Update map when radius changes
        document.addEventListener('DOMContentLoaded', function () {
            const radiusInput = document.getElementById('newGeofenceRadius');
            if (radiusInput) {
                radiusInput.addEventListener('input', updateGeofenceOnMap);
            }
        });

        // Helper function to check if user is within geofence
        function isWithinGeofence(userLat, userLng, location) {
            if (!location.latitude || !location.longitude || !location.radius) {
                return true; // If no geofence data, allow check-in
            }

            // Haversine formula to calculate distance
            const R = 6371e3; // Earth radius in meters
            const φ1 = userLat * Math.PI / 180;
            const φ2 = location.latitude * Math.PI / 180;
            const Δφ = (location.latitude - userLat) * Math.PI / 180;
            const Δλ = (location.longitude - userLng) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // Distance in meters

            return distance <= location.radius;
        }


        // ==================== GEOFENCE MANAGEMENT ====================

        window.openGeofenceModal = function (yardName) {
            currentEditingYard = yardName;
            document.getElementById('geofence-yard-name').innerText = yardName;
            openModal('geofenceModal');

            // Find existing geofence for this yard
            const existing = appData.geofences?.find(g => g.name === yardName);

            // Set form values
            document.getElementById('geofence-lat').value = existing?.lat || '';
            document.getElementById('geofence-lng').value = existing?.lng || '';
            document.getElementById('geofence-radius').value = existing?.radius || 100;

            // Initialize map after modal opens
            setTimeout(() => initGeofenceMap(), 300);
        };

        function initGeofenceMap() {
            const mapContainer = document.getElementById('geofence-map');
            if (!mapContainer) {
                console.error('geofence-map container not found!');
                return;
            }

            mapContainer.innerHTML = ''; // Clear loading

            const lat = parseFloat(document.getElementById('geofence-lat').value) || 13.7563;
            const lng = parseFloat(document.getElementById('geofence-lng').value) || 100.5018;

            console.log('🗺️ Initializing Geofence Map:', { lat, lng });

            try {
                // Remove existing map if any
                if (geofenceMap) {
                    geofenceMap.remove();
                    geofenceMap = null;
                }

                // Initialize map
                geofenceMap = L.map('geofence-map').setView([lat, lng], 13);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(geofenceMap);

                // Force map to recalculate size after it's added
                setTimeout(() => {
                    if (geofenceMap) {
                        geofenceMap.invalidateSize();
                    }
                }, 100);

                // Update marker and circle
                updateGeofenceMapMarker(lat, lng);

                // Click event to set location
                geofenceMap.on('click', function (e) {
                    document.getElementById('geofence-lat').value = e.latlng.lat.toFixed(6);
                    document.getElementById('geofence-lng').value = e.latlng.lng.toFixed(6);
                    updateGeofenceMapMarker(e.latlng.lat, e.latlng.lng);
                });

                // Input change events
                document.getElementById('geofence-lat').addEventListener('input', updateMapFromInputs);
                document.getElementById('geofence-lng').addEventListener('input', updateMapFromInputs);
                document.getElementById('geofence-radius').addEventListener('input', updateMapFromInputs);

                console.log('✅ Geofence Map initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing geofence map:', error);
            }
        }

        function updateMapFromInputs() {
            const lat = parseFloat(document.getElementById('geofence-lat').value);
            const lng = parseFloat(document.getElementById('geofence-lng').value);

            if (!isNaN(lat) && !isNaN(lng)) {
                updateGeofenceMapMarker(lat, lng);
                geofenceMap.setView([lat, lng], geofenceMap.getZoom());
            }
        }

        function updateGeofenceMapMarker(lat, lng) {
            // Remove old marker and circle
            if (geofenceMarker) geofenceMap.removeLayer(geofenceMarker);
            if (geofenceCircle) geofenceMap.removeLayer(geofenceCircle);

            const radius = parseFloat(document.getElementById('geofence-radius').value) || 100;

            // Add new marker
            geofenceMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div class="pulse-marker" style="background-color: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(geofenceMap);

            geofenceMarker.bindPopup(`<b>${currentEditingYard}</b><br>ละติจูด: ${lat.toFixed(6)}<br>ลองจิจูด: ${lng.toFixed(6)}<br>รัศมี: ${radius} ม.`).openPopup();

            // Add red boundary circle
            geofenceCircle = L.circle([lat, lng], {
                color: '#ef4444',
                fillColor: '#fca5a5',
                fillOpacity: 0.2,
                radius: radius,
                weight: 3
            }).addTo(geofenceMap);
        }

        window.useCurrentLocation = function () {
            if (!navigator.geolocation) {
                showToast('❌ เบราว์เซอร์ไม่รองรับ GPS');
                return;
            }

            showToast('📍 กำลังตรวจสอบตำแหน่ง...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    document.getElementById('geofence-lat').value = lat.toFixed(6);
                    document.getElementById('geofence-lng').value = lng.toFixed(6);

                    updateGeofenceMapMarker(lat, lng);
                    geofenceMap.setView([lat, lng], 15);

                    showToast('✅ ตั้งค่าตำแหน่งปัจจุบันเรียบร้อย');
                },
                (error) => {
                    showToast('❌ ไม่สามารถเข้าถึง GPS ได้');
                    console.error('Geolocation error:', error);
                }
            );
        };

        window.saveGeofence = async function () {
            const lat = parseFloat(document.getElementById('geofence-lat').value);
            const lng = parseFloat(document.getElementById('geofence-lng').value);
            const radius = parseFloat(document.getElementById('geofence-radius').value);

            if (!lat || !lng || !radius) {
                showToast('❌ กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            // Initialize geofences array if not exists
            if (!appData.geofences) {
                appData.geofences = [];
            }

            // Find if geofence already exists for this yard
            const existingIndex = appData.geofences.findIndex(g => g.name === currentEditingYard);

            const geofenceData = {
                name: currentEditingYard,
                lat: lat,
                lng: lng,
                radius: radius
            };

            if (existingIndex >= 0) {
                appData.geofences[existingIndex] = geofenceData;
            } else {
                appData.geofences.push(geofenceData);
            }

            console.log('💾 Saving geofence:', geofenceData);

            // Save to database
            await saveData();

            showToast('✅ บันทึก Geofence เรียบร้อย');
            closeModal('geofenceModal');

            // Refresh yards table
            renderYardsTable();
        };

        function renderYardsTable() {
            const tbody = document.getElementById('yardsTableBody');
            if (!tbody) {
                console.warn('yardsTableBody element not found');
                return;
            }

            // Initialize locations if not exists
            if (!appData.locations) {
                appData.locations = [];
            }

            tbody.innerHTML = '';

            // Show empty message if no locations
            if (appData.locations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">ยังไม่มีพื้นที่ทำงาน กรุณาเพิ่มพื้นที่ใหม่</td></tr>';
                return;
            }

            appData.locations.forEach(loc => {
                const geofence = appData.geofences?.find(g => g.name === loc.name);
                const hasGPS = geofence && geofence.lat && geofence.lng && geofence.radius;

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                row.innerHTML = `
                   <td class="p-2 font-bold text-slate-800">${loc.name}</td>
                    <td class="p-2 text-center text-slate-600 font-bold">${loc.startTime}</td>
                    <td class="p-2 text-center">
                        ${hasGPS
                        ? '<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded"><i class="fas fa-check-circle mr-1"></i>ตั้งค่าแล้ว</span>'
                        : '<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded"><i class="fas fa-times-circle mr-1"></i>ยังไม่ตั้งค่า</span>'
                    }
                    </td>
                    <td class="p-2 text-right">
                        <button onclick="openGeofenceModal('${loc.name}')" 
                            class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded hover:bg-blue-200">
                            <i class="fas fa-map-marker-alt mr-1"></i>${hasGPS ? 'แก้ไข' : 'ตั้งค่า'} GPS
                        </button>
                        <button onclick="deleteYard('${loc.name}')" 
                            class="bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded hover:bg-red-200 ml-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.deleteYard = async function (yardName) {
            if (!confirm(`ลบสถานที่ "${yardName}" หรือไม่?`)) return;

            // Remove from locations
            appData.locations = appData.locations.filter(l => l.name !== yardName);

            // Remove geofence if exists
            if (appData.geofences) {
                appData.geofences = appData.geofences.filter(g => g.name !== yardName);
            }

            await saveData();
            showToast('✅ ลบสถานที่เรียบร้อย');
            renderYardsTable();
        };

        window.addYard = async function () {
            const name = document.getElementById('newYardName').value.trim();
            const time = document.getElementById('newYardTime').value;

            if (!name) {
                showToast('❌ กรุณากรอกชื่อสถานที่');
                return;
            }

            if (appData.locations.some(l => l.name === name)) {
                showToast('❌ มีสถานที่นี้อยู่แล้ว');
                return;
            }

            appData.locations.push({ name, startTime: time });
            await saveData();

            document.getElementById('newYardName').value = '';
            document.getElementById('newYardTime').value = '08:30';

            showToast('✅ เพิ่มสถานที่เรียบร้อย');
            renderYardsTable();
        };

        window.openManageYardsModal = function () {
            renderYardsTable();
            openModal('manageYardsModal');
        };

        // ========================================================================
        // FACE RECOGNITION SYSTEM
        // ========================================================================

        let faceModelsLoaded = false;
        let faceStream = null;
        let faceDetectionInterval = null;
        let currentFaceMode = null; // 'register' or 'verify'
        let currentCheckType = null; // 'in' or 'out'
        let livenessSteps = [];
        let currentLivenessStep = 0;
        let faceDescriptors = [];
        let lastBlinkTime = 0;
        let blinkDetected = false;

        // Load Face-API Models
        async function loadFaceModels() {
            if (faceModelsLoaded) return true;

            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';

                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                faceModelsLoaded = true;
                console.log('✅ Face models loaded successfully');
                return true;
            } catch (error) {
                console.error('❌ Error loading face models:', error); showToast('❌ ไม่สามารถโหลดโมเดล AI ได้');
                return false;
            }
        }

        // NEW: Missing function - Check Location and Open Face Modal
        async function checkLocationAndOpenFaceModal(checkType) {
            console.log('=== checkLocationAndOpenFaceModal START ===');
            console.log('Check type:', checkType);

            currentCheckType = checkType;

            // GPS is already checked automatically on page load by autoCheckEmployeeLocation()
            // So we can skip the GPS check here and go directly to face scan
            console.log('Skipping GPS check (already verified on page load)');

            // Load face models first
            const modelsLoaded = await loadFaceModels();
            if (!modelsLoaded) {
                showToast('❌ ไม่สามารถเริ่มระบบสแกนใบหน้าได้');
                return;
            }

            // Get employee and check if face is registered
            const employee = appData.employees.find(e => e.id === appData.currentUserId);
            if (!employee) {
                showToast('❌ ไม่พบข้อมูลพนักงาน');
                return;
            }

            if (employee.faceRegistered) {
                console.log('Opening face VERIFICATION modal');
                currentFaceMode = 'verify';
                await openFaceScanModal('verify');
            } else {
                console.log('Opening face REGISTRATION modal');
                currentFaceMode = 'register';
                await openFaceScanModal('register');
            }

            console.log('=== checkLocationAndOpenFaceModal END ===');
        }

        // Make it available globally
        window.checkLocationAndOpenFaceModal = checkLocationAndOpenFaceModal;


        async function openFaceScanModal(mode) {
            const modal = document.getElementById('faceScanModal');
            const title = document.getElementById('faceScanTitle');
            const modeIndicator = document.getElementById('faceModeIndicator');

            if (mode === 'register') {
                title.textContent = 'ลงทะเบียนใบหน้าครั้งแรก';
                modeIndicator.innerHTML = `
                    <div class="bg-green-100 border-2 border-green-300 rounded-xl p-3 flex items-center gap-3">
                        <i class="fas fa-user-plus text-green-600 text-2xl"></i>
                        <div>
                            <p class="font-black text-green-900">โหมดลงทะเบียน</p>
                            <p class="text-xs text-green-700">บันทึกใบหน้าของคุณเข้าระบบ</p>
                        </div>
                    </div>
                `;
            } else {
                title.textContent = 'ยืนยันตัวตนด้วยใบหน้า';
                modeIndicator.innerHTML = `
                    <div class="bg-blue-100 border-2 border-blue-300 rounded-xl p-3 flex items-center gap-3">
                        <i class="fas fa-shield-alt text-blue-600 text-2xl"></i>
                        <div>
                            <p class="font-black text-blue-900">โหมดยืนยันตัวตน</p>
                            <p class="text-xs text-blue-700">เปรียบเทียบกับข้อมูลที่บันทึกไว้</p>
                        </div>
                    </div>
                `;
            }

            modal.classList.remove('hidden');
            await startWebcam();
            startFaceDetection();
        }

        function closeFaceScanModal() {
            const modal = document.getElementById('faceScanModal');
            modal.classList.add('hidden');
            stopWebcam();
            stopFaceDetection();
            resetFaceScanState();
        }

        async function startWebcam() {
            try {
                faceStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    }
                });

                const video = document.getElementById('faceVideo');
                video.srcObject = faceStream;

                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('❌ Webcam error:', error);
                showToast('❌ ไม่สามารถเข้าถึงกล้องได้');
                closeFaceScanModal();
            }
        }

        function stopWebcam() {
            if (faceStream) {
                faceStream.getTracks().forEach(track => track.stop());
                faceStream = null;
            }
        }

        function startFaceDetection() {
            const video = document.getElementById('faceVideo');
            const canvas = document.getElementById('faceCanvas');

            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            // Random liveness steps
            if (currentFaceMode === 'register') {
                livenessSteps = ['blink', 'smile'];
            } else {
                livenessSteps = ['blink'];
            }
            currentLivenessStep = 0;
            faceDescriptors = [];

            faceDetectionInterval = setInterval(async () => {
                await detectFace();
            }, 100);
        }

        function stopFaceDetection() {
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }
        }

        async function detectFace() {
            const video = document.getElementById('faceVideo');
            const canvas = document.getElementById('faceCanvas');
            const ctx = canvas.getContext('2d');

            const detections = await faceapi
                .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (detections) {
                // Draw detection box
                const displaySize = { width: canvas.width, height: canvas.height };
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // Draw green box around face
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                const box = resizedDetections.detection.box;
                ctx.strokeRect(box.x, box.y, box.width, box.height);

                updateFaceDetectionStatus('detected');

                // Run liveness checks
                if (currentFaceMode === 'register') {
                    await handleRegistrationFlow(detections);
                } else {
                    await handleVerificationFlow(detections);
                }
            } else {
                updateFaceDetectionStatus('searching');
            }
        }

        function updateFaceDetectionStatus(status) {
            const dot = document.getElementById('faceDetectionDot');
            const text = document.getElementById('faceDetectionText');

            if (status === 'detected') {
                dot.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
                text.textContent = 'ตรวจพบใบหน้าแล้ว';
            } else {
                dot.className = 'w-3 h-3 rounded-full bg-yellow-400 animate-pulse';
                text.textContent = 'กำลังตรวจจับใบหน้า...';
            }
        }

        async function handleRegistrationFlow(detections) {
            const currentStep = livenessSteps[currentLivenessStep];

            if (currentStep === 'blink') {
                const blinkResult = await checkBlink(detections.landmarks);
                if (blinkResult && !blinkDetected) {
                    blinkDetected = true;
                    showLivenessPrompt('smile');
                    currentLivenessStep++;
                    updateProgress(50);
                } else if (!blinkResult) {
                    showLivenessPrompt('blink');
                }
            } else if (currentStep === 'smile') {
                // Collect face descriptor
                if (faceDescriptors.length < 3) {
                    faceDescriptors.push(detections.descriptor);
                    updateProgress(50 + (faceDescriptors.length * 16));

                    if (faceDescriptors.length >= 3) {
                        await completeFaceRegistration();
                    }
                }
            }
        }

        async function handleVerificationFlow(detections) {
            const currentStep = livenessSteps[currentLivenessStep];

            if (currentStep === 'blink') {
                const blinkResult = await checkBlink(detections.landmarks);
                if (blinkResult && !blinkDetected) {
                    blinkDetected = true;
                    currentLivenessStep++;
                    updateProgress(50);

                    // Proceed to verification
                    await verifyFace(detections.descriptor);
                } else if (!blinkResult) {
                    showLivenessPrompt('blink');
                }
            }
        }

        async function checkBlink(landmarks) {
            // Simple blink detection using eye aspect ratio
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();

            const leftEAR = calculateEAR(leftEye);
            const rightEAR = calculateEAR(rightEye);
            const avgEAR = (leftEAR + rightEAR) / 2;

            // EAR threshold for blink detection
            const EAR_THRESHOLD = 0.21;

            if (avgEAR < EAR_THRESHOLD) {
                lastBlinkTime = Date.now();
                return true;
            }

            return false;
        }

        function calculateEAR(eye) {
            // Eye Aspect Ratio calculation
            const vertical1 = distance(eye[1], eye[5]);
            const vertical2 = distance(eye[2], eye[4]);
            const horizontal = distance(eye[0], eye[3]);

            return (vertical1 + vertical2) / (2.0 * horizontal);
        }

        function distance(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        function showLivenessPrompt(action) {
            const prompt = document.getElementById('livenessPrompt');
            const text = document.getElementById('livenessText');

            if (action === 'blink') {
                text.innerHTML = '<i class="fas fa-eye text-3xl mb-2"></i><br>กรุณากระพริบตา';
                prompt.classList.remove('hidden');
            } else if (action === 'smile') {
                text.innerHTML = '<i class="fas fa-smile text-3xl mb-2"></i><br>ยิ้มให้กล้อง';
                prompt.classList.remove('hidden');
            } else {
                prompt.classList.add('hidden');
            }
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('faceProgress');
            progressBar.style.width = percent + '%';
        }

        async function completeFaceRegistration() {
            stopFaceDetection();
            updateProgress(100);

            // Calculate average descriptor
            const avgDescriptor = averageDescriptors(faceDescriptors);

            // Save to employee data
            const employee = appData.employees.find(e => e.id === appData.currentUserId);
            if (employee) {
                employee.faceDescriptor = Array.from(avgDescriptor);
                employee.faceRegistered = true;
                employee.faceRegisteredAt = new Date().toISOString();

                await saveData();

                showFaceSuccess('✅ ลงทะเบียนใบหน้าสำเร็จ!');

                setTimeout(() => {
                    closeFaceScanModal();
                    // Proceed with check-in
                    proceedWithCheckIn();
                }, 2000);
            }
        }

        async function verifyFace(descriptor) {
            stopFaceDetection();

            const employee = appData.employees.find(e => e.id === appData.currentUserId);
            if (!employee || !employee.faceDescriptor) {
                showFaceError('❌ ไม่พบข้อมูลใบหน้าที่ลงทะเบียน');
                return;
            }

            const storedDescriptor = new Float32Array(employee.faceDescriptor);
            const distance = faceapi.euclideanDistance(descriptor, storedDescriptor);

            // Threshold: distance < 0.6 = Match
            const MATCH_THRESHOLD = 0.6;

            updateProgress(100);

            if (distance < MATCH_THRESHOLD) {
                showFaceSuccess('✅ ยืนยันตัวตนสำเร็จ!');

                setTimeout(() => {
                    closeFaceScanModal();
                    proceedWithCheckIn();
                }, 2000);
            } else {
                showFaceError('❌ ไม่สามารถยืนยันตัวตนได้<br>กรุณาลองใหม่อีกครั้ง');
                document.getElementById('retryFaceButton').classList.remove('hidden');
            }
        }

        function averageDescriptors(descriptors) {
            const avg = new Float32Array(128);
            for (let i = 0; i < 128; i++) {
                let sum = 0;
                for (const desc of descriptors) {
                    sum += desc[i];
                }
                avg[i] = sum / descriptors.length;
            }
            return avg;
        }

        function showFaceSuccess(message) {
            const statusMsg = document.getElementById('faceStatusMessage');
            statusMsg.innerHTML = `<div class="bg-green-100 text-green-800 px-4 py-3 rounded-xl">${message}</div>`;
        }

        function showFaceError(message) {
            const statusMsg = document.getElementById('faceStatusMessage');
            statusMsg.innerHTML = `<div class="bg-red-100 text-red-800 px-4 py-3 rounded-xl">${message}</div>`;
        }

        function retryFaceScan() {
            resetFaceScanState();
            startFaceDetection();
            document.getElementById('retryFaceButton').classList.add('hidden');
            document.getElementById('faceStatusMessage').innerHTML = '';
        }

        function resetFaceScanState() {
            currentLivenessStep = 0;
            faceDescriptors = [];
            blinkDetected = false;
            updateProgress(0);
            document.getElementById('livenessPrompt').classList.add('hidden');
        }

        async function proceedWithCheckIn() {
            // After face scan success, proceed with check-in/out
            console.log('proceedWithCheckIn called, type:', currentCheckType);

            const employee = appData.employees.find(e => e.id === appData.currentUserId);
            if (!employee) {
                showToast('❌ ไม่พบข้อมูลพนักงาน');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];

            // Get current location (GPS already checked earlier)
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 60000 // Allow cached location up to 1 minute
                    });
                });

                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);

                if (currentCheckType === 'in') {
                    // Check-in
                    let record = appData.attendance.find(r => r.employeeId === employee.id && r.date === today);
                    if (!record) {
                        record = {
                            employeeId: employee.id,
                            date: today,
                            checkIn: time,
                            checkInLocation: `${lat},${lng}`,
                            status: 'มาทำงาน'
                        };
                        appData.attendance.push(record);
                    } else {
                        record.checkIn = time;
                        record.checkInLocation = `${lat},${lng}`;
                        record.status = 'มาทำงาน';
                    }

                    await saveData();
                    showToast(`✅ บันทึกเวลาเข้างานสำเร็จ\n${time}`);

                } else if (currentCheckType === 'out') {
                    // Check-out
                    let record = appData.attendance.find(r => r.employeeId === employee.id && r.date === today);
                    if (!record) {
                        showToast('⚠️ กรุณาบันทึกเวลาเข้างานก่อน');
                        return;
                    }

                    record.checkOut = time;
                    record.checkOutLocation = `${lat},${lng}`;

                    await saveData();
                    showToast(`✅ บันทึกเวลาออกงานสำเร็จ\n${time}`);
                }

                // Refresh employee view
                setTimeout(() => {
                    if (appData.currentRole === 'employee') {
                        renderEmployeeView();
                    }
                }, 1000);

            } catch (error) {
                console.error('Error getting location for check-in:', error);
                // Still proceed with check-in even if GPS fails at this point
                // (since it was already checked earlier)
                if (currentCheckType === 'in') {
                    let record = appData.attendance.find(r => r.employeeId === employee.id && r.date === today);
                    if (!record) {
                        record = {
                            employeeId: employee.id,
                            date: today,
                            checkIn: time,
                            status: 'มาทำงาน'
                        };
                        appData.attendance.push(record);
                    } else {
                        record.checkIn = time;
                        record.status = 'มาทำงาน';
                    }
                    await saveData();
                    showToast(`✅ บันทึกเวลาเข้างานสำเร็จ\n${time}`);
                } else {
                    let record = appData.attendance.find(r => r.employeeId === employee.id && r.date === today);
                    if (record) {
                        record.checkOut = time;
                        await saveData();
                        showToast(`✅ บันทึกเวลาออกงานสำเร็จ\n${time}`);
                    }
                }

                setTimeout(() => {
                    if (appData.currentRole === 'employee') {
                        renderEmployeeView();
                    }
                }, 1000);
            }
        }

        // ========================================================================

        // Initialize App
        init();

        // Auto-check GPS location for employees immediately on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Wait a bit for the UI to render first
            setTimeout(() => {
                const empLocationDisplay = document.getElementById('emp-location-display');
                if (empLocationDisplay && empLocationDisplay.style.display !== 'none') {
                    console.log('🚀 Triggering immediate GPS check for employee...');
                    autoCheckEmployeeLocation();
                }
            }, 100); // Reduced from 1000ms to 100ms for faster response
        });
    </script>
</body>

</html>